<!DOCTYPE html><html><head>
      <title>write-your-own-lua-vm-compiler-and-standard-library-reading-notes</title>
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css">
      
      

      
      
      
      
      
      
      

      <style>
      /**
 * VS theme by Andrew Lock (https://andrewlock.net)
 * Inspired by Visual Studio syntax coloring
 */

code[class*="language-"],
pre[class*="language-"] {
    color: #000000;
    font-family: "Consolas", monospace;
    direction: ltr;
    text-align: left;
    white-space: pre;
    word-spacing: normal;
    word-break: normal;
    font-size: 12px;
    -moz-tab-size: 4;
    -o-tab-size: 4;
    tab-size: 4;
    -webkit-hyphens: none;
    -moz-hyphens: none;
    -ms-hyphens: none;
    hyphens: none;
}

pre[class*="language-"]::-moz-selection,
pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection,
code[class*="language-"] ::-moz-selection {
    background: #C1DEF1;
}

pre[class*="language-"]::selection,
pre[class*="language-"] ::selection,
code[class*="language-"]::selection,
code[class*="language-"] ::selection {
    background: #C1DEF1;
}


/* Code blocks */

pre[class*="language-"] {
    padding: 1em;
    margin: .5em 0;
    overflow: auto;
    background-color: #f9f9f9;
}


/* Inline code */

:not(pre)>code[class*="language-"] {
    padding: .2em;
    padding-top: 1px;
    padding-bottom: 1px;
    background: #EEE;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
    color: #0066FF;
    font-style: italic;
}

.token.namespace {
    opacity: .7;
}

.token.string {
    color: #036A07;
}

.token.punctuation {
    color: #000000;
}

.token.operator {
    color: #0066FF;
    font-weight: 900;
    /* no highlight */
}

.token.url,
.token.symbol,
.token.number,
.token.boolean,
.token.variable,
.token.constant,
.token.inserted {
    color: #0000CD;
}

.token.atrule,
.token.keyword,
.token.attr-value,
.language-autohotkey .token.selector,
.language-json .token.boolean,
.language-json .token.number,
code[class*="language-css"] {
    color: #0000ff;
    font-weight: 900;
}

.token.function {
    color: #000000;
}

.token.deleted,
.language-autohotkey .token.tag {
    color: #9a050f;
}

.token.selector,
.language-autohotkey .token.keyword {
    color: #00009f;
}

.token.important,
.token.bold {
    font-weight: bold;
}

.token.italic {
    font-style: italic;
}

.token.class-name,
.language-json .token.property {
    color: #2B91AF;
}

.token.tag,
.token.selector {
    color: #800000;
}

.token.attr-name,
.token.property,
.token.regex,
.token.entity {
    color: #19921c;
}

.token.directive.tag .tag {
    background: #ffff00;
    color: #000000;
}


/* overrides color-values for the Line Numbers plugin
 * http://prismjs.com/plugins/line-numbers/
 */

.line-numbers .line-numbers-rows {
    border-right-color: #a5a5a5;
}

.line-numbers-rows>span:before {
    color: #2B91AF;
}


/* overrides color-values for the Line Highlight plugin
* http://prismjs.com/plugins/line-highlight/
*/

.line-highlight {
    background: rgba(193, 222, 241, 0.2);
    background: -webkit-linear-gradient(left, rgba(193, 222, 241, 0.2) 70%, rgba(221, 222, 241, 0));
    background: linear-gradient(to right, rgba(193, 222, 241, 0.2) 70%, rgba(221, 222, 241, 0));
}


/* highlight */

pre[data-line] {
    position: relative;
    padding: 1em 0 1em 3em;
}

pre[data-line] .line-highlight-wrapper {
    position: absolute;
    top: 0;
    left: 0;
    background-color: transparent;
    display: block;
    width: 100%;
}

pre[data-line] .line-highlight {
    position: absolute;
    left: 0;
    right: 0;
    padding: inherit 0;
    margin-top: 1em;
    background: hsla(24, 20%, 50%, .08);
    background: linear-gradient(to right, hsla(24, 20%, 50%, .1) 70%, hsla(24, 20%, 50%, 0));
    pointer-events: none;
    line-height: inherit;
    white-space: pre;
}

pre[data-line] .line-highlight:before,
pre[data-line] .line-highlight[data-end]:after {
    content: attr(data-start);
    position: absolute;
    top: .4em;
    left: .6em;
    min-width: 1em;
    padding: 0 .5em;
    background-color: hsla(24, 20%, 50%, .4);
    color: hsl(24, 20%, 95%);
    font: bold 65%/1.5 sans-serif;
    text-align: center;
    vertical-align: .3em;
    text-shadow: none;
    box-shadow: 0 1px white;
}

pre[data-line] .line-highlight[data-end]:after {
    content: attr(data-end);
    top: auto;
    bottom: .4em;
}html body {
    font-family: "Consolas", Arial, freesans, sans-serif;
    font-size: 12px;
    height: 100%;
    color: #2F2F2F;
    background-color: #fff;
    overflow: initial;
    box-sizing: border-box;
    word-wrap: break-word;
}

html body h1 {
    color: #4169E1;
    font-weight: bold;
    font-size: 12px;
    font-weight: 600;
    margin-top: 3em;
}

html body h2,
html body h3,
html body h4,
html body h5,
html body h6 {
    color: #2b2b2b;
    font-weight: bold;
    font-size: 12px;
    font-weight: 600;
}

html body strong {
    color: #000
}

html body del {
    color: #5c5c5c
}

html body a:not([href]) {
    color: inherit;
    text-decoration: none
}

html body a {
    color: #4169E1;
    text-decoration: none
}

html body a:hover {
    color: #4169E1;
    text-decoration: none
}

html body img {
    max-width: 100%
}

html body>p {
    display: block;
    margin-block-start: 0em;
    margin-block-end: 0em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    word-wrap: break-word;
}

html body>ul,
html body>ol {
    margin-bottom: 0px
}

html body ul,
html body ol {
    padding-left: 2em
}

html body ul.no-list,
html body ol.no-list {
    padding: 0;
    list-style-type: none
}

html body ul ul,
html body ul ol,
html body ol ol,
html body ol ul {
    margin-top: 0;
    margin-bottom: 0
}

html body li {
    margin-bottom: 0
}

html body li.task-list-item {
    list-style: none
}

html body li>p {
    margin-top: 0;
    margin-bottom: 0
}

html body .task-list-item-checkbox {
    margin: 0 .2em .25em -1.8em;
    vertical-align: middle
}

html body .task-list-item-checkbox:hover {
    cursor: pointer
}

html body blockquote {
    margin: 16px 0;
    font-size: inherit;
    padding: 0 15px;
    color: #5c5c5c;
    border-left: 4px solid #d6d6d6
}

html body blockquote>:first-child {
    margin-top: 0
}

html body blockquote>:last-child {
    margin-bottom: 0
}

html body hr {
    height: 4px;
    margin: 32px 0;
    background-color: #d6d6d6;
    border: 0 none
}

html body table {
    margin: 10px 0 15px 0;
    border-collapse: collapse;
    border-spacing: 0;
    display: block;
    width: 100%;
    overflow: auto;
    word-break: normal;
    word-break: keep-all
}

html body table th {
    font-weight: bold;
    color: #000
}

html body table td,
html body table th {
    border: 1px solid #d6d6d6;
    padding: 6px 13px
}

html body dl {
    padding: 0
}

html body dl dt {
    padding: 0;
    margin-top: 16px;
    font-size: 1em;
    font-style: italic;
    font-weight: bold
}

html body dl dd {
    padding: 0 16px;
    margin-bottom: 0px
}

html body code {
    font-family: Consolas, monospace;
    font-size: 12px !important;
    color: #000;
    background-color: #f0f0f0;
}

html body code::before,
html body code::after {
    letter-spacing: -0.2em;
    content: "\00a0"
}

html body pre>code {
    padding: 0;
    margin: 0;
    font-size: .85em !important;
    word-break: normal;
    white-space: pre;
    background: transparent;
    border: 0
}

html body .highlight {
    margin-bottom: 0px
}

html body .highlight pre,
html body pre {
    padding: 1em;
    overflow: auto;
    font-size: .85em !important;
    line-height: 1.45;
    border: #d6d6d6;
    border-radius: 3px
}

html body .highlight pre {
    margin-bottom: 0;
    word-break: normal
}

html body pre code,
html body pre tt {
    display: inline;
    max-width: initial;
    padding: 0;
    margin: 0;
    overflow: initial;
    line-height: inherit;
    word-wrap: normal;
    background-color: transparent;
    border: 0
}

html body pre code:before,
html body pre tt:before,
html body pre code:after,
html body pre tt:after {
    content: normal
}

html body p,
html body blockquote,
html body ul,
html body ol,
html body dl,
html body pre {
    /* nothing */
}

html body kbd {
    color: #000;
    border: 1px solid #d6d6d6;
    border-bottom: 2px solid #c7c7c7;
    padding: 2px 4px;
    background-color: #f0f0f0;
    border-radius: 3px
}

@media print {
    html body {
        background-color: #fff
    }
    html body h1,
    html body h2,
    html body h3,
    html body h4,
    html body h5,
    html body h6 {
        color: #000;
        page-break-after: avoid
    }
    html body blockquote {
        color: #5c5c5c
    }
    html body pre {
        page-break-inside: avoid
    }
    html body table {
        display: table
    }
    html body img {
        display: block;
        max-width: 100%;
        max-height: 100%
    }
    html body pre,
    html body code {
        word-wrap: break-word;
        white-space: pre
    }
}

.markdown-preview {
    float: left;
    margin: 10px auto 10px 10px;
    color: #2F2F2F;
    border: 1px dashed #DDDDDD;
    padding: 10px;
    width: 80em;
}

p {
    margin: 1em 0 1em 0;
}


/* code block theme */.markdown-preview {
    height: 100%;
    box-sizing: border-box
}

.markdown-preview .pagebreak,
.markdown-preview .newpage {
    page-break-before: always
}

.markdown-preview pre.line-numbers {
    position: relative;
    padding-left: 3.8em;
    counter-reset: linenumber
}

.markdown-preview pre.line-numbers>code {
    position: relative
}

.markdown-preview pre.line-numbers .line-numbers-rows {
    position: absolute;
    pointer-events: none;
    top: 1em;
    font-size: 100%;
    left: 0;
    width: 3em;
    letter-spacing: -1px;
    border-right: 1px solid #999;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none
}

.markdown-preview pre.line-numbers .line-numbers-rows>span {
    pointer-events: none;
    display: block;
    counter-increment: linenumber
}

.markdown-preview pre.line-numbers .line-numbers-rows>span:before {
    content: counter(linenumber);
    color: #999;
    display: block;
    padding-right: .8em;
    text-align: right
}

.markdown-preview .mathjax-exps .MathJax_Display {
    text-align: center !important
}

.markdown-preview:not([for="preview"]) .code-chunk .btn-group {
    display: none
}

.markdown-preview:not([for="preview"]) .code-chunk .status {
    display: none
}

.markdown-preview:not([for="preview"]) .code-chunk .output-div {
    margin-bottom: 16px
}

.scrollbar-style::-webkit-scrollbar {
    width: 8px
}

.scrollbar-style::-webkit-scrollbar-track {
    border-radius: 10px;
    background-color: transparent
}

.scrollbar-style::-webkit-scrollbar-thumb {
    border-radius: 5px;
    background-color: rgba(150, 150, 150, 0.66);
    border: 4px solid rgba(150, 150, 150, 0.66);
    background-clip: content-box
}

html body[for="html-export"]:not([data-presentation-mode]) {
    position: relative;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    margin: 0;
    padding: 0;
    overflow: auto
}

html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview {
    position: relative;
    top: 0
}

@media screen and (max-width:450px) {
    html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview {
        font-size: 12px !important;
    }
}

@media print {
    html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn {
        display: none
    }
}

html body[for="html-export"]:not([data-presentation-mode]) #sidebar-toc-btn {
    position: fixed;
    bottom: 8px;
    right: 8px;
    font-size: 28px;
    cursor: pointer;
    color: inherit;
    z-index: 99;
    width: 32px;
    text-align: center;
    opacity: .4
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] #sidebar-toc-btn {
    opacity: 1
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc {
    position: fixed;
    top: 0;
    right: 0;
    width: 300px;
    height: 100%;
    padding: 32px 0 48px 0;
    font-size: 12px;
    border-left: 1px dashed #DDDDDD;
    box-sizing: border-box;
    overflow: auto;
    background-color: inherit
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar {
    width: 8px
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-track {
    border-radius: 10px;
    background-color: transparent
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc::-webkit-scrollbar-thumb {
    border-radius: 5px;
    background-color: rgba(150, 150, 150, 0.66);
    border: 4px solid rgba(150, 150, 150, 0.66);
    background-clip: content-box
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc a {
    text-decoration: none
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul {
    padding: 0 1.6em;
    margin-top: .8em
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc li {
    margin-bottom: .8em
}

html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .md-sidebar-toc ul {
    list-style-type: none
}

@media screen and (max-width:1274px) {
    html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview {
        padding: 0em
    }
}

@media screen and (max-width:450px) {
    html body[for="html-export"]:not([data-presentation-mode])[html-show-sidebar-toc] .markdown-preview {
        width: 100%
    }
}

html body[for="html-export"]:not([data-presentation-mode]):not([html-show-sidebar-toc]) .md-sidebar-toc {
    display: none
}

@media screen and (max-width:914px) {
    html body[for="html-export"]:not([data-presentation-mode]) .markdown-preview {
        width: 100%
    }
}
/* Please visit the URL below for more information: */
/*   https://shd101wyy.github.io/markdown-preview-enhanced/#/customize-css */

      </style>
    </head>
    <body for="html-export">
      <div class="mume markdown-preview  ">
      <h2>Write-Your-Own-Lua-VM-Compiler-and-Standard-Library-Reading-Notes.md</h2>
<ul>
<li>@name       &#x81EA;&#x5DF1;&#x52A8;&#x624B;&#x5B9E;&#x73B0;Lua &#x865A;&#x62DF;&#x673A;, &#x7F16;&#x8BD1;&#x5668;&#x548C;&#x6807;&#x51C6;&#x5E93; &#x8BFB;&#x4E66;&#x7B14;&#x8BB0;</li>
<li>@author     karminski &lt;<a href="mailto:code.karminski@outlook.com">code.karminski@outlook.com</a>&gt;</li>
<li>@version    20200518:1</li>
</ul>
<h1 class="mume-header" id="chapter-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">Chapter 1, &#x51C6;&#x5907;&#x5DE5;&#x4F5C;</h1>

<h1 class="mume-header" id="chapter-2-%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">Chapter 2, &#x4E8C;&#x8FDB;&#x5236; Chunk</h1>

<h2 class="mume-header" id="21-%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">2.1 &#x4EC0;&#x4E48;&#x662F;&#x4E8C;&#x8FDB;&#x5236; Chunk</h2>

<p>&#x5373;Lua&#x9884;&#x7F16;&#x8BD1;&#x5F62;&#x6210;&#x7684;&#x865A;&#x62DF;&#x673A;&#x6267;&#x884C;&#x7684;&#x5B57;&#x8282;&#x7801;. &#x53EB;&#x505A;<strong>&#x9884;&#x7F16;&#x8BD1; Chunk (Precomplied Chunk)</strong> &#x6216;<strong>&#x4E8C;&#x8FDB;&#x5236; Chunk (Binary Chunk)</strong>.</p>
<h2 class="mume-header" id="22-luac-%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D">2.2 luac &#x547D;&#x4EE4;&#x4ECB;&#x7ECD;</h2>

<h3 class="mume-header" id="221-%E7%BC%96%E8%AF%91-lua-%E6%BA%90%E6%96%87%E4%BB%B6">2.2.1 &#x7F16;&#x8BD1; Lua &#x6E90;&#x6587;&#x4EF6;</h3>

<p>Lua &#x7F16;&#x8BD1;&#x5668;&#x4EE5;&#x51FD;&#x6570;&#x4E3A;&#x5355;&#x4F4D;&#x8FDB;&#x884C;&#x7F16;&#x8BD1;, &#x6BCF;&#x4E2A;&#x51FD;&#x6570;&#x90FD;&#x4F1A;&#x88AB;&#x7F16;&#x8BD1;&#x4E3A;&#x4E00;&#x4E2A;&#x5185;&#x90E8;&#x7ED3;&#x6784;, &#x79F0;&#x4E3A; <strong>&#x539F;&#x578B; (Prototype)</strong>.<br>
&#x539F;&#x578B;&#x5305;&#x62EC;:</p>
<ul>
<li>&#x51FD;&#x6570;&#x57FA;&#x672C;&#x4FE1;&#x606F; (&#x5305;&#x62EC;&#x53C2;&#x6570;&#x6570;&#x91CF;, &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6570;&#x91CF;&#x7B49;)</li>
<li>&#x5B57;&#x8282;&#x7801;</li>
<li>&#x5E38;&#x91CF;&#x8868;</li>
<li>upvalue &#x8868;</li>
<li>&#x8C03;&#x8BD5;&#x4FE1;&#x606F;</li>
<li>&#x5B50;&#x51FD;&#x6570;&#x539F;&#x578B;&#x5217;&#x8868;</li>
</ul>
<p>&#x51FD;&#x6570;&#x539F;&#x578B;&#x662F;&#x4E00;&#x79CD;&#x9012;&#x5F52;&#x7ED3;&#x6784;, &#x5E76;&#x4E14; Lua &#x6E90;&#x7801;&#x4E2D;&#x51FD;&#x6570;&#x7684;&#x5D4C;&#x5957;&#x5173;&#x7CFB;&#x4F1A;&#x76F4;&#x63A5;&#x53CD;&#x6620;&#x5728;&#x7F16;&#x8BD1;&#x540E;&#x7684;&#x539F;&#x578B;&#x91CC;.</p>
<p>&#x5728;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;, &#x66B4;&#x9732;&#x5728;&#x5168;&#x5C40;&#x7684;&#x8BED;&#x53E5;&#x4F1A;&#x88AB;&#x5305;&#x88C5;&#x8FDB; main &#x51FD;&#x6570;. &#x8FD9;&#x662F;&#x81EA;&#x52A8;&#x5B8C;&#x6210;&#x7684;.</p>
<h3 class="mume-header" id="222-%E6%9F%A5%E7%9C%8B%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">2.2.2 &#x67E5;&#x770B;&#x4E8C;&#x8FDB;&#x5236; chunk</h3>

<p>&#x8FD9;&#x662F; main &#x7684;:</p>
<pre data-role="codeBlock" data-info class="language-"><code>[root@m01 c1]# luac -l hello.out

main &lt;./hello.lua:0,0&gt; (4 instructions, 16 bytes at 0x173c530)
0+ params, 2 slots, 0 upvalues, 0 locals, 2 constants, 0 functions
	1	[1]	GETGLOBAL	0 -1	; print
	2	[1]	LOADK    	1 -2	; &quot;hello&quot;
	3	[1]	CALL     	0 2 1
	4	[1]	RETURN   	0 1
</code></pre><p>&#x8FD9;&#x662F; foo-bar &#x7684;:</p>
<pre data-role="codeBlock" data-info class="language-"><code>[root@m01 c1]# luac -l foobar.lua 

main &lt;foobar.lua:0,0&gt; (3 instructions, 12 bytes at 0xb74530)
0+ params, 2 slots, 0 upvalues, 0 locals, 1 constant, 1 function
	1	[3]	CLOSURE  	0 0	; 0xb74710
	2	[1]	SETGLOBAL	0 -1	; foo
	3	[3]	RETURN   	0 1

function &lt;foobar.lua:1,3&gt; (3 instructions, 12 bytes at 0xb74710)
0 params, 2 slots, 0 upvalues, 0 locals, 1 constant, 1 function
	1	[2]	CLOSURE  	0 0	; 0xb748c0
	2	[2]	SETGLOBAL	0 -1	; bar
	3	[3]	RETURN   	0 1

function &lt;foobar.lua:2,2&gt; (1 instruction, 4 bytes at 0xb748c0)
0 params, 2 slots, 0 upvalues, 0 locals, 0 constants, 0 functions
	1	[2]	RETURN   	0 1
[root@m01 c1]# 

</code></pre><pre data-role="codeBlock" data-info class="language-"><code>&#x540D;&#x79F0; &lt;&#x6240;&#x5728;&#x6587;&#x4EF6;: &#x5F00;&#x59CB;&#x884C;&#x53F7;, &#x7ED3;&#x675F;&#x884C;&#x53F7;&gt; (&#x6307;&#x4EE4;&#x6570;&#x91CF;, &#x51FD;&#x6570;&#x5730;&#x5740;)
&#x56FA;&#x5B9A;&#x53C2;&#x6570;&#x6570;&#x91CF; (&#x5982;&#x679C;&#x6709;+, &#x5219;&#x4EE3;&#x8868;&#x662F; vararg &#x51FD;&#x6570;), &#x8FD0;&#x884C;&#x51FD;&#x6570;&#x6240;&#x9700;&#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;, upvalue &#x6570;&#x91CF;, &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6570;&#x91CF;, &#x5E38;&#x91CF;&#x6570;&#x91CF;, &#x5B50;&#x51FD;&#x6570;&#x6570;&#x91CF;.
&#x6307;&#x4EE4;&#x5E8F;&#x53F7;, &#x5BF9;&#x5E94;&#x884C;&#x53F7;, &#x64CD;&#x4F5C;&#x7801;, &#x64CD;&#x4F5C;&#x6570;, ; &#x540E;&#x662F;&#x6CE8;&#x91CA;.

</code></pre><p>&#x4F7F;&#x7528; <code>-l -l</code> &#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x8BE6;&#x60C5;, &#x5305;&#x62EC;&#x5E38;&#x91CF;&#x5217;&#x8868;, &#x5C40;&#x90E8;&#x53D8;&#x91CF;, upvalue &#x8868;:</p>
<pre data-role="codeBlock" data-info class="language-"><code>[root@m01 c1]# luac -l -l hello.lua 

main &lt;hello.lua:0,0&gt; (4 instructions, 16 bytes at 0x696530)
0+ params, 2 slots, 0 upvalues, 0 locals, 2 constants, 0 functions
	1	[1]	GETGLOBAL	0 -1	; print
	2	[1]	LOADK    	1 -2	; &quot;hello&quot;
	3	[1]	CALL     	0 2 1
	4	[1]	RETURN   	0 1
constants (2) for 0x696530:
	1	&quot;print&quot;
	2	&quot;hello&quot;
locals (0) for 0x696530:
upvalues (0) for 0x696530:
[root@m01 c1]# 
</code></pre><h2 class="mume-header" id="23-%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk-%E6%A0%BC%E5%BC%8F">2.3 &#x4E8C;&#x8FDB;&#x5236; chunk &#x683C;&#x5F0F;</h2>

<p>Lua &#x4E8C;&#x8FDB;&#x5236; chunk &#x4E00;&#x4E9B;&#x7EC6;&#x8282;&#x4E8B;&#x9879;:</p>
<ul>
<li>&#x4E8C;&#x8FDB;&#x5236; chunk &#x658C;&#x5E76;&#x6CA1;&#x6709;&#x6807;&#x51C6;&#x5316;, &#x9700;&#x8981;&#x770B;&#x5177;&#x4F53;&#x5B9E;&#x73B0;&#x7EC6;&#x8282;</li>
<li>&#x6CA1;&#x8003;&#x8651;&#x8DE8;&#x5E73;&#x53F0;, &#x5982;&#x679C;&#x6570;&#x636E;&#x8D85;&#x8FC7;&#x4E00;&#x4E2A;&#x5B57;&#x8282;, &#x751F;&#x6210; chunk &#x65F6;&#x4F1A;&#x6309;&#x7167;&#x672C;&#x673A;&#x5927;&#x5C0F;&#x7AEF;&#x751F;&#x6210;, &#x52A0;&#x8F7D;&#x8FD0;&#x884C;&#x65F6;&#x5982;&#x679C;&#x68C0;&#x6D4B;&#x5230;&#x4E0E;&#x76EE;&#x6807;&#x673A;&#x5668;&#x4E0D;&#x7B26;&#x5219;&#x62D2;&#x7EDD;&#x52A0;&#x8F7D;.</li>
<li>&#x7248;&#x672C;&#x95F4;&#x53EF;&#x80FD;&#x4E0D;&#x517C;&#x5BB9;</li>
<li>&#x4E0D;&#x662F;&#x5F88;&#x7D27;&#x51D1;, &#x53EF;&#x80FD;&#x6BD4;&#x6E90;&#x6587;&#x4EF6;&#x8FD8;&#x5927;.</li>
</ul>
<h3 class="mume-header" id="231-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">2.3.1 &#x6570;&#x636E;&#x7C7B;&#x578B;</h3>

<p>&#x4E8C;&#x8FDB;&#x5236; chunk &#x5185;&#x90E8;&#x4F7F;&#x7528;&#x7684;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5927;&#x81F4;&#x53EF;&#x5206;&#x4E3A; &#x6570;&#x5B57;, &#x5B57;&#x7B26;&#x4E32;, &#x5217;&#x8868; &#x4E09;&#x79CD;.</p>
<h4 class="mume-header" id="1-%E6%95%B0%E5%AD%97">1. &#x6570;&#x5B57;</h4>

<table>
<thead>
<tr>
<th>&#x6570;&#x636E;&#x7C7B;&#x578B;</th>
<th>C &#x8BED;&#x8A00;&#x7C7B;&#x578B;</th>
<th>Go &#x8BED;&#x8A00;&#x7C7B;&#x578B;</th>
<th>&#x5360;&#x7528;&#x5B57;&#x8282;</th>
</tr>
</thead>
<tbody>
<tr>
<td>&#x5B57;&#x8282;</td>
<td>lu_Byte (unsigned char)</td>
<td>byte</td>
<td>1</td>
</tr>
<tr>
<td>C &#x8BED;&#x8A00;&#x6574;&#x578B;</td>
<td>int</td>
<td>uint32</td>
<td>4</td>
</tr>
<tr>
<td>C &#x8BED;&#x8A00; size_t &#x7C7B;&#x578B;</td>
<td>size_t</td>
<td>uint64</td>
<td>8</td>
</tr>
<tr>
<td>Lua &#x6574;&#x578B;</td>
<td>lua_Integer (long long)</td>
<td>int64</td>
<td>8</td>
</tr>
<tr>
<td>Lua &#x6D6E;&#x70B9;&#x578B;</td>
<td>lua_Number (double)</td>
<td>float64</td>
<td>8</td>
</tr>
</tbody>
</table>
<h4 class="mume-header" id="2-%E5%AD%97%E7%AC%A6%E4%B8%B2">2. &#x5B57;&#x7B26;&#x4E32;</h4>

<p>&#x5B57;&#x7B26;&#x4E32;&#x5728;&#x4E8C;&#x8FDB;&#x5236; chunk &#x91CC;&#x9762;&#x662F;&#x5B57;&#x8282;&#x6570;&#x7EC4;, &#x5E76;&#x8BB0;&#x5F55;&#x957F;&#x5EA6;.</p>
<ul>
<li>NULL &#x5B57;&#x7B26;&#x4E32;, 0x00</li>
<li>&#x957F;&#x5EA6;&#x5C0F;&#x4E8E; 253 (0xFD), &#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x8BB0;&#x5F55;&#x957F;&#x5EA6; (&#x6570;&#x503C;+1), &#x5176;&#x4F59;&#x662F;&#x5B57;&#x8282;&#x6570;&#x7EC4;</li>
<li>&#x957F;&#x5EA6;&#x5927;&#x4E8E; 253, &#x7B2C;&#x4E00;&#x4E2A;&#x5B57;&#x8282;&#x662F; 0xFF, &#x7136;&#x540E;&#x662F; size_t &#x8BB0;&#x5F55;&#x957F;&#x5EA6; (&#x6570;&#x503C;+1), &#x6700;&#x540E;&#x662F;&#x5B57;&#x8282;&#x6570;&#x7EC4;.</li>
</ul>
<h4 class="mume-header" id="3-%E5%88%97%E8%A1%A8">3. &#x5217;&#x8868;</h4>

<p>&#x6307;&#x4EE4;&#x8868;, &#x5E38;&#x91CF;&#x8868;, &#x5B50;&#x51FD;&#x6570;&#x539F;&#x578B;&#x8868;&#x7B49;&#x5747;&#x4F7F;&#x7528;&#x5217;&#x8868;&#x5B58;&#x50A8;.</p>
<p>&#x5148;&#x7528; cint &#x7C7B;&#x578B;&#x8BB0;&#x5F55;&#x5217;&#x8868;&#x957F;&#x5EA6;, &#x7136;&#x540E;&#x5B58;&#x50A8; n &#x4E2A;&#x5217;&#x8868;&#x5143;&#x7D20;.</p>
<h3 class="mume-header" id="232-%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84">2.3.2 &#x603B;&#x4F53;&#x7ED3;&#x6784;</h3>

<p>&#x7528;&#x4E8E;&#x62BD;&#x8C61;&#x7684; binaryChunk &#x7ED3;&#x6784;&#x4E3A;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">package</span> binchunk

<span class="token keyword">type</span> binaryChunk <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    header                  <span class="token comment">// &#x5934;&#x90E8;</span>
    sizeUpvalues <span class="token builtin">byte</span>       <span class="token comment">// &#x4E3B;&#x51FD;&#x6570; upvalue</span>
    mainFunc     <span class="token operator">*</span>Prototype <span class="token comment">// &#x4E3B;&#x51FD;&#x6570;&#x539F;&#x578B;</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="233-%E5%A4%B4%E9%83%A8">2.3.3 &#x5934;&#x90E8;</h3>

<p>&#x4E8C;&#x8FDB;&#x5236; chunk &#x5934;&#x90E8;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> header <span class="token keyword">struct</span>
    signature          <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    version            <span class="token builtin">byte</span>
    format             <span class="token builtin">byte</span>
    luacData           <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
    cintByte           <span class="token builtin">byte</span>
    sizetSize          <span class="token builtin">byte</span>
    instructionSize    <span class="token builtin">byte</span>
    luaIntegerSize     <span class="token builtin">byte</span>
    luaNumberSize      <span class="token builtin">byte</span>
    luacInt            <span class="token builtin">int64</span>
    luacNum            <span class="token builtin">float64</span>
<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="1-%E7%AD%BE%E5%90%8D">1. &#x7B7E;&#x540D;</h4>

<p>Lua &#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x8D77;&#x59CB;&#x7B7E;&#x540D; (&#x9B54;&#x6570;, Magic Number) &#x662F; ESC, L, u, a &#x7684; ASCII&#x7801;. &#x5373; 0x1B4C7561, Go &#x5B57;&#x9762;&#x91CF;&#x4E3A; &quot;\x1bLua&quot;.</p>
<pre data-role="codeBlock" data-info class="language-"><code>[root@m01 c1]# xxd -u -g 1 ./hello.out 
0000000: 1B 4C 75 61 51 00 01 04 08 04 08 00 0D 00 00 00  .LuaQ...........
0000010: 00 00 00 00 40 2E 2F 68 65 6C 6C 6F 2E 6C 75 61  ....@./hello.lua
0000020: 00 00 00 00 00 00 00 00 00 00 00 02 02 04 00 00  ................
0000030: 00 05 00 00 00 41 40 00 00 1C 40 00 01 1E 00 80  .....A@...@.....
0000040: 00 02 00 00 00 04 06 00 00 00 00 00 00 00 70 72  ..............pr
0000050: 69 6E 74 00 04 06 00 00 00 00 00 00 00 68 65 6C  int..........hel
0000060: 6C 6F 00 00 00 00 00 04 00 00 00 01 00 00 00 01  lo..............
0000070: 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00  ................
0000080: 00 00 00    
</code></pre><h4 class="mume-header" id="2-%E7%89%88%E6%9C%AC%E5%8F%B7">2. &#x7248;&#x672C;&#x53F7;</h4>

<p>&#x7D27;&#x8DDF;&#x5728;&#x4E8C;&#x8FDB;&#x5236;&#x7B7E;&#x540D;&#x540E;, &#x4EC5;&#x5305;&#x542B;&#x5927;&#x7248;&#x672C;&#x53F7; (Major Version) &#x548C; &#x5C0F;&#x7248;&#x672C;&#x53F7;(Minor Version). lua 5.3.4 &#x5373; 5 x 16 + 3 = 83, &#x5373; 0x53.</p>
<h4 class="mume-header" id="3-%E6%A0%BC%E5%BC%8F%E5%8F%B7">3. &#x683C;&#x5F0F;&#x53F7;</h4>

<p>lua &#x865A;&#x62DF;&#x673A;&#x5B9A;&#x4E49;&#x7684;&#x683C;&#x5F0F;&#x53F7;&#x5373;&#x63A5;&#x4E0B;&#x6765;&#x4E00;&#x4E2A;&#x5B57;&#x8282;, 0.</p>
<h4 class="mume-header" id="4-luac_data">4. LUAC_DATA</h4>

<p>&#x540C;&#x6837;&#x7528;&#x6765;&#x4E8C;&#x8FDB;&#x5236;&#x68C0;&#x67E5;, &quot;\x19\x93\r\n\x1a\n&quot;.</p>
<h4 class="mume-header" id="5-%E6%95%B4%E6%95%B0%E5%92%8C-lua-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4%E5%AE%BD%E5%BA%A6">5. &#x6574;&#x6570;&#x548C; Lua &#x865A;&#x62DF;&#x673A;&#x6307;&#x4EE4;&#x5BBD;&#x5EA6;</h4>

<p>&#x63A5;&#x4E0B;&#x6765;5&#x4E2A;&#x5B57;&#x8282;&#x8BB0;&#x5F55; cint, size_t, lua &#x865A;&#x62DF;&#x673A;&#x6307;&#x4EE4;, lua &#x6574;&#x6570;, lua &#x6D6E;&#x70B9;&#x6570; &#x8FD9;5&#x79CD;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x5728;&#x4E8C;&#x8FDB;&#x5236; chunk &#x5360;&#x7528;&#x7684;&#x5B57;&#x8282;&#x6570;.</p>
<h4 class="mume-header" id="6-luac_int">6. LUAC_INT</h4>

<p>&#x63A5;&#x4E0B;&#x6765;&#x5B58;&#x653E;&#x7684;&#x662F;&#x6574;&#x6570;&#x503C; 0x5678 &#x7528;&#x4E8E;&#x68C0;&#x67E5;&#x5927;&#x5C0F;&#x7AEF;.</p>
<h4 class="mume-header" id="7-luac_num">7. LUAC_NUM</h4>

<p>&#x7136;&#x540E;&#x5B58;&#x653E;&#x6D6E;&#x70B9;&#x6570; 370.5 &#x7528;&#x4EE5;&#x68C0;&#x6D4B;&#x6D6E;&#x70B9;&#x6570;&#x683C;&#x5F0F;.</p>
<h3 class="mume-header" id="234-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B">2.3.4 &#x51FD;&#x6570;&#x539F;&#x578B;</h3>

<p>&#x51FD;&#x6570;&#x539F;&#x578B;&#x7ED3;&#x6784;&#x4F53;&#x4E3A;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> Prototype <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    Source              <span class="token builtin">string</span>
    LineDefined         <span class="token builtin">uint32</span>
    LastLineDefined     <span class="token builtin">uint32</span>
    NumParams           <span class="token builtin">byte</span>
    IsVararg            <span class="token builtin">byte</span>
    MaxStackSize        <span class="token builtin">byte</span>
    Code                <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
    Constants           <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
    Upvalues            <span class="token punctuation">[</span><span class="token punctuation">]</span>Upvalue
    Protos              <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Prototype
    LineInfo            <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
    LocVars             <span class="token punctuation">[</span><span class="token punctuation">]</span>LocVar
    UpvalueNames        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>


<span class="token punctuation">}</span>
</pre><h4 class="mume-header" id="1-%E6%BA%90%E6%96%87%E4%BB%B6%E5%90%8D">1. &#x6E90;&#x6587;&#x4EF6;&#x540D;</h4>

<p>&#x53EA;&#x6709;&#x5728;&#x4E3B;&#x51FD;&#x6570;&#x4E2D;, &#x6B64;&#x5B57;&#x6BB5;&#x624D;&#x6709;&#x503C;. &#x683C;&#x5F0F;&#x4E3A;&#x957F;&#x5EA6;+1&#x548C;&#x5B57;&#x7B26;&#x4E32;. &#x5B57;&#x7B26;&#x4E32; @ &#x5F00;&#x5934;&#x4EE3;&#x8868;&#x4ECE; lua &#x6E90;&#x6587;&#x4EF6;&#x7F16;&#x8BD1;&#x800C;&#x6765;. =stdin &#x5219;&#x4EE3;&#x8868; &#x4ECE; stdin &#x7F16;&#x8BD1;.</p>
<h4 class="mume-header" id="2-%E8%B5%B7%E6%AD%A2%E8%A1%8C%E5%8F%B7">2. &#x8D77;&#x6B62;&#x884C;&#x53F7;</h4>

<p>&#x8BB0;&#x5F55;&#x539F;&#x578B;&#x5BF9;&#x5E94;&#x8D77;&#x6B62;&#x884C;&#x53F7;.</p>
<h4 class="mume-header" id="3-%E5%9B%BA%E5%AE%9A%E5%8F%82%E6%95%B0%E4%B8%AA%E6%95%B0">3. &#x56FA;&#x5B9A;&#x53C2;&#x6570;&#x4E2A;&#x6570;</h4>

<p>&#x76F8;&#x5BF9;&#x4E8E;&#x53D8;&#x957F;&#x53C2;&#x6570;.</p>
<h4 class="mume-header" id="4-%E6%98%AF%E5%90%A6%E6%98%AF-vararg-%E5%87%BD%E6%95%B0">4. &#x662F;&#x5426;&#x662F; Vararg &#x51FD;&#x6570;</h4>

<p>&#x5373;&#x662F;&#x5426;&#x6709;&#x53D8;&#x957F;&#x53C2;&#x6570;.</p>
<h4 class="mume-header" id="5-%E5%AF%84%E5%AD%98%E5%99%A8%E6%95%B0%E9%87%8F">5. &#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;</h4>

<p>&#x4E5F;&#x88AB;&#x79F0;&#x4F5C; MaxStackSize.</p>
<h4 class="mume-header" id="6-%E6%8C%87%E4%BB%A4%E8%A1%A8">6. &#x6307;&#x4EE4;&#x8868;</h4>

<p>&#x6BCF;&#x6761;&#x6307;&#x4EE4;&#x662F; 4 &#x5B57;&#x8282;.</p>
<h4 class="mume-header" id="7-%E5%B8%B8%E9%87%8F%E8%A1%A8">7. &#x5E38;&#x91CF;&#x8868;</h4>

<p>&#x4E8C;&#x8FDB;&#x5236; chunk &#x5E38;&#x91CF; tag &#x503C;:</p>
<table>
<thead>
<tr>
<th>tag</th>
<th>Lua &#x5B57;&#x9762;&#x91CF;&#x7C7B;&#x578B;</th>
<th>&#x5B58;&#x50A8;&#x7C7B;&#x578B;</th>
</tr>
</thead>
<tbody>
<tr>
<td>0x00</td>
<td>nil</td>
<td>&#x4E0D;&#x5B58;&#x50A8;</td>
</tr>
<tr>
<td>0x01</td>
<td>boolean</td>
<td>&#x5B57;&#x8282; (0, 1)</td>
</tr>
<tr>
<td>0x03</td>
<td>number</td>
<td>Lua &#x6D6E;&#x70B9;&#x6570;</td>
</tr>
<tr>
<td>0x13</td>
<td>integer</td>
<td>Lua &#x6574;&#x6570;</td>
</tr>
<tr>
<td>0x04</td>
<td>string</td>
<td>&#x77ED;&#x5B57;&#x7B26;&#x4E32;</td>
</tr>
<tr>
<td>0x14</td>
<td>string</td>
<td>&#x957F;&#x5B57;&#x7B26;&#x4E32;</td>
</tr>
</tbody>
</table>
<h4 class="mume-header" id="8-upvalue-%E8%A1%A8">8. Upvalue &#x8868;</h4>

<p>&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x5360;&#x4E24;&#x4E2A;&#x5B57;&#x8282;.</p>
<h4 class="mume-header" id="9-%E5%AD%90%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B%E8%A1%A8">9. &#x5B50;&#x51FD;&#x6570;&#x539F;&#x578B;&#x8868;</h4>

<h4 class="mume-header" id="10-%E8%A1%8C%E5%8F%B7%E8%A1%A8">10. &#x884C;&#x53F7;&#x8868;</h4>

<p>&#x884C;&#x53F7;&#x8868;&#x4E2D;&#x7684;&#x884C;&#x53F7;&#x4E0E;&#x6307;&#x4EE4;&#x8868;&#x4E2D;&#x7684;&#x6307;&#x4EE4;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;, &#x5206;&#x522B;&#x8BB0;&#x5F55;&#x6BCF;&#x6761;&#x6307;&#x4EE4;&#x5728;&#x6E90;&#x4EE3;&#x7801;&#x4E2D;&#x5BF9;&#x5E94;&#x7684;&#x884C;&#x53F7;.</p>
<h4 class="mume-header" id="11-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8">11. &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;</h4>

<p>&#x6BCF;&#x4E2A;&#x5143;&#x7D20;&#x90FD;&#x5305;&#x542B;&#x53D8;&#x91CF;&#x540D; (&#x6309;&#x5B57;&#x7B26;&#x4E32;&#x7C7B;&#x578B;&#x5B58;&#x50A8;), &#x8D77;&#x6B62;&#x6307;&#x4EE4;&#x7D22;&#x5F15; (&#x6309; cint &#x7C7B;&#x578B;&#x5B58;&#x50A8;).</p>
<h4 class="mume-header" id="12-upvalue-%E5%90%8D%E5%88%97%E8%A1%A8">12. Upvalue &#x540D;&#x5217;&#x8868;</h4>

<p>&#x4E0E; Upvalue &#x8868;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;, &#x7528;&#x4E8E;&#x8BB0;&#x5F55; Upvalue &#x5728;&#x6E90;&#x4EE3;&#x7801;&#x4E2D;&#x7684;&#x540D;&#x5B57;.</p>
<h4 class="mume-header" id="13-undump-%E5%87%BD%E6%95%B0">13. Undump() &#x51FD;&#x6570;</h4>

<p>&#x5199;&#x4E86;&#x4E2A;&#x6821;&#x9A8C;&#x5934;&#x90E8;&#x7684;&#x51FD;&#x6570;.</p>
<h2 class="mume-header" id="24-%E8%A7%A3%E6%9E%90%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">2.4 &#x89E3;&#x6790;&#x4E8C;&#x8FDB;&#x5236; chunk</h2>

<h3 class="mume-header" id="241-%E8%AF%BB%E5%8F%96%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">2.4.1 &#x8BFB;&#x53D6;&#x57FA;&#x672C;&#x6570;&#x636E;&#x7C7B;&#x578B;</h3>

<p>&#x8FD9;&#x91CC;&#x5B9E;&#x73B0;&#x4E86;:</p>
<ul>
<li>readByte()</li>
<li>readUint32()</li>
<li>readUint64()</li>
<li>readLuaInteger()</li>
<li>readLuaNumber()</li>
<li>readString()</li>
</ul>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>reader<span class="token punctuation">)</span> <span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
    b <span class="token operator">:=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
    self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> b
<span class="token punctuation">}</span>
</pre><p>&#x5176;&#x4F59;&#x51FD;&#x6570;&#x90FD;&#x57FA;&#x4E8E;&#x7C7B;&#x4F3C; <code>readByte()</code> &#x7684;&#x6A21;&#x5F0F;&#x8FDB;&#x884C;&#x8C03;&#x6574;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>self <span class="token operator">*</span>reader<span class="token punctuation">)</span> read?<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">byte</span> <span class="token punctuation">{</span>
    i <span class="token operator">:=</span> binary<span class="token punctuation">.</span>LittleEndian<span class="token punctuation">.</span>?<span class="token punctuation">(</span><span class="token punctuation">)</span>
    self<span class="token punctuation">.</span>data <span class="token operator">=</span> self<span class="token punctuation">.</span>data<span class="token punctuation">[</span>?<span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">// &#x8FD9;&#x91CC;&#x8FDB;&#x884C; maring</span>
    <span class="token keyword">return</span> i
<span class="token punctuation">}</span>
</pre><p>readString() &#x5219;&#x66F4;&#x590D;&#x6742;&#x4E9B;, &#x9700;&#x8981;&#x6839;&#x636E;&#x5B57;&#x7B26;&#x4E32;&#x957F;&#x5EA6;&#x8FDB;&#x884C;&#x5224;&#x65AD;.</p>
<h3 class="mume-header" id="242-%E6%A3%80%E6%9F%A5%E5%A4%B4%E9%83%A8">2.4.2 &#x68C0;&#x67E5;&#x5934;&#x90E8;</h3>

<p>&#x68C0;&#x67E5;&#x5934;&#x90E8;&#x6807;&#x5FD7;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>r <span class="token operator">*</span>reader<span class="token punctuation">)</span> <span class="token function">checkHeader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUA_SIGNATURE <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;not a precompiled chunk&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUAC_VERSION <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;version mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUAC_FORMAT <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;format mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> <span class="token function">string</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span><span class="token function">readBytes</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUAC_DATA <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;corrupted!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> CINT_SIZE <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;int size mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> CSIZET_SIZE <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;size_t size mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> INSTRUCTION_SIZE <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;instruction size mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUA_INTEGER_SIZE <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;lua_Integer size mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readByte</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUA_NUMBER_SIZE <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;lua_Number size mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readLuaInteger</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUAC_INT <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;endianness mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span><span class="token function">readLuaNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> LUAC_NUM <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;float format mismatch!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="243-%E8%AF%BB%E5%8F%96%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B">2.4.3 &#x8BFB;&#x53D6;&#x51FD;&#x6570;&#x539F;&#x578B;</h3>

<p>&#x5176;&#x4E2D; readProto() &#x7528;&#x4E8E;&#x8BFB;&#x53D6;&#x51FD;&#x6570;&#x539F;&#x578B;, &#x7528;&#x4E8E;&#x586B;&#x5145; Prototype struct. &#x5176;&#x4E2D;&#x8BFB;&#x53D6; Byte &#x90E8;&#x5206;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4F7F;&#x7528; readByte(), &#x800C;&#x5176;&#x4ED6;&#x8F83;&#x957F;&#x6216;&#x590D;&#x6742;&#x90E8;&#x5206;&#x8FD8;&#x9700;&#x8981;&#x57FA;&#x4E8E;&#x4E4B;&#x524D;&#x5B9A;&#x4E49;&#x7684; read*() &#x51FD;&#x6570;&#x8FDB;&#x884C;&#x5305;&#x88C5;. &#x5305;&#x62EC;:</p>
<ul>
<li>readCode(), &#x8BFB;&#x53D6;&#x6307;&#x4EE4;&#x8868;</li>
<li>readConstants(), &#x8BFB;&#x53D6;&#x5E38;&#x91CF;&#x8868;</li>
<li>readConstant(), &#x8BFB;&#x53D6;&#x5E38;&#x91CF;</li>
<li>readUpvalues(), &#x8BFB;&#x53D6; Upvalue &#x8868;</li>
<li>readProtos(), &#x8BFB;&#x53D6;&#x51FD;&#x6570;&#x539F;&#x578B;&#x8868;</li>
<li>readLineInfo(), &#x8BFB;&#x53D6;&#x884C;&#x53F7;&#x8868;</li>
<li>readLocVars(), &#x8BFB;&#x53D6;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;</li>
<li>readUpvalueNames(), &#x8BFB;&#x53D6; Upvalue &#x540D;&#x5217;&#x8868;</li>
</ul>
<h2 class="mume-header" id="25-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">2.5 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>

<p>&#x672C;&#x8282;&#x5B9E;&#x73B0;&#x4E86;&#x7C7B;&#x4F3C; luac -l -l &#x7684; Lua chunk &#x89E3;&#x6790;&#x529F;&#x80FD;. &#x5177;&#x4F53;&#x770B;&#x6E90;&#x4EE3;&#x7801;&#x5373;&#x53EF;, &#x6CA1;&#x6709;&#x590D;&#x6742;&#x5185;&#x5BB9;.</p>
<h1 class="mume-header" id="chapter-3-%E6%8C%87%E4%BB%A4%E9%9B%86">Chapter 3, &#x6307;&#x4EE4;&#x96C6;</h1>

<h2 class="mume-header" id="31-%E6%8C%87%E4%BB%A4%E9%9B%86%E4%BB%8B%E7%BB%8D">3.1 &#x6307;&#x4EE4;&#x96C6;&#x4ECB;&#x7ECD;</h2>

<p>&#x57FA;&#x4E8E;&#x6808;&#x7684;&#x865A;&#x62DF;&#x673A;&#x9700;&#x8981;&#x4F7F;&#x7528; PUSH, POP &#x7C7B;&#x6307;&#x4EE4;&#x64CD;&#x4F5C;&#x6808;. &#x56E0;&#x6B64;&#x6307;&#x4EE4;&#x96C6;&#x76F8;&#x5BF9;&#x8F83;&#x5927;, &#x4F46;&#x6307;&#x4EE4;&#x5E73;&#x5747;&#x957F;&#x5EA6;&#x8F83;&#x77ED;. &#x57FA;&#x4E8E;&#x5BC4;&#x5B58;&#x5668;&#x7684;&#x865A;&#x62DF;&#x673A;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4E8C;&#x5BF9;&#x5BC4;&#x5B58;&#x5668;&#x8FDB;&#x884C;&#x5BFB;&#x5740;, &#x56E0;&#x6B64;&#x6307;&#x4EE4;&#x96C6;&#x76F8;&#x5BF9;&#x8F83;&#x5C0F;, &#x4F46;&#x7531;&#x4E8E;&#x9700;&#x8981;&#x628A;&#x5BC4;&#x5B58;&#x5668;&#x9012;&#x6307;&#x7F16;&#x7801;&#x8FDB;&#x6307;&#x4EE4;, &#x56E0;&#x6B64;&#x6307;&#x4EE4;&#x5E73;&#x5747;&#x957F;&#x5EA6;&#x6BD4;&#x8F83;&#x957F;.</p>
<p>Lua &#x865A;&#x62DF;&#x673A;&#x91C7;&#x7528;&#x5B9A;&#x957F;&#x6307;&#x4EE4;&#x96C6;, &#x6BCF;&#x6761;&#x6307;&#x4EE4;&#x5360;4&#x4E2A;&#x5B57;&#x8282; (32b), 6b &#x7528;&#x4E8E; Opcode (&#x64CD;&#x4F5C;&#x7801;), &#x5176;&#x4F59; 26b &#x7528;&#x4E8E; Operand (&#x64CD;&#x4F5C;&#x6570;).</p>
<h2 class="mume-header" id="32-%E6%8C%87%E4%BB%A4%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F">3.2 &#x6307;&#x4EE4;&#x7F16;&#x7801;&#x683C;&#x5F0F;</h2>

<p>&#x8BA8;&#x8BBA;<strong>&#x7F16;&#x7801;&#x6A21;&#x5F0F;</strong>, <strong>&#x64CD;&#x4F5C;&#x6570;</strong>, <strong>&#x64CD;&#x4F5C;&#x7801;</strong>.</p>
<h3 class="mume-header" id="321-%E7%BC%96%E7%A0%81%E6%A8%A1%E5%BC%8F">3.2.1 &#x7F16;&#x7801;&#x6A21;&#x5F0F;</h3>

<p>Lua &#x865A;&#x62DF;&#x673A;&#x6307;&#x4EE4;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;4&#x7C7B;, &#x5206;&#x522B;&#x5BF9;&#x5E94;4&#x79CD;&#x7F16;&#x7801;&#x6A21;&#x5F0F;:</p>
<ul>
<li>iABC, &#x8BE5;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x643A;&#x5E26; A, B, C &#x4E09;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;. &#x5206;&#x522B;&#x5360;&#x7528; 8b, 9b, 9b.</li>
<li>iABx, &#x8BE5;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x643A;&#x5E26; A, Bx &#x4E24;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;, &#x5206;&#x522B;&#x5360; 8b, 18b.</li>
<li>iAsBx, &#x8BE5;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x643A;&#x5E26; A, sBx &#x4E24;&#x4E2A;&#x64CD;&#x4F5C;&#x6570;, &#x5360; 8b, 18b. &#x53EA;&#x6709;&#x8BE5;&#x6A21;&#x5F0F;&#x4E0B;&#x7684; sBx &#x64CD;&#x4F5C;&#x6570;&#x4F1A;&#x88AB;&#x89E3;&#x91CA;&#x6210;&#x6709;&#x7B26;&#x53F7;&#x6574;&#x6570;.</li>
<li>iAx, &#x8BE5;&#x6A21;&#x5F0F;&#x53EF;&#x4EE5;&#x643A;&#x5E26; Ax, &#x5360; 26b.</li>
</ul>
<p>&#x5728; Lua &#x865A;&#x62DF;&#x673A;&#x603B;&#x8BA1; 47 &#x6761;&#x6307;&#x4EE4;&#x4E2D;, 39 &#x6761;&#x4F7F;&#x7528; iABC &#x6A21;&#x5F0F;. &#x5269;&#x4F59; iABx (3), iAsBx (4), iAx (1).</p>
<h3 class="mume-header" id="322-%E6%93%8D%E4%BD%9C%E7%A0%81">3.2.2 &#x64CD;&#x4F5C;&#x7801;</h3>

<p>&#x603B;&#x8BA1; 47 &#x4E2A;.</p>
<h3 class="mume-header" id="323-%E6%93%8D%E4%BD%9C%E6%95%B0">3.2.3 &#x64CD;&#x4F5C;&#x6570;</h3>

<p>&#x64CD;&#x4F5C;&#x6570; A &#x4E3B;&#x8981;&#x7528;&#x4E8E;&#x8868;&#x793A;&#x76EE;&#x6807;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;. &#x5176;&#x4ED6;&#x64CD;&#x4F5C;&#x6570;&#x5219;&#x53EF;&#x5206;&#x4E3A; 4 &#x79CD;&#x7C7B;&#x578B;:</p>
<ul>
<li>OpArgN, &#x4E0D;&#x88AB;&#x4F7F;&#x7528;&#x7684;&#x64CD;&#x4F5C;&#x6570;, padding</li>
<li>OpArgR, iABC &#x6A21;&#x5F0F;&#x4E0B;&#x8868;&#x793A;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;, iAsBx &#x6A21;&#x5F0F;&#x4E0B;&#x8868;&#x793A;&#x8DF3;&#x8F6C;&#x504F;&#x79FB;.</li>
<li>OpArgK, &#x5E38;&#x91CF;&#x8868;&#x7D22;&#x5F15;&#x6216;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;. &#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86; 9b &#x4E2D;&#x7684;&#x9AD8;&#x4F4D;&#x6765;&#x8BC6;&#x522B;&#x662F;&#x5E38;&#x91CF;&#x8868;&#x7D22;&#x5F15; (1) &#x8FD8;&#x662F;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15; (0).</li>
<li>OpArgU, &#x5E03;&#x5C14;&#x503C;, &#x6574;&#x6570;&#x503C;, upvalue &#x7D22;&#x5F15;, &#x5B50;&#x51FD;&#x6570;&#x7D22;&#x5F15;.</li>
</ul>
<h3 class="mume-header" id="324-%E6%8C%87%E4%BB%A4%E8%A1%A8">3.2.4 &#x6307;&#x4EE4;&#x8868;</h3>

<p>opcode &#x7ED3;&#x6784;&#x4F53;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> opcode <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	testFlag <span class="token builtin">byte</span> <span class="token comment">// operator is a test (next instruction must be a jump)</span>
	setAFlag <span class="token builtin">byte</span> <span class="token comment">// instruction set register A</span>
	argBMode <span class="token builtin">byte</span> <span class="token comment">// B arg mode</span>
	argCMode <span class="token builtin">byte</span> <span class="token comment">// C arg mode</span>
	opMode   <span class="token builtin">byte</span> <span class="token comment">// op mode</span>
	name     <span class="token builtin">string</span>
	action   <span class="token keyword">func</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm api<span class="token punctuation">.</span>LuaVM<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x7136;&#x540E;&#x6E90;&#x6587;&#x4EF6; <code>lua.go/vm/opcodes.go: var opcodes</code> &#x5B9A;&#x4E49;&#x4E86;&#x6240;&#x6709; opcode. &#x683C;&#x5F0F;&#x4F8B;&#x5982;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">//     T  A  B       C       mode  name      </span>
opcode<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> OpArgR<span class="token punctuation">,</span> OpArgN<span class="token punctuation">,</span> IABC<span class="token punctuation">,</span> <span class="token string">&quot;MOVE    &quot;</span><span class="token punctuation">}</span>
</pre><p>&#x5BF9;&#x5E94;&#x4E0A;&#x8FF0;&#x7ED3;&#x6784;&#x4F53;.</p>
<h2 class="mume-header" id="33-%E6%8C%87%E4%BB%A4%E8%A7%A3%E7%A0%81">3.3 &#x6307;&#x4EE4;&#x89E3;&#x7801;</h2>

<p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x4E86;&#x6309;&#x7167;&#x64CD;&#x4F5C;&#x6570;&#x6216;&#x64CD;&#x4F5C;&#x7801;&#x957F;&#x5EA6;&#x8FDB;&#x884C;&#x6309;&#x4F4D;&#x4E0E;&#x64CD;&#x4F5C;, &#x4EE5;&#x4FBF;&#x4ECE; 32bit &#x957F;&#x5EA6;&#x4E2D;&#x63D0;&#x53D6;&#x51FA;&#x6240;&#x9700;&#x957F;&#x5EA6;&#x7684;&#x503C;.</p>
<p>&#x5176;&#x4E2D; iAsBx &#x63D0;&#x53D6;&#x4F1A;&#x590D;&#x6742;&#x4E00;&#x4E9B;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>instr Instruction<span class="token punctuation">)</span> <span class="token function">ABx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> bx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>instr <span class="token operator">&gt;&gt;</span> <span class="token number">6</span> <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>
	bx <span class="token operator">=</span> <span class="token function">int</span><span class="token punctuation">(</span>instr <span class="token operator">&gt;&gt;</span> <span class="token number">14</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>instr Instruction<span class="token punctuation">)</span> <span class="token function">AsBx</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>a<span class="token punctuation">,</span> sbx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> bx <span class="token operator">:=</span> instr<span class="token punctuation">.</span><span class="token function">ABx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> a<span class="token punctuation">,</span> bx <span class="token operator">-</span> MAXARG_sBx
<span class="token punctuation">}</span>
</pre><p>&#x7528;&#x4E86; MAXARG_sBx &#x4F5C;&#x4E3A; padding &#x8FDB;&#x884C;&#x4F4D;&#x64CD;&#x4F5C;.</p>
<h2 class="mume-header" id="34-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">3.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>

<h1 class="mume-header" id="chapter-4-lua-api">Chapter 4, Lua API</h1>

<h2 class="mume-header" id="41-lua-api-%E4%BB%8B%E7%BB%8D">4.1 Lua API &#x4ECB;&#x7ECD;</h2>

<p>lua_State &#x5C01;&#x88C5;&#x4E86; lua &#x89E3;&#x91CA;&#x5668;.</p>
<h2 class="mume-header" id="41-lua-%E6%A0%88">4.1 Lua &#x6808;</h2>

<p>lua state &#x662F;&#x5BBF;&#x4E3B;&#x8BED;&#x8A00;&#x548C; lua &#x6C9F;&#x901A;&#x5F97;&#x6865;&#x6881;, Lua API &#x51FD;&#x6570;&#x5176;&#x4E2D;&#x6709;&#x5F88;&#x5927;ui&#x90E8;&#x5206;&#x662F;&#x4E13;&#x95E8;&#x7528;&#x6765;&#x64CD;&#x4F5C; Lua &#x6808;&#x7684;.</p>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD; lua state &#x6808;&#x91CC;&#x80FD;&#x591F;&#x5B58;&#x653E;&#x54EA;&#x4E9B;&#x503C;, &#x7136;&#x540E;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x6309;&#x7167;&#x7D22;&#x5F15;&#x6765;&#x5B58;&#x53D6;&#x8FD9;&#x4E9B;&#x503C;, &#x6700;&#x540E;&#x7F16;&#x7801;&#x5B9E;&#x73B0;.</p>
<h3 class="mume-header" id="421-lua-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%80%BC">4.2.1 Lua &#x6570;&#x636E;&#x7C7B;&#x578B;&#x548C;&#x503C;</h3>

<p>Lua &#x662F;&#x52A8;&#x6001;&#x7C7B;&#x578B;&#x8BED;&#x8A00;, &#x5728; Lua &#x4EE3;&#x7801;&#x91CC;, &#x53D8;&#x91CF;&#x662F;&#x4E0D;&#x643A;&#x5E26;&#x7C7B;&#x578B;&#x4FE1;&#x606F;&#x7684;, &#x53D8;&#x91CF;&#x7684;&#x503C;&#x624D;&#x643A;&#x5E26;&#x7C7B;&#x578B;&#x4FE1;&#x606F;.</p>
<p>Lua &#x5185;&#x7F6E;&#x4E86; 8 &#x79CD;&#x6570;&#x636E;&#x7C7B;&#x578B;:</p>
<pre data-role="codeBlock" data-info="lua" class="language-lua"><span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token keyword">nil</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                        <span class="token comment">-- nil</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment">-- boolean</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token number">3.14</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                       <span class="token comment">-- number</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token comment">-- string</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                         <span class="token comment">-- table</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">)</span>                      <span class="token comment">-- function</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>coroutine<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>print<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token comment">-- thread</span>
<span class="token function">print</span><span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>stdin<span class="token punctuation">)</span><span class="token punctuation">)</span>                   <span class="token comment">-- userdata</span>
</pre><p>&#x5B57;&#x7B26;&#x4E32;&#x662F;&#x7B80;&#x5355;&#x7684;&#x5B57;&#x8282;&#x6570;&#x7EC4;. &#x524D;&#x9762;&#x51E0;&#x79CD;&#x57FA;&#x672C;&#x7C7B;&#x578B;&#x4E5F;&#x53EF;&#x4EE5;&#x5F88;&#x65B9;&#x4FBF;&#x6620;&#x5C04;, &#x6620;&#x5C04;&#x8868;&#x5982;&#x4E0B;:</p>
<table>
<thead>
<tr>
<th>Lua &#x7C7B;&#x578B;</th>
<th>Go &#x7C7B;&#x578B;</th>
</tr>
</thead>
<tbody>
<tr>
<td>nil</td>
<td>nil</td>
</tr>
<tr>
<td>boolean</td>
<td>bool</td>
</tr>
<tr>
<td>integer</td>
<td>int64</td>
</tr>
<tr>
<td>float</td>
<td>float64</td>
</tr>
<tr>
<td>string</td>
<td>string</td>
</tr>
</tbody>
</table>
<p>&#x9996;&#x5148;&#x5B9A;&#x4E49;&#x7C7B;&#x578B;&#x5E38;&#x91CF;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/* basic types */</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	LUA_TNONE <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">// -1</span>
	LUA_TNIL
	LUA_TBOOLEAN
	LUA_TLIGHTUSERDATA
	LUA_TNUMBER
	LUA_TSTRING
	LUA_TTABLE
	LUA_TFUNCTION
	LUA_TUSERDATA
	LUA_TTHREAD
<span class="token punctuation">)</span>
</pre><p>&#x5176;&#x4E2D;&#x591A;&#x51FA;&#x6765;&#x7684; LUA_TNONE &#x7528;&#x4E8E;&#x9488;&#x5BF9;&#x6808;&#x7D22;&#x5F15;&#x7684;&#x65E0;&#x6548;&#x503C;.</p>
<p>&#x7136;&#x540E;&#x662F;&#x5BF9;&#x5E94;&#x7C7B;&#x578B;&#x7684;&#x503C;&#x7C7B;&#x578B; luaValue :</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> luaValue <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</pre><p>&#x5B9E;&#x73B0; typeOf(), &#x8FD9;&#x91CC;&#x5B9A;&#x4E49;&#x4E86; luaValue &#x91CC;&#x9762;&#x6709;&#x4E2A; type &#x5C5E;&#x6027;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">typeOf</span><span class="token punctuation">(</span>val luaValue<span class="token punctuation">)</span> LuaType <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TNIL
	<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TBOOLEAN
	<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TNUMBER
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TSTRING
	<span class="token keyword">case</span> <span class="token operator">*</span>luaTable<span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TTABLE
	<span class="token keyword">case</span> <span class="token operator">*</span>closure<span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TFUNCTION
	<span class="token keyword">case</span> <span class="token operator">*</span>luaState<span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TTHREAD
	<span class="token keyword">case</span> <span class="token operator">*</span>userdata<span class="token punctuation">:</span>
		<span class="token keyword">return</span> LUA_TUSERDATA
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;unknown type!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="422-%E6%A0%88%E7%B4%A2%E5%BC%95">4.2.2 &#x6808;&#x7D22;&#x5F15;</h3>

<p>&#x8FD9;&#x91CC;&#x63CF;&#x8FF0;&#x4E86; Lua &#x6808;&#x7684;&#x8BBE;&#x8BA1;:</p>
<ul>
<li>&#x7D22;&#x5F15;&#x4ECE; 1 &#x5F00;&#x59CB; (&#x5373;&#x6808;&#x5E95;&#x90E8;)</li>
<li>&#x6B63;&#x6570;&#x53EB;&#x7EDD;&#x5BF9;&#x7D22;&#x5F15;, &#x8D1F;&#x6570;&#x5219;&#x662F;&#x76F8;&#x5BF9;&#x7D22;&#x5F15;, &#x662F;&#x4ECE;&#x6808;&#x9876; (&#x5373; -1) &#x5F00;&#x59CB;&#x7684;&#x5411;&#x6808;&#x5E95;&#x65B9;&#x5411;&#x7684;&#x7D22;&#x5F15;, &#x5185;&#x90E8;&#x4F1A;&#x81EA;&#x52A8;&#x8F6C;&#x6362;&#x4E3A;&#x7EDD;&#x5BF9;&#x7D22;&#x5F15;.</li>
<li>&#x6709;&#x6548;&#x7D22;&#x5F15;&#x533A;&#x95F4;&#x53EF;&#x4EE5;&#x5199;&#x5165;, &#x65E0;&#x6548;&#x7D22;&#x5F15;&#x7A7A;&#x95F4; (&#x5FC5;&#x987B;&#x4F4D;&#x4E8E;&#x53EF;&#x63A5;&#x53D7;&#x7D22;&#x5F15;&#x5185;, &#x5373;&#x6808;&#x7684;&#x6574;&#x4F53;&#x957F;&#x5EA6;&#x5185;) &#x8BFB;&#x53D6;&#x4F1A;&#x8BFB;&#x53D6;&#x5230; nil.</li>
</ul>
<h3 class="mume-header" id="423-%E5%AE%9A%E4%B9%89-luastack-%E7%BB%93%E6%9E%84%E4%BD%93">4.2.3 &#x5B9A;&#x4E49; luaStack &#x7ED3;&#x6784;&#x4F53;</h3>

<p>luaStack &#x5B9E;&#x73B0;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> luaStack <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">/* virtual stack */</span>
	slots <span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue
	top   <span class="token builtin">int</span>
	<span class="token comment">/* call info */</span>
	state   <span class="token operator">*</span>luaState
	closure <span class="token operator">*</span>closure
	varargs <span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue
	openuvs <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span>upvalue
	pc      <span class="token builtin">int</span>
	<span class="token comment">/* linked list */</span>
	prev <span class="token operator">*</span>luaStack
<span class="token punctuation">}</span>
</pre><p>slots &#x5B58;&#x50A8;&#x503C;, &#x5373; luaValue. top &#x8BB0;&#x5F55;&#x6808;&#x9876;&#x7D22;&#x5F15;.</p>
<p>newLuaStack() &#x7528;&#x4E8E;&#x521B;&#x5EFA;&#x6307;&#x5B9A;&#x5BB9;&#x91CF;&#x7684;&#x6808;, &#x5B9E;&#x73B0;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">newLuaStack</span><span class="token punctuation">(</span>size <span class="token builtin">int</span><span class="token punctuation">,</span> state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token operator">*</span>luaStack <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>luaStack<span class="token punctuation">{</span>
		state<span class="token punctuation">:</span> state<span class="token punctuation">,</span>
		slots<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue<span class="token punctuation">,</span> size<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>check() &#x65B9;&#x6CD5;&#x68C0;&#x67E5;&#x6808;&#x7684;&#x7A7A;&#x95F2;&#x7A7A;&#x95F4;&#x662F;&#x5426;&#x8FD8;&#x53EF;&#x4EE5;&#x5BB9;&#x7EB3; n &#x4E2A;&#x503C;. &#x5982;&#x679C;&#x4E0D;&#x6EE1;&#x8DB3;&#x5219;&#x8FDB;&#x884C;&#x6269;&#x5BB9;. (&#x8FD9;&#x91CC;&#x603B;&#x611F;&#x89C9;&#x662F;&#x4E2A;&#x574F;&#x5473;&#x9053;? check &#x8FD8;&#x80FD;&#x6269;&#x5BB9;?)</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">check</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	free <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span>slots<span class="token punctuation">)</span> <span class="token operator">-</span> stack<span class="token punctuation">.</span>top
	<span class="token keyword">for</span> i <span class="token operator">:=</span> free<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		stack<span class="token punctuation">.</span>slots <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span>slots<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>push() &#x5C06;&#x503C;&#x538B;&#x5165;&#x6808;&#x9876;, &#x5982;&#x679C;&#x6EA2;&#x51FA;&#x5219; painc().</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">push</span><span class="token punctuation">(</span>val luaValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> stack<span class="token punctuation">.</span>top <span class="token operator">==</span> <span class="token function">len</span><span class="token punctuation">(</span>stack<span class="token punctuation">.</span>slots<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;stack overflow!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	stack<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>top<span class="token punctuation">]</span> <span class="token operator">=</span> val
	stack<span class="token punctuation">.</span>top<span class="token operator">++</span>
<span class="token punctuation">}</span>
</pre><p>pop() &#x5219;&#x5F39;&#x51FA;, &#x5982;&#x679C;&#x4E3A;&#x7A7A;&#x5219; painc().</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> luaValue <span class="token punctuation">{</span>
	<span class="token keyword">if</span> stack<span class="token punctuation">.</span>top <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;stack underflow!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	stack<span class="token punctuation">.</span>top<span class="token operator">--</span>
	val <span class="token operator">:=</span> stack<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>top<span class="token punctuation">]</span>
	stack<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>stack<span class="token punctuation">.</span>top<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token keyword">return</span> val
<span class="token punctuation">}</span>
</pre><p>absIndex() &#x5C06;&#x7D22;&#x5F15;&#x8F6C;&#x6362;&#x4E3A;&#x7EDD;&#x5BF9;&#x7D22;&#x5F15;.</p>
<ul>
<li>lua.go/api/luaconf.go</li>
</ul>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
@@ LUAI_MAXSTACK limits the size of the Lua stack.
** CHANGE it if you need a different limit. This limit is arbitrary;
** its only purpose is to stop Lua from consuming unlimited stack
** space (and to reserve some numbers for pseudo-indices).
*/</span>
<span class="token keyword">const</span> LUAI_MAXSTACK <span class="token operator">=</span> <span class="token number">1000000</span>
</pre><ul>
<li>lua.go/api/consts.go</li>
</ul>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
** Pseudo-indices
** (-LUAI_MAXSTACK is the minimum valid index; we keep some free empty
** space after that to help overflow detection)
 */</span>
<span class="token keyword">const</span> LUA_REGISTRYINDEX <span class="token operator">=</span> <span class="token operator">-</span>LUAI_MAXSTACK <span class="token operator">-</span> <span class="token number">1000</span>
</pre><p>&#x5373;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x6700;&#x5927;&#x8FBE;&#x5230; -LUAI_MAXSTACK - 1000 &#x7684;&#x533A;&#x95F4;&#x7528;&#x4E8E;&#x64CD;&#x4F5C; upvalue .</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">absIndex</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token comment">// zero or positive or pseudo</span>
	<span class="token keyword">if</span> idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">||</span> idx <span class="token operator">&lt;=</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span>
		<span class="token keyword">return</span> idx
	<span class="token punctuation">}</span>
	<span class="token comment">// negative</span>
	<span class="token keyword">return</span> idx <span class="token operator">+</span> stack<span class="token punctuation">.</span>top <span class="token operator">+</span> <span class="token number">1</span>
<span class="token punctuation">}</span>
</pre><p>isValid() &#x5224;&#x65AD;&#x7D22;&#x5F15;&#x662F;&#x5426;&#x6709;&#x6548;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">isValid</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> idx <span class="token operator">&lt;</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span> <span class="token comment">/* upvalues */</span>
		uvIdx <span class="token operator">:=</span> LUA_REGISTRYINDEX <span class="token operator">-</span> idx <span class="token operator">-</span> <span class="token number">1</span>
		c <span class="token operator">:=</span> stack<span class="token punctuation">.</span>closure
		<span class="token keyword">return</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> uvIdx <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>upvals<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> idx <span class="token operator">==</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	absIdx <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">absIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> absIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> absIdx <span class="token operator">&lt;=</span> stack<span class="token punctuation">.</span>top
<span class="token punctuation">}</span>
</pre><p>get() &#x4F9D;&#x636E;&#x7D22;&#x5F15;&#x4ECE;&#x6808;&#x53D6;&#x503C;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> luaValue <span class="token punctuation">{</span>
	<span class="token keyword">if</span> idx <span class="token operator">&lt;</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span> <span class="token comment">/* upvalues */</span>
		uvIdx <span class="token operator">:=</span> LUA_REGISTRYINDEX <span class="token operator">-</span> idx <span class="token operator">-</span> <span class="token number">1</span>
		c <span class="token operator">:=</span> stack<span class="token punctuation">.</span>closure
		<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">||</span> uvIdx <span class="token operator">&gt;=</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>upvals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token boolean">nil</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>upvals<span class="token punctuation">[</span>uvIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> idx <span class="token operator">==</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span>
		<span class="token keyword">return</span> stack<span class="token punctuation">.</span>state<span class="token punctuation">.</span>registry
	<span class="token punctuation">}</span>

	absIdx <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">absIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> absIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> absIdx <span class="token operator">&lt;=</span> stack<span class="token punctuation">.</span>top <span class="token punctuation">{</span>
		<span class="token keyword">return</span> stack<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>absIdx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</pre><p>set() &#x5199;&#x5165;&#x503C;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">set</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> val luaValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> idx <span class="token operator">&lt;</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span> <span class="token comment">/* upvalues */</span>
		uvIdx <span class="token operator">:=</span> LUA_REGISTRYINDEX <span class="token operator">-</span> idx <span class="token operator">-</span> <span class="token number">1</span>
		c <span class="token operator">:=</span> stack<span class="token punctuation">.</span>closure
		<span class="token keyword">if</span> c <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> uvIdx <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>upvals<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token operator">*</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>upvals<span class="token punctuation">[</span>uvIdx<span class="token punctuation">]</span><span class="token punctuation">.</span>val<span class="token punctuation">)</span> <span class="token operator">=</span> val
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> idx <span class="token operator">==</span> LUA_REGISTRYINDEX <span class="token punctuation">{</span>
		stack<span class="token punctuation">.</span>state<span class="token punctuation">.</span>registry <span class="token operator">=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>luaTable<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	absIdx <span class="token operator">:=</span> stack<span class="token punctuation">.</span><span class="token function">absIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> absIdx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> absIdx <span class="token operator">&lt;=</span> stack<span class="token punctuation">.</span>top <span class="token punctuation">{</span>
		stack<span class="token punctuation">.</span>slots<span class="token punctuation">[</span>absIdx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;invalid index!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</pre><h2 class="mume-header" id="43-lua-state">4.3 Lua State</h2>

<p>Lua State &#x5C01;&#x88C5;&#x4E86;&#x6574;&#x4E2A; Lua &#x89E3;&#x91CA;&#x5668;&#x72B6;&#x6001;.</p>
<h3 class="mume-header" id="431-%E5%AE%9A%E4%B9%89-luastate-%E6%8E%A5%E5%8F%A3">4.3.1 &#x5B9A;&#x4E49; LuaState &#x63A5;&#x53E3;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> LuaState <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	BasicAPI
	DebugAPI
	AuxLib
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// debug</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> BasicAPI <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token comment">/* state manipulation */</span>
	<span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment">//</span>
	<span class="token function">AtPanic</span><span class="token punctuation">(</span>panicf GoFunction<span class="token punctuation">)</span> GoFunction <span class="token comment">// set panic function</span>
	<span class="token function">Version</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">float64</span>                     <span class="token comment">// get version number</span>
	<span class="token comment">/* basic stack manipulation */</span>
	<span class="token function">GetTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>              <span class="token comment">// stack.top</span>
	<span class="token function">AbsIndex</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>     <span class="token comment">// abs(idx)</span>
	<span class="token function">UpvalueIndex</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token comment">//</span>
	<span class="token function">CheckStack</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>    <span class="token comment">//</span>
	<span class="token function">Pop</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span>                <span class="token comment">// pop(n)</span>
	<span class="token function">Copy</span><span class="token punctuation">(</span>fromIdx<span class="token punctuation">,</span> toIdx <span class="token builtin">int</span><span class="token punctuation">)</span>  <span class="token comment">// r[toIdx] = r[fromidx]</span>
	<span class="token function">PushValue</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>        <span class="token comment">// push(r[idx])</span>
	<span class="token function">Replace</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>          <span class="token comment">// r[idx] = pop()</span>
	<span class="token function">Insert</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>           <span class="token comment">// r[idx, -1] &gt;&gt; 1</span>
	<span class="token function">Remove</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>           <span class="token comment">// remove(r[idx])</span>
	<span class="token function">Rotate</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span>        <span class="token comment">// r[idx, -1] &gt;&gt; n</span>
	<span class="token function">SetTop</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>           <span class="token comment">// stack.top = idx</span>
	<span class="token function">XMove</span><span class="token punctuation">(</span>to LuaState<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// to.push(pop(n))</span>
	<span class="token comment">/* access functions (stack -&gt; C) */</span>
	<span class="token function">TypeName</span><span class="token punctuation">(</span>tp LuaType<span class="token punctuation">)</span> <span class="token builtin">string</span>        <span class="token comment">// r[idx].type.name</span>
	<span class="token function">Type</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> LuaType              <span class="token comment">// r[idx].type</span>
	<span class="token function">IsNone</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>               <span class="token comment">// r[idx].type == LUA_TNONE</span>
	<span class="token function">IsNil</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>                <span class="token comment">// r[idx].type == LUA_TNIL</span>
	<span class="token function">IsNoneOrNil</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>          <span class="token comment">// r[idx].type == LUA_TNONE || LUA_TNIL</span>
	<span class="token function">IsBoolean</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>            <span class="token comment">// r[idx].type == LUA_TBOOLEAN</span>
	<span class="token function">IsInteger</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>            <span class="token comment">// r[idx].type == LUA_TINTEGER</span>
	<span class="token function">IsNumber</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>             <span class="token comment">// r[idx] ~= LuaNumber</span>
	<span class="token function">IsString</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>             <span class="token comment">// r[idx] ~= LuaString</span>
	<span class="token function">IsTable</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>              <span class="token comment">// r[idx].type == LUA_TTABLE</span>
	<span class="token function">IsThread</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>             <span class="token comment">// r[idx].type == LUA_TTHREAD</span>
	<span class="token function">IsFunction</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>           <span class="token comment">// r[idx].type == LUA_TFUNCTION</span>
	<span class="token function">IsGoFunction</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>         <span class="token comment">// r[idx].type == LUA_TLCL || LUA_TGCL</span>
	<span class="token function">IsUserData</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>           <span class="token comment">// r[idx].type == LUA_TUSERDATA</span>
	<span class="token function">ToBoolean</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>            <span class="token comment">// r[idx] as bool</span>
	<span class="token function">ToInteger</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int64</span>           <span class="token comment">// r[idx] as LuaInteger</span>
	<span class="token function">ToIntegerX</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>  <span class="token comment">// r[idx] as LuaInteger</span>
	<span class="token function">ToNumber</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">float64</span>          <span class="token comment">// r[idx] as LuaNumber</span>
	<span class="token function">ToNumberX</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token comment">// r[idx] as LuaNumber</span>
	<span class="token function">ToString</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span>           <span class="token comment">// r[idx] as string</span>
	<span class="token function">ToStringX</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span>  <span class="token comment">// r[idx] as string</span>
	<span class="token function">ToGoFunction</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> GoFunction   <span class="token comment">// r[idx] as GoFunction</span>
	<span class="token function">ToThread</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> LuaState         <span class="token comment">// r[idx] as LuaThread</span>
	<span class="token function">ToUserData</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> UserData       <span class="token comment">// r[idx] as UserData</span>
	<span class="token function">ToPointer</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span>     <span class="token comment">// r[idx] as interface{}</span>
	<span class="token function">RawLen</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">uint</span>               <span class="token comment">// len(r[idx])</span>
	<span class="token comment">/* push functions (C -&gt; stack) */</span>
	<span class="token function">PushNil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                        <span class="token comment">// push(nil)</span>
	<span class="token function">PushBoolean</span><span class="token punctuation">(</span>b <span class="token builtin">bool</span><span class="token punctuation">)</span>                              <span class="token comment">// push(b)</span>
	<span class="token function">PushInteger</span><span class="token punctuation">(</span>n <span class="token builtin">int64</span><span class="token punctuation">)</span>                             <span class="token comment">// push(n)</span>
	<span class="token function">PushNumber</span><span class="token punctuation">(</span>n <span class="token builtin">float64</span><span class="token punctuation">)</span>                            <span class="token comment">// push(n)</span>
	<span class="token function">PushString</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span>                             <span class="token comment">// push(s)</span>
	<span class="token function">PushFString</span><span class="token punctuation">(</span>fmt <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// push(fmt*a)</span>
	<span class="token function">PushGoFunction</span><span class="token punctuation">(</span>f GoFunction<span class="token punctuation">)</span>                     <span class="token comment">// push(f)</span>
	<span class="token function">PushGoClosure</span><span class="token punctuation">(</span>f GoFunction<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span>               <span class="token comment">// push(f)</span>
	<span class="token function">PushLightUserData</span><span class="token punctuation">(</span>d UserData<span class="token punctuation">)</span>                    <span class="token comment">// push(d)</span>
	<span class="token function">PushGlobalTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                <span class="token comment">// push(global)</span>
	<span class="token function">PushThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>                                <span class="token comment">// push(thread)</span>
	<span class="token comment">/* Comparison and arithmetic functions */</span>
	<span class="token function">Arith</span><span class="token punctuation">(</span>op ArithOp<span class="token punctuation">)</span>                          <span class="token comment">// b=pop(); a=pop(); push(a op b)</span>
	<span class="token function">Compare</span><span class="token punctuation">(</span>idx1<span class="token punctuation">,</span> idx2 <span class="token builtin">int</span><span class="token punctuation">,</span> op CompareOp<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// r[idx1] op r[idx2]</span>
	<span class="token function">RawEqual</span><span class="token punctuation">(</span>idx1<span class="token punctuation">,</span> idx2 <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>              <span class="token comment">// r[idx1] == r[idx2]</span>
	<span class="token comment">/* get functions (Lua -&gt; stack) */</span>
	<span class="token function">NewTable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment">// push({})</span>
	<span class="token function">CreateTable</span><span class="token punctuation">(</span>nArr<span class="token punctuation">,</span> nRec <span class="token builtin">int</span><span class="token punctuation">)</span>          <span class="token comment">// push({})</span>
	<span class="token function">GetTable</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> LuaType            <span class="token comment">// push(r[idx][pop()])</span>
	<span class="token function">GetField</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> k <span class="token builtin">string</span><span class="token punctuation">)</span> LuaType  <span class="token comment">// push(r[idx][k])</span>
	<span class="token function">GetI</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> i <span class="token builtin">int64</span><span class="token punctuation">)</span> LuaType       <span class="token comment">// push(r[idx][i])</span>
	<span class="token function">RawGet</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> LuaType              <span class="token comment">// push(r[idx][pop()])</span>
	<span class="token function">RawGetI</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> i <span class="token builtin">int64</span><span class="token punctuation">)</span> LuaType    <span class="token comment">// push(r[idx][i])</span>
	<span class="token function">RawGetP</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> p UserData<span class="token punctuation">)</span> LuaType <span class="token comment">// push(r[idx][p])</span>
	<span class="token function">GetGlobal</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> LuaType       <span class="token comment">// push(global[name])</span>
	<span class="token function">GetMetatable</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>           <span class="token comment">// push(r[idx].metatable)?</span>
	<span class="token function">GetUserValue</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> LuaType        <span class="token comment">// push(r[idx].userValue)</span>
	<span class="token comment">/* set functions (stack -&gt; Lua) */</span>
	<span class="token function">SetTable</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>                   <span class="token comment">// v=pop(); k=pop(); r[idx][k] = v</span>
	<span class="token function">SetField</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> k <span class="token builtin">string</span><span class="token punctuation">)</span>         <span class="token comment">// r[idx][k] = pop()</span>
	<span class="token function">SetI</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> i <span class="token builtin">int64</span><span class="token punctuation">)</span>              <span class="token comment">// r[idx][i] = pop()</span>
	<span class="token function">RawSet</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>                     <span class="token comment">// v=pop(); k=pop(); r[idx][k] = v</span>
	<span class="token function">RawSetI</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> i <span class="token builtin">int64</span><span class="token punctuation">)</span>           <span class="token comment">// r[idx][i] = pop()</span>
	<span class="token function">RawSetP</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">,</span> p UserData<span class="token punctuation">)</span>        <span class="token comment">// r[idx][p] = pop()</span>
	<span class="token function">Register</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> f GoFunction<span class="token punctuation">)</span> <span class="token comment">// global[name] = f</span>
	<span class="token function">SetGlobal</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span>              <span class="token comment">// global[name] = pop()</span>
	<span class="token function">SetMetatable</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>               <span class="token comment">// r[idx].metatable = pop()</span>
	<span class="token function">SetUserValue</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>               <span class="token comment">// r[idx].userValue = pop()</span>
	<span class="token comment">/* &apos;load&apos; and &apos;call&apos; functions (load and run Lua code) */</span>
	<span class="token function">Dump</span><span class="token punctuation">(</span>strip <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>                                 <span class="token comment">// todo</span>
	<span class="token function">Load</span><span class="token punctuation">(</span>chunk <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> chunkName<span class="token punctuation">,</span> mode <span class="token builtin">string</span><span class="token punctuation">)</span> ThreadStatus <span class="token comment">// push(compile(chunk))</span>
	<span class="token function">Call</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> nResults <span class="token builtin">int</span><span class="token punctuation">)</span>                               <span class="token comment">// args=pop(nArgs); f=pop(); f(args)</span>
	<span class="token function">CallK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                 <span class="token comment">//</span>
	<span class="token function">PCall</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> nResults<span class="token punctuation">,</span> msgh <span class="token builtin">int</span><span class="token punctuation">)</span> ThreadStatus           <span class="token comment">// call(nArgs, nResults) || push(err)</span>
	<span class="token function">PCallK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                                <span class="token comment">//</span>
	<span class="token comment">/* miscellaneous functions */</span>
	<span class="token function">Concat</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span>                 <span class="token comment">// push(concat(pop(n)))</span>
	<span class="token function">Len</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>                  <span class="token comment">// push(len(r[idx]))</span>
	<span class="token function">Next</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>            <span class="token comment">// key=pop(); k,v=next(r[idx]); push(k,v);</span>
	<span class="token function">StringToNumber</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// push(number(s))</span>
	<span class="token function">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>                   <span class="token comment">// panic(r[-1])</span>
	<span class="token comment">/* coroutine functions */</span>
	<span class="token function">NewThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> LuaState                          <span class="token comment">// todo</span>
	<span class="token function">Resume</span><span class="token punctuation">(</span>from LuaState<span class="token punctuation">,</span> nArgs <span class="token builtin">int</span><span class="token punctuation">)</span> ThreadStatus <span class="token comment">// todo</span>
	<span class="token function">Yield</span><span class="token punctuation">(</span>nResults <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span>                       <span class="token comment">// todo</span>
	<span class="token function">YieldK</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                                      <span class="token comment">// todo</span>
	<span class="token function">Status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> ThreadStatus                         <span class="token comment">// todo</span>
	<span class="token function">IsYieldable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">bool</span>                            <span class="token comment">// todo</span>
	<span class="token comment">/* garbage-collection function and options */</span>
	<span class="token function">GC</span><span class="token punctuation">(</span>what<span class="token punctuation">,</span> data <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token comment">//</span>
<span class="token punctuation">}</span>

</pre><h3 class="mume-header" id="432-%E5%AE%9A%E4%B9%89-luastate-%E7%BB%93%E6%9E%84%E4%BD%93">4.3.2 &#x5B9A;&#x4E49; luaState &#x7ED3;&#x6784;&#x4F53;</h3>

<p>&#x5B9E;&#x73B0; luaState</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> luaState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">/* global state */</span>
	hook     LuaHook
	hookMask <span class="token builtin">int</span>
	panicf   GoFunction
	registry <span class="token operator">*</span>luaTable
	<span class="token comment">/* stack */</span>
	stack     <span class="token operator">*</span>luaStack
	callDepth <span class="token builtin">int</span>
	<span class="token comment">/* coroutine */</span>
	coStatus ThreadStatus
	coCaller <span class="token operator">*</span>luaState
	coChan   <span class="token keyword">chan</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</pre><p>New() &#x521B;&#x5EFA; luaState().</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> LuaState <span class="token punctuation">{</span>
	ls <span class="token operator">:=</span> <span class="token operator">&amp;</span>luaState<span class="token punctuation">{</span><span class="token punctuation">}</span>

	registry <span class="token operator">:=</span> <span class="token function">newLuaTable</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	registry<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>LUA_RIDX_MAINTHREAD<span class="token punctuation">,</span> ls<span class="token punctuation">)</span>
	registry<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>LUA_RIDX_GLOBALS<span class="token punctuation">,</span> <span class="token function">newLuaTable</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	ls<span class="token punctuation">.</span>registry <span class="token operator">=</span> registry
	ls<span class="token punctuation">.</span><span class="token function">pushLuaStack</span><span class="token punctuation">(</span><span class="token function">newLuaStack</span><span class="token punctuation">(</span>LUA_MINSTACK<span class="token punctuation">,</span> ls<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ls
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="433-%E5%9F%BA%E7%A1%80%E6%A0%88%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95">4.3.3 &#x57FA;&#x7840;&#x6808;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;</h3>

<p>GetTop() &#x53CD;&#x83B7;&#x6808;&#x9876;&#x7D22;&#x5F15;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_gettop</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_gettop()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">GetTop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>top
<span class="token punctuation">}</span>
</pre><p>AbsIndex() &#x628A;&#x7D22;&#x5F15;&#x8F6C;&#x6362;&#x4E3A;&#x7EDD;&#x5BF9;&#x7D22;&#x5F15;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_absindex</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_absindex()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">AbsIndex</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">absIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>CheckStack() &#x8FDB;&#x884C;&#x68C0;&#x67E5;&#x5982;&#x679C;&#x4E0D;&#x8DB3;&#x5219;&#x6269;&#x5BB9;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_checkstack</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_checkstack()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">CheckStack</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token boolean">true</span> <span class="token comment">// never fails</span>
<span class="token punctuation">}</span>
</pre><p>Pop() &#x4ECE;&#x6808;&#x9876;&#x5F39;&#x51FA; n &#x4E2A;&#x503C;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-n, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pop</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_pop()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Pop</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Copy() &#x628A;&#x503C;&#x4ECE;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#x590D;&#x5236;&#x5230;&#x53E6;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E; (&#x6808;&#x5185;&#x590D;&#x5236;).</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_copy</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_copy()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Copy</span><span class="token punctuation">(</span>fromIdx<span class="token punctuation">,</span> toIdx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fromIdx<span class="token punctuation">)</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>toIdx<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>PushValue() &#x628A;&#x6307;&#x5B9A;&#x7D22;&#x5F15;&#x5904;&#x7684;&#x503C;&#x63A8;&#x5165;&#x6808;&#x9876;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushvalue</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_pushvalue()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushValue</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Replace() &#x662F; PushValue() &#x7684;&#x53CD;&#x64CD;&#x4F5C;, &#x5C06;&#x6808;&#x9876;&#x503C;&#x5F39;&#x51FA;&#x5E76;&#x5199;&#x5165;&#x6307;&#x5B9A;&#x4F4D;&#x7F6E;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-1, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_replace</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_replace()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Replace</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Insert() &#x5C06;&#x6808;&#x9876;&#x503C;&#x5F39;&#x51FA;, &#x5E76;&#x63D2;&#x5165;&#x6307;&#x5B9A;&#x4F4D;&#x7F6E;. &#x662F; Rotate() &#x7684;&#x4E00;&#x4E2A;&#x7279;&#x4F8B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-1, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_insert</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_insert()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Insert</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span><span class="token function">Rotate</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Remove() &#x5220;&#x9664;&#x6307;&#x5B9A;&#x7D22;&#x5F15;&#x5904;&#x7684;&#x503C;. &#x53EF;&#x4EE5;&#x7528; Rotate() &#x7EC4;&#x5408; Pop() &#x5B9E;&#x73B0;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-1, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_remove</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_remove()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Remove</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span><span class="token function">Rotate</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	state<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>Rotate() &#x65B9;&#x6CD5;&#x5C06; [idx, top] &#x7D22;&#x5F15;&#x533A;&#x95F4;&#x5185;&#x7684;&#x503C;&#x671D;&#x6808;&#x9876;&#x65B9;&#x5411;&#x65CB;&#x8F6C; n &#x4E2A;&#x4F4D;&#x7F6E;, &#x5982;&#x679C; n &#x662F;&#x8D1F;&#x6570;, &#x90A3;&#x4E48;&#x671D;&#x6808;&#x5E95;&#x65B9;&#x5411;&#x65CB;&#x8F6C;. &#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x5C65;&#x5E26;&#x5F0F;&#x6EDA;&#x52A8;&#x4F4D;&#x7F6E;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_rotate</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_rotate()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Rotate</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>top <span class="token operator">-</span> <span class="token number">1</span>           <span class="token comment">/* end of stack segment being rotated */</span>
	p <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">absIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span> <span class="token comment">/* start of segment */</span>
	<span class="token keyword">var</span> m <span class="token builtin">int</span>                          <span class="token comment">/* end of prefix */</span>
	<span class="token keyword">if</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		m <span class="token operator">=</span> t <span class="token operator">-</span> n
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		m <span class="token operator">=</span> p <span class="token operator">-</span> n <span class="token operator">-</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> m<span class="token punctuation">)</span>   <span class="token comment">/* reverse the prefix with length &apos;n&apos; */</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>m<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token comment">/* reverse the suffix */</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">reverse</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> t<span class="token punctuation">)</span>   <span class="token comment">/* reverse the entire segment */</span>
<span class="token punctuation">}</span>
</pre><p>Reverse() &#x5B9E;&#x73B0;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token function">reverse</span><span class="token punctuation">(</span>from<span class="token punctuation">,</span> to <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	slots <span class="token operator">:=</span> stack<span class="token punctuation">.</span>slots
	<span class="token keyword">for</span> from <span class="token operator">&lt;</span> to <span class="token punctuation">{</span>
		slots<span class="token punctuation">[</span>from<span class="token punctuation">]</span><span class="token punctuation">,</span> slots<span class="token punctuation">[</span>to<span class="token punctuation">]</span> <span class="token operator">=</span> slots<span class="token punctuation">[</span>to<span class="token punctuation">]</span><span class="token punctuation">,</span> slots<span class="token punctuation">[</span>from<span class="token punctuation">]</span>
		from<span class="token operator">++</span>
		to<span class="token operator">--</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>SetTop() &#x5C06;&#x6808;&#x9876;&#x7D22;&#x5F15;&#x8BBE;&#x7F6E;&#x4E3A;&#x6307;&#x5B9A;&#x503C;. &#x5982;&#x679C;&#x6307;&#x5B9A;&#x503C;&#x5C0F;&#x4E8E;&#x5F53;&#x524D;&#x6808;&#x9876;&#x7D22;&#x5F15;, &#x6548;&#x679C;&#x5219;&#x76F8;&#x5F53;&#x4E8E;&#x5F39;&#x51FA; (&#x6307;&#x5B9A;&#x4E3A; 0 &#x5219;&#x662F;&#x6E05;&#x7A7A;). &#x5982;&#x679C;&#x5927;&#x4E8E;&#x5F53;&#x524D;&#x6808;&#x9876;&#x7D22;&#x5F15;, &#x5219;&#x76F8;&#x5F53;&#x4E8E;&#x63D2;&#x5165; nil.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-?, +?, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_settop</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_settop()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">SetTop</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	newTop <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">absIndex</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> newTop <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;stack underflow!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	n <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>top <span class="token operator">-</span> newTop
	<span class="token keyword">if</span> n <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&gt;</span> n<span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="434-push-%E6%96%B9%E6%B3%95">4.3.4 Push &#x65B9;&#x6CD5;</h3>

<p>&#x8FD9;&#x91CC;&#x7684; Push() &#x65B9;&#x6CD5;&#x5C06;&#x5916;&#x90E8;&#x503C;&#x63A8;&#x5165;&#x6808;&#x9876;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushnil</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushNil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushboolean</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushBoolean</span><span class="token punctuation">(</span>b <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushinteger</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushInteger</span><span class="token punctuation">(</span>n <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushnumber</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushNumber</span><span class="token punctuation">(</span>n <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +1, m]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushstring</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushString</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +1, e]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_pushfstring</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">PushFString</span><span class="token punctuation">(</span>fmtStr <span class="token builtin">string</span><span class="token punctuation">,</span> a <span class="token operator">...</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	str <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span>fmtStr<span class="token punctuation">,</span> a<span class="token operator">...</span><span class="token punctuation">)</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	<span class="token keyword">return</span> str
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="435-access-%E6%96%B9%E6%B3%95">4.3.5 Access &#x65B9;&#x6CD5;</h3>

<p>Access &#x7CFB;&#x5217;&#x65B9;&#x6CD5;&#x7528;&#x4E8E;&#x4ECE;&#x6808;&#x91CC;&#x83B7;&#x53D6;&#x4FE1;&#x606F;.</p>
<p>TypeName() &#x83B7;&#x53D6;&#x7C7B;&#x578B;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x540D;&#x79F0;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_typename</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_typename()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">TypeName</span><span class="token punctuation">(</span>tp LuaType<span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> tp <span class="token punctuation">{</span>
	<span class="token keyword">case</span> LUA_TNONE<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;no value&quot;</span>
	<span class="token keyword">case</span> LUA_TNIL<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;nil&quot;</span>
	<span class="token keyword">case</span> LUA_TBOOLEAN<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;boolean&quot;</span>
	<span class="token keyword">case</span> LUA_TNUMBER<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;number&quot;</span>
	<span class="token keyword">case</span> LUA_TSTRING<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;string&quot;</span>
	<span class="token keyword">case</span> LUA_TTABLE<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;table&quot;</span>
	<span class="token keyword">case</span> LUA_TFUNCTION<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;function&quot;</span>
	<span class="token keyword">case</span> LUA_TUSERDATA<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;userdata&quot;</span>
	<span class="token keyword">case</span> LUA_TTHREAD<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;thread&quot;</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;unreachable!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>Type() &#x6839;&#x636E;&#x7D22;&#x5F15;&#x53CD;&#x83B7;&#x503C;&#x7684;&#x7C7B;&#x578B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_type</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_type()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Type</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> LuaType <span class="token punctuation">{</span>
	<span class="token keyword">if</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">typeOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> LUA_TNONE
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>IsType, IsNone, IsNil, IsNoneOrNil, IsBoolean.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isnone</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_isnone()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsNone</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TNONE
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isnil</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_isnil()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsNil</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TNIL
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isnoneornil</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_isnoneornil()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsNoneOrNil</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">0</span>
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isboolean</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_isboolean()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsBoolean</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TBOOLEAN
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isstring</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_isstring()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsString</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> t <span class="token operator">==</span> LUA_TSTRING <span class="token operator">||</span> t <span class="token operator">==</span> LUA_TNUMBER
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isnumber</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_isnumber()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsNumber</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">ToNumberX</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> ok
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_isinteger</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_isinteger()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">IsInteger</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> ok
<span class="token punctuation">}</span>
</pre><p>ToBoolean() &#x4ECE;&#x6307;&#x5B9A;&#x7D22;&#x5F15;&#x5904;&#x53D6;&#x51FA;&#x4E00;&#x4E2A;&#x5E03;&#x5C14;&#x503C;, &#x5982;&#x679C;&#x4E0D;&#x662F;&#x5E03;&#x5C14;&#x7C7B;&#x578B;, &#x5219;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_toboolean</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToBoolean</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">convertToBoolean</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>convertToBoolean():</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">convertToBoolean</span><span class="token punctuation">(</span>val luaValue<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> x <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> x
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>ToNumber &#x548C; ToNumberX, &#x4ECE;&#x6307;&#x5B9A;&#x7D22;&#x5F15;&#x5904;&#x53D6;&#x51FA;&#x4E00;&#x4E2A;&#x6570;&#x5B57;. &#x5982;&#x679C;&#x4E0D;&#x662F;&#x6570;&#x5B57;&#x7C7B;&#x578B;&#x5219;&#x8FDB;&#x884C;&#x7C7B;&#x578B;&#x8F6C;&#x6362;. &#x8F6C;&#x6362;&#x5931;&#x8D25;&#x65F6;, ToNumber &#x8FD4;&#x56DE; 0, ToNumberX &#x8FD4;&#x56DE;&#x662F;&#x5426;&#x6210;&#x529F;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_tonumber</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToNumber</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	n<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">ToNumberX</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> n
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_tonumberx</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToNumberX</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">convertToFloat</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>ToInteger, ToIntegerX</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_tointeger</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToInteger</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	i<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">ToIntegerX</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>

<span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_tointegerx</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToIntegerX</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token function">convertToInteger</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>ToString, ToStringX &#x540C;&#x6837;, &#x4E0D;&#x8FC7;&#x8BE5;&#x51FD;&#x6570;&#x4F1A;&#x4FEE;&#x6539;&#x6808;. &#x5C06;&#x975E; string &#x8F6C;&#x6362;&#x4E3A; string.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, m]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_tostring</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_tolstring</span>
<span class="token comment">// lua-5.3.4/src/lua.h#lua_tostring()</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_tolstring()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToString</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	s<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">ToStringX</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">ToStringX</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>

	<span class="token keyword">switch</span> x <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> x<span class="token punctuation">,</span> <span class="token boolean">true</span>
	<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
		s <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Sprintf</span><span class="token punctuation">(</span><span class="token string">&quot;%v&quot;</span><span class="token punctuation">,</span> x<span class="token punctuation">)</span> <span class="token comment">// todo</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>idx<span class="token punctuation">,</span> s<span class="token punctuation">)</span>   <span class="token comment">// &#x8FD9;&#x91CC;&#x4F1A;&#x4FEE;&#x6539;&#x6808;</span>
		<span class="token keyword">return</span> s<span class="token punctuation">,</span> <span class="token boolean">true</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="44-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">4.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>

<h2 class="mume-header" id="45-%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93">4.5 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>

<h1 class="mume-header" id="chapter-5-lua-%E8%BF%90%E7%AE%97%E7%AC%A6">Chapter 5, Lua &#x8FD0;&#x7B97;&#x7B26;</h1>

<p>&#x53EF;&#x5206;&#x4E3A;&#x7B97;&#x672F; (Arithmetic) &#x8FD0;&#x7B97;&#x7B26;, &#x6309;&#x4F4D; (Bitwise) &#x8FD0;&#x7B97;&#x7B26;, &#x6BD4;&#x8F83; (Comparison) &#x8FD0;&#x7B97;&#x7B26;, &#x903B;&#x8F91; (Logical) &#x8FD0;&#x7B97;&#x7B26;, &#x957F;&#x5EA6;&#x8FD0;&#x7B97;&#x7B26;, &#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FD0;&#x7B97;&#x7B26;.</p>
<h2 class="mume-header" id="51-lua-%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BB%8B%E7%BB%8D">5.1 Lua &#x8FD0;&#x7B97;&#x7B26;&#x4ECB;&#x7ECD;</h2>

<h4 class="mume-header" id="1-%E7%AE%97%E6%95%B0%E8%BF%90%E7%AE%97%E7%AC%A6">1. &#x7B97;&#x6570;&#x8FD0;&#x7B97;&#x7B26;</h4>

<p>&#x9700;&#x8981;&#x8003;&#x8651;&#x7684;&#x95EE;&#x9898;&#x6709;:</p>
<ul>
<li>&#x7C7B;&#x578B;&#x8F6C;&#x6362;</li>
<li>&#x5546;&#x7684;&#x53D6;&#x6574;&#x65B9;&#x5F0F;</li>
<li>&#x5411;&#x53F3;&#x7ED3;&#x5408;</li>
</ul>
<p>&#x5177;&#x4F53;&#x5B9E;&#x73B0;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">package</span> number

<span class="token keyword">import</span> <span class="token string">&quot;math&quot;</span>

<span class="token keyword">func</span> <span class="token function">FloatToInteger</span><span class="token punctuation">(</span>f <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// todo: correct?</span>
	i <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">return</span> i<span class="token punctuation">,</span> <span class="token function">float64</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">==</span> f
<span class="token punctuation">}</span>

<span class="token comment">// a % b == a - ((a // b) * b)</span>
<span class="token keyword">func</span> <span class="token function">IMod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> a <span class="token operator">-</span> <span class="token function">IFloorDiv</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span><span class="token operator">*</span>b
<span class="token punctuation">}</span>

<span class="token comment">// a % b == a - ((a // b) * b)</span>
<span class="token comment">// lua-5.3.4/src/llimits.h#luai_nummod</span>
<span class="token keyword">func</span> <span class="token function">FMod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> a <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> math<span class="token punctuation">.</span><span class="token function">IsInf</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> a <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> math<span class="token punctuation">.</span><span class="token function">IsInf</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> a
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> a <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> math<span class="token punctuation">.</span><span class="token function">IsInf</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">||</span> a <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> math<span class="token punctuation">.</span><span class="token function">IsInf</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> b
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> a <span class="token operator">-</span> math<span class="token punctuation">.</span><span class="token function">Floor</span><span class="token punctuation">(</span>a<span class="token operator">/</span>b<span class="token punctuation">)</span><span class="token operator">*</span>b
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">IFloorDiv</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> a <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> a <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> b <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> a<span class="token operator">%</span>b <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> a <span class="token operator">/</span> b
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> a<span class="token operator">/</span>b <span class="token operator">-</span> <span class="token number">1</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">FFloorDiv</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> math<span class="token punctuation">.</span><span class="token function">Floor</span><span class="token punctuation">(</span>a <span class="token operator">/</span> b<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ShiftLeft</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> a <span class="token operator">&lt;&lt;</span> n
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">ShiftRight</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">-</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ShiftRight</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> n <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">uint64</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">ShiftLeft</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token operator">-</span>n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><h4 class="mume-header" id="2-%E6%8C%89%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6">2. &#x6309;&#x4F4D;&#x8FD0;&#x7B97;&#x7B26;</h4>

<p>&#x540C;&#x4E0A;, &#x5176;&#x4E2D;&#x5DE6;&#x79FB;&#x548C;&#x53F3;&#x79FB;&#x9700;&#x8981;&#x7279;&#x6B8A;&#x5904;&#x7406;.</p>
<h4 class="mume-header" id="3-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6">3. &#x6BD4;&#x8F83;&#x8FD0;&#x7B97;&#x7B26;</h4>

<p>&#x5B9E;&#x73B0; <code>==, &lt;, &lt;=</code> &#x540E;, &#x5C31;&#x53EF;&#x4EE5;&#x505A;&#x7B49;&#x4EF7;&#x8FD0;&#x7B97;&#x4E86;.</p>
<h4 class="mume-header" id="4-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6">4. &#x903B;&#x8F91;&#x8FD0;&#x7B97;&#x7B26;</h4>

<p>Lua &#x5BF9;&#x903B;&#x8F91;&#x4E0E;&#x548C;&#x903B;&#x8F91;&#x6216;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x77ED;&#x8DEF;&#x6C42;&#x503C;.</p>
<h4 class="mume-header" id="5-%E9%95%BF%E5%BA%A6%E8%BF%90%E7%AE%97%E7%AC%A6">5. &#x957F;&#x5EA6;&#x8FD0;&#x7B97;&#x7B26;</h4>

<p>&#x5373; <code>#</code>.</p>
<h4 class="mume-header" id="6-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E8%BF%90%E7%AE%97%E7%AC%A6">6. &#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FD0;&#x7B97;&#x7B26;</h4>

<p>&#x5373; <code>..</code>.</p>
<h2 class="mume-header" id="52-%E7%B1%BB%E5%9E%8B%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">5.2 &#x7C7B;&#x578B;&#x81EA;&#x52A8;&#x8F6C;&#x6362;</h2>

<h4 class="mume-header" id="1-%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99">1. &#x8F6C;&#x6362;&#x89C4;&#x5219;</h4>

<ul>
<li>&#x4EFB;&#x4F55;&#x7C7B;&#x578B;&#x90FD;&#x53EF;&#x4EE5;&#x8F6C;&#x6362;&#x4E3A; boolean</li>
<li>&#x7B97;&#x672F;&#x8FD0;&#x7B97;&#x7B26;, &#x4E3B;&#x8981;&#x662F;&#x8F6C;&#x6D6E;&#x70B9;&#x95EE;&#x9898;</li>
<li>&#x6309;&#x4F4D;&#x8FD0;&#x7B97;&#x7B26;, &#x4ECD;&#x7136;&#x662F;&#x6574;&#x6570;&#x548C;&#x6D6E;&#x70B9;&#x6570;&#x95EE;&#x9898;</li>
<li>&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FD0;&#x7B97;&#x7B26;, &#x5982;&#x679C;&#x4E0D;&#x662F;&#x5B57;&#x7B26;&#x4E32;, &#x9700;&#x8981;&#x8F6C;&#x6210;&#x5B57;&#x7B26;&#x4E32;</li>
<li>&#x8F6C;&#x4E0D;&#x4E86;&#x7684;&#x8FD8;&#x4F1A;&#x6302;&#x6389;, &#x6BD4;&#x5982; <code>print(3.14 &gt;&gt; 2)</code></li>
</ul>
<h4 class="mume-header" id="2-%E6%B5%AE%E7%82%B9%E6%95%B0%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E6%95%B0">2. &#x6D6E;&#x70B9;&#x6570;&#x8F6C;&#x6362;&#x4E3A;&#x6574;&#x6570;</h4>

<p>&#x76F4;&#x63A5;&#x8F6C;&#x6362;.</p>
<h4 class="mume-header" id="3-%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E4%B8%BA%E6%95%B0%E5%AD%97">3. &#x5B57;&#x7B26;&#x4E32;&#x89E3;&#x6790;&#x4E3A;&#x6570;&#x5B57;</h4>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">ParseInteger</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	str <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	str <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>

	<span class="token keyword">if</span> <span class="token operator">!</span>reInteger<span class="token punctuation">.</span><span class="token function">MatchString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// float?</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&apos;+&apos;</span> <span class="token punctuation">{</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;0x&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// decimal</span>
		i<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> i<span class="token punctuation">,</span> err <span class="token operator">==</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// hex</span>
	<span class="token keyword">var</span> sign <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">if</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&apos;-&apos;</span> <span class="token punctuation">{</span>
		sign <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">16</span> <span class="token punctuation">{</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span> <span class="token comment">// cut long hex string</span>
	<span class="token punctuation">}</span>

	i<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseUint</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> sign <span class="token operator">*</span> <span class="token function">int64</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> err <span class="token operator">==</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">ParseFloat</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	str <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">TrimSpace</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	str <span class="token operator">=</span> strings<span class="token punctuation">.</span><span class="token function">ToLower</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;nan&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> strings<span class="token punctuation">.</span><span class="token function">Contains</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;inf&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;0x&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">parseHexFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;+0x&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">parseHexFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;-0x&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">3</span> <span class="token punctuation">{</span>
		f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">parseHexFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span>f<span class="token punctuation">,</span> ok
	<span class="token punctuation">}</span>
	f<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token number">64</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> f<span class="token punctuation">,</span> err <span class="token operator">==</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</pre><p>&#x76EE;&#x524D;&#x5B9E;&#x73B0;&#x8FD8;&#x6CA1;&#x8FD9;&#x4E48;&#x590D;&#x6742;, &#x76F4;&#x63A5;&#x7528;&#x7684; Go &#x5185;&#x7F6E;&#x7684;&#x8F6C;&#x6362;.</p>
<h4 class="mume-header" id="4-%E4%BB%BB%E6%84%8F%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%B5%AE%E7%82%B9%E6%95%B0">4. &#x4EFB;&#x610F;&#x503C;&#x8F6C;&#x6362;&#x4E3A;&#x6D6E;&#x70B9;&#x6570;</h4>

<h4 class="mume-header" id="5-%E4%BB%BB%E6%84%8F%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E6%95%B0">5. &#x4EFB;&#x610F;&#x503C;&#x8F6C;&#x6362;&#x4E3A;&#x6574;&#x6570;</h4>

<p>&#x8FD9;&#x4E24;&#x4E2A;&#x4E00;&#x6837;, &#x90FD;&#x662F;&#x5148;&#x5224;&#x65AD;&#x7C7B;&#x578B;, &#x6570;&#x5B57;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x8FDB;&#x884C;&#x8F6C;&#x6362;, &#x5B57;&#x7B26;&#x4E32;&#x5C1D;&#x8BD5;&#x8F6C;&#x6362;, &#x5176;&#x4ED6;&#x7C7B;&#x578B;&#x5219;&#x662F;0.</p>
<h2 class="mume-header" id="53-%E6%89%A9%E5%B1%95-luastate-%E6%8E%A5%E5%8F%A3">5.3 &#x6269;&#x5C55; LuaState &#x63A5;&#x53E3;</h2>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> LuaState <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	BasicAPI
	DebugAPI
	AuxLib
	<span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token comment">// debug</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> BasicAPI <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">Arith</span><span class="token punctuation">(</span>op ArithOp<span class="token punctuation">)</span>                          <span class="token comment">// b=pop(); a=pop(); push(a op b)</span>
    <span class="token function">Compare</span><span class="token punctuation">(</span>idx1<span class="token punctuation">,</span> idx2 <span class="token builtin">int</span><span class="token punctuation">,</span> op CompareOp<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token comment">// r[idx1] op r[idx2]</span>
    <span class="token function">Concat</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span>                 <span class="token comment">// push(concat(pop(n)))</span>
	<span class="token function">Len</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>                  <span class="token comment">// push(len(r[idx]))</span>
<span class="token punctuation">}</span>

</pre><p>&#x65B0;&#x589E;&#x5B9E;&#x73B0;&#x8FD9;&#x51E0;&#x4E2A; LuaState &#x63A5;&#x53E3;.</p>
<ul>
<li>Arith() &#x7528;&#x4E8E;&#x6267;&#x884C;&#x7B97;&#x672F;&#x548C;&#x6309;&#x4F4D;&#x8FD0;&#x7B97;</li>
<li>Compare() &#x7528;&#x4E8E;&#x6267;&#x884C;&#x6BD4;&#x8F83;&#x8FD0;&#x7B97;</li>
<li>Len() &#x6267;&#x884C;&#x53D6;&#x957F;&#x5EA6;&#x8FD0;&#x7B97;</li>
<li>Concat() &#x6267;&#x884C;&#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FD0;&#x7B97;</li>
</ul>
<p>&#x5B9A;&#x4E49;&#x8FD0;&#x7B97;&#x7B26;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/* arithmetic functions */</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	LUA_OPADD  <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// +</span>
	LUA_OPSUB         <span class="token comment">// -</span>
	LUA_OPMUL         <span class="token comment">// *</span>
	LUA_OPMOD         <span class="token comment">// %</span>
	LUA_OPPOW         <span class="token comment">// ^</span>
	LUA_OPDIV         <span class="token comment">// /</span>
	LUA_OPIDIV        <span class="token comment">// //</span>
	LUA_OPBAND        <span class="token comment">// &amp;</span>
	LUA_OPBOR         <span class="token comment">// |</span>
	LUA_OPBXOR        <span class="token comment">// ~</span>
	LUA_OPSHL         <span class="token comment">// &lt;&lt;</span>
	LUA_OPSHR         <span class="token comment">// &gt;&gt;</span>
	LUA_OPUNM         <span class="token comment">// -</span>
	LUA_OPBNOT        <span class="token comment">// ~</span>
<span class="token punctuation">)</span>
</pre><h3 class="mume-header" id="531-arith-%E6%96%B9%E6%B3%95">5.3.1 Arith &#x65B9;&#x6CD5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">var</span> <span class="token punctuation">(</span>
	iadd <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token punctuation">}</span>
	fadd <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">+</span> b <span class="token punctuation">}</span>
	isub <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">-</span> b <span class="token punctuation">}</span>
	fsub <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">-</span> b <span class="token punctuation">}</span>
	imul <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">*</span> b <span class="token punctuation">}</span>
	fmul <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">*</span> b <span class="token punctuation">}</span>
	div  <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">/</span> b <span class="token punctuation">}</span>
	iunm <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">-</span>a <span class="token punctuation">}</span>
	funm <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">-</span>a <span class="token punctuation">}</span>
	band <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">&amp;</span> b <span class="token punctuation">}</span>
	bor  <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">|</span> b <span class="token punctuation">}</span>
	bxor <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> a <span class="token operator">^</span> b <span class="token punctuation">}</span>
	bnot <span class="token operator">=</span> <span class="token keyword">func</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">^</span>a <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</pre><p>&#x5BB9;&#x7EB3;&#x6574;&#x6570;&#x548C;&#x6D6E;&#x70B9;&#x6570;&#x7C7B;&#x578B;&#x7684;&#x8FD0;&#x7B97;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x4E3A;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> operator <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	metamethod  <span class="token builtin">string</span>
	integerFunc <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">,</span> <span class="token builtin">int64</span><span class="token punctuation">)</span> <span class="token builtin">int64</span>
	floatFunc   <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">,</span> <span class="token builtin">float64</span><span class="token punctuation">)</span> <span class="token builtin">float64</span>
<span class="token punctuation">}</span>
</pre><p>&#x64CD;&#x4F5C;&#x7B26; slice, &#x7528;&#x4E8E;&#x5305;&#x88C5;&#x64CD;&#x4F5C;&#x4E0D;&#x540C;&#x6570;&#x636E;&#x7C7B;&#x578B;&#x7684;&#x540C;&#x4E00;&#x64CD;&#x4F5C;&#x7B26;, &#x5373;&#x4E0A;&#x9762;&#x7684;&#x7ED3;&#x6784;&#x4F53;&#x7684;&#x5B9E;&#x4F8B;&#x5316;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">var</span> operators <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>operator<span class="token punctuation">{</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__add&quot;</span><span class="token punctuation">,</span> iadd<span class="token punctuation">,</span> fadd<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__sub&quot;</span><span class="token punctuation">,</span> isub<span class="token punctuation">,</span> fsub<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__mul&quot;</span><span class="token punctuation">,</span> imul<span class="token punctuation">,</span> fmul<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__mod&quot;</span><span class="token punctuation">,</span> number<span class="token punctuation">.</span>IMod<span class="token punctuation">,</span> number<span class="token punctuation">.</span>FMod<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__pow&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> math<span class="token punctuation">.</span>Pow<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__div&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> div<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__idiv&quot;</span><span class="token punctuation">,</span> number<span class="token punctuation">.</span>IFloorDiv<span class="token punctuation">,</span> number<span class="token punctuation">.</span>FFloorDiv<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__band&quot;</span><span class="token punctuation">,</span> band<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__bor&quot;</span><span class="token punctuation">,</span> bor<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__bxor&quot;</span><span class="token punctuation">,</span> bxor<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__shl&quot;</span><span class="token punctuation">,</span> number<span class="token punctuation">.</span>ShiftLeft<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__shr&quot;</span><span class="token punctuation">,</span> number<span class="token punctuation">.</span>ShiftRight<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__unm&quot;</span><span class="token punctuation">,</span> iunm<span class="token punctuation">,</span> funm<span class="token punctuation">}</span><span class="token punctuation">,</span>
	operator<span class="token punctuation">{</span><span class="token string">&quot;__bnot&quot;</span><span class="token punctuation">,</span> bnot<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</pre><p>&#x5B9E;&#x73B0; Arith():</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-(2|1), +1, e]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_arith</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Arith</span><span class="token punctuation">(</span>op ArithOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// &#x4ECE;&#x6808;&#x53D6;&#x51FA; oprands</span>
	<span class="token keyword">var</span> a<span class="token punctuation">,</span> b luaValue <span class="token comment">// operands</span>
	b <span class="token operator">=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> op <span class="token operator">!=</span> LUA_OPUNM <span class="token operator">&amp;&amp;</span> op <span class="token operator">!=</span> LUA_OPBNOT <span class="token punctuation">{</span>
		a <span class="token operator">=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		a <span class="token operator">=</span> b
	<span class="token punctuation">}</span>

	operator <span class="token operator">:=</span> operators<span class="token punctuation">[</span>op<span class="token punctuation">]</span>
	<span class="token keyword">if</span> result <span class="token operator">:=</span> <span class="token function">_arith</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> operator<span class="token punctuation">)</span><span class="token punctuation">;</span> result <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	mm <span class="token operator">:=</span> operator<span class="token punctuation">.</span>metamethod
	<span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> mm<span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> operator<span class="token punctuation">.</span>floatFunc <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;number has no integer representation&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">var</span> typeName <span class="token builtin">string</span>
	<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">convertToFloat</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		typeName <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		typeName <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to perform arithmetic on a &quot;</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">&quot; value&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</pre><p>&#x903B;&#x8F91;&#x662F;&#x53D6;&#x51FA;&#x64CD;&#x4F5C;&#x6570;, &#x7136;&#x540E;&#x6839;&#x636E; op &#x9009;&#x62E9; Arith op &#x7136;&#x540E;&#x6267;&#x884C;, &#x6700;&#x540E;&#x538B;&#x5165;&#x6808;.</p>
<p>_arith() &#x5219;&#x662F;&#x5177;&#x4F53;&#x8FD0;&#x7B97;&#x903B;&#x8F91;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">_arith</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b luaValue<span class="token punctuation">,</span> op operator<span class="token punctuation">)</span> luaValue <span class="token punctuation">{</span>
	<span class="token keyword">if</span> op<span class="token punctuation">.</span>floatFunc <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// bitwise</span>
		<span class="token keyword">if</span> x<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">convertToInteger</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">convertToInteger</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">return</span> op<span class="token punctuation">.</span><span class="token function">integerFunc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// arith</span>
		<span class="token keyword">if</span> op<span class="token punctuation">.</span>integerFunc <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// add,sub,mul,mod,idiv,unm</span>
			<span class="token keyword">if</span> x<span class="token punctuation">,</span> ok <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
					<span class="token keyword">return</span> op<span class="token punctuation">.</span><span class="token function">integerFunc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> x<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">convertToFloat</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">convertToFloat</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">return</span> op<span class="token punctuation">.</span><span class="token function">floatFunc</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

</pre><p>&#x5373;&#x6309;&#x5177;&#x4F53;&#x64CD;&#x4F5C;&#x6570;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x7C7B;&#x578B;&#x8F6C;&#x6362;&#x540E;&#x8FDB;&#x884C;&#x64CD;&#x4F5C;.</p>
<h3 class="mume-header" id="532-compare-%E6%96%B9%E6%B3%95">5.3.2 Compare() &#x65B9;&#x6CD5;</h3>

<p>Compare() &#x65B9;&#x6CD5;&#x6BD4;&#x8F83;&#x6808;&#x4E0A;&#x4E24;&#x4E2A;&#x503C;, &#x4F46;&#x4E0D;&#x5BF9;&#x6808;&#x505A;&#x51FA;&#x4FEE;&#x6539;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, e]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_compare</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Compare</span><span class="token punctuation">(</span>idx1<span class="token punctuation">,</span> idx2 <span class="token builtin">int</span><span class="token punctuation">,</span> op CompareOp<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>idx1<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">isValid</span><span class="token punctuation">(</span>idx2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token punctuation">}</span>

	a <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx1<span class="token punctuation">)</span>
	b <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx2<span class="token punctuation">)</span>
	<span class="token keyword">switch</span> op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> LUA_OPEQ<span class="token punctuation">:</span>
		<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> LUA_OPLT<span class="token punctuation">:</span>
		<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">lt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">case</span> LUA_OPLE<span class="token punctuation">:</span>
		<span class="token keyword">return</span> state<span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;invalid compare op!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x540C;&#x6837;, &#x5177;&#x4F53;&#x6267;&#x884C; compare &#x7684; op &#x9700;&#x8981;&#x4F9D;&#x636E;&#x64CD;&#x4F5C;&#x7801;&#x8FDB;&#x884C;&#x9009;&#x62E9;&#x65B9;&#x6CD5;&#x64CD;&#x4F5C;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">eq</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b luaValue<span class="token punctuation">,</span> raw <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> x <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token boolean">nil</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> b <span class="token operator">==</span> <span class="token boolean">nil</span>
	<span class="token keyword">case</span> <span class="token builtin">bool</span><span class="token punctuation">:</span>
		y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">bool</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ok <span class="token operator">&amp;&amp;</span> x <span class="token operator">==</span> y
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> ok <span class="token operator">&amp;&amp;</span> x <span class="token operator">==</span> y
	<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
		<span class="token keyword">switch</span> y <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">==</span> y
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">==</span> y
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
		<span class="token keyword">switch</span> y <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">==</span> y
		<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">==</span> <span class="token function">float64</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token boolean">false</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>luaTable<span class="token punctuation">:</span>
		<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>luaTable<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> x <span class="token operator">!=</span> y <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>raw <span class="token punctuation">{</span>
			<span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> <span class="token string">&quot;__eq&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				<span class="token keyword">return</span> <span class="token function">convertToBoolean</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> a <span class="token operator">==</span> b
	<span class="token keyword">case</span> <span class="token operator">*</span>userdata<span class="token punctuation">:</span>
		<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>userdata<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> x<span class="token punctuation">.</span>data <span class="token operator">==</span> y<span class="token punctuation">.</span>data
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token boolean">false</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> a <span class="token operator">==</span> b
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">lt</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b luaValue<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> x <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;</span> y
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
		<span class="token keyword">switch</span> y <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;</span> y
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&lt;</span> y
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
		<span class="token keyword">switch</span> y <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;</span> y
		<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;</span> <span class="token function">float64</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">&quot;__lt&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">convertToBoolean</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	typeName1 <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
	typeName2 <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to compare &quot;</span> <span class="token operator">+</span> typeName1 <span class="token operator">+</span> <span class="token string">&quot; with &quot;</span> <span class="token operator">+</span> typeName2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">le</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b luaValue<span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> x <span class="token operator">:=</span> a<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token builtin">string</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> y<span class="token punctuation">,</span> ok <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;=</span> y
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
		<span class="token keyword">switch</span> y <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;=</span> y
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> <span class="token function">float64</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token operator">&lt;=</span> y
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
		<span class="token keyword">switch</span> y <span class="token operator">:=</span> b<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token builtin">float64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;=</span> y
		<span class="token keyword">case</span> <span class="token builtin">int64</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> x <span class="token operator">&lt;=</span> <span class="token function">float64</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">&quot;__le&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">convertToBoolean</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token string">&quot;__lt&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">convertToBoolean</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	typeName1 <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
	typeName2 <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to compare &quot;</span> <span class="token operator">+</span> typeName1 <span class="token operator">+</span> <span class="token string">&quot; with &quot;</span> <span class="token operator">+</span> typeName2<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</pre><p>&#x8FD9;&#x8DEF;i&#x7684;&#x5BF9;&#x6BD4;&#x5F62;&#x5F0F;&#x662F;, &#x73B0;&#x68C0;&#x6D4B; a &#x7684;&#x503C;&#x7C7B;&#x578B;, &#x7136;&#x540E;&#x5C06; b &#x8F6C;&#x6362;&#x5230; a &#x4E00;&#x81F4;&#x7684;&#x7C7B;&#x578B;, &#x7136;&#x540E;&#x8FDB;&#x884C;&#x6BD4;&#x8F83;.</p>
<p>&#x5927;&#x5C0F;&#x6BD4;&#x8F83;&#x5219;&#x53EA;&#x6709;&#x5B57;&#x7B26;&#x4E32;&#x548C;&#x6570;&#x5B57;&#x624D;&#x6709;&#x610F;&#x4E49;.</p>
<h3 class="mume-header" id="533-len-%E6%96%B9%E6%B3%95">5.3.3 Len() &#x65B9;&#x6CD5;</h3>

<p>&#x8BBF;&#x95EE;&#x6307;&#x5B9A;&#x4F4D;&#x7F6E;&#x503C;, &#x6C42;&#x957F;&#x5EA6;&#x540E;&#x5C06;&#x7ED3;&#x679C;&#x538B;&#x5165;&#x6808;&#x9876;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +1, e]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_len</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Len</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>idx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> s<span class="token punctuation">,</span> ok <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> val<span class="token punctuation">,</span> <span class="token string">&quot;__len&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> t<span class="token punctuation">,</span> ok <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>luaTable<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">int64</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		typeName <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to get length of a &quot;</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">&quot; value&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="534-concat-%E6%96%B9%E6%B3%95">5.3.4 Concat() &#x65B9;&#x6CD5;</h3>

<p>&#x5F39;&#x51FA; n &#x4E2A;&#x503C;, &#x7136;&#x540E;&#x62FC;&#x63A5;&#x540E;&#x538B;&#x5165;&#x6808;&#x9876;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-n, +1, e]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_concat</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Concat</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> n <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> state<span class="token punctuation">.</span><span class="token function">IsString</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> state<span class="token punctuation">.</span><span class="token function">IsString</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				s2 <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
				s1 <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">)</span>
				state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>s1 <span class="token operator">+</span> s2<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>

			b <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			a <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> result<span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">callMetamethod</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token string">&quot;__concat&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">var</span> typeName <span class="token builtin">string</span>
			<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> <span class="token function">convertToFloat</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
				typeName <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				typeName <span class="token operator">=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to concatenate a &quot;</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">&quot; value&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// n == 1, do nothing</span>
<span class="token punctuation">}</span>

</pre><h2 class="mume-header" id="54-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">5.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>

<h1 class="mume-header" id="chapter-6-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%9B%8F%E5%BD%A2">Chapter 6, &#x865A;&#x62DF;&#x673A;&#x96CF;&#x5F62;</h1>

<h2 class="mume-header" id="61-%E6%B7%BB%E5%8A%A0-luavm-%E6%8E%A5%E5%8F%A3">6.1 &#x6DFB;&#x52A0; LuaVM &#x63A5;&#x53E3;</h2>

<p>&#x7B80;&#x5355;&#x63CF;&#x8FF0;&#x4E86; LuaVM &#x9700;&#x8981; PC &#x5BC4;&#x5B58;&#x5668;, &#x4EE5;&#x53CA;&#x6784;&#x6210;&#x548C;&#x6267;&#x884C;&#x65B9;&#x5F0F;.</p>
<h3 class="mume-header" id="611-%E5%AE%9A%E4%B9%89-luavm-%E6%8E%A5%E5%8F%A3">6.1.1 &#x5B9A;&#x4E49; LuaVM &#x63A5;&#x53E3;</h3>

<p>LuaVM &#x63A5;&#x53E3;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> LuaVM <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	LuaState
	<span class="token function">AddPC</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span>         <span class="token comment">// pc += n</span>
	<span class="token function">Fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span>       <span class="token comment">// code[pc++]</span>
	<span class="token function">RegisterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span>  <span class="token comment">// proto.MaxStackSize</span>
	<span class="token function">GetConst</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>    <span class="token comment">// push(const[idx])</span>
	<span class="token function">GetRK</span><span class="token punctuation">(</span>rk <span class="token builtin">int</span><span class="token punctuation">)</span>        <span class="token comment">// rk &gt; 0xFF ? GetConst(rk &amp; 0xFF) : PushValue(rk + 1)</span>
	<span class="token function">LoadProto</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span>   <span class="token comment">// push(proto[idx] as LuaFunction)</span>
	<span class="token function">LoadVararg</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span>    <span class="token comment">// push(vararg[0], ..., vararg[n-1])</span>
	<span class="token function">CloseUpvalues</span><span class="token punctuation">(</span>a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token comment">// close all upvalues &gt;= R(A - 1)</span>
<span class="token punctuation">}</span>

</pre><p>&#x5373;&#x4E3B;&#x8981;&#x64CD;&#x4F5C;&#x6838;&#x5FC3;&#x90FD;&#x662F;&#x64CD;&#x4F5C; PC &#x6216;&#x8005;&#x4FEE;&#x6539;&#x6808;&#x9876;.</p>
<h3 class="mume-header" id="612-%E6%94%B9%E9%80%A0-luastate-%E7%BB%93%E6%9E%84%E4%BD%93">6.1.2 &#x6539;&#x9020; luaState &#x7ED3;&#x6784;&#x4F53;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> luaState <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">/* global state */</span>
	hook     LuaHook
	hookMask <span class="token builtin">int</span>
	panicf   GoFunction
	registry <span class="token operator">*</span>luaTable
	<span class="token comment">/* stack */</span>
	stack     <span class="token operator">*</span>luaStack
	callDepth <span class="token builtin">int</span>
	<span class="token comment">/* coroutine */</span>
	coStatus ThreadStatus
	coCaller <span class="token operator">*</span>luaState
	coChan   <span class="token keyword">chan</span> <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</pre><p>&#x65B0;&#x589E;&#x4E86; proto, &#x7528;&#x4E8E;&#x4FDD;&#x5B58;&#x51FD;&#x6570;&#x539F;&#x578B;, pc &#x5219;&#x662F; pc &#x5BC4;&#x5B58;&#x5668;.</p>
<h3 class="mume-header" id="613-%E5%AE%9E%E7%8E%B0-luavm-%E6%8E%A5%E5%8F%A3">6.1.3 &#x5B9E;&#x73B0; LuaVM &#x63A5;&#x53E3;</h3>

<p>&#x63A5;&#x4E0B;&#x6765;&#x5B9E;&#x73B0;&#x521A;&#x624D;&#x5B9A;&#x4E49;&#x7684; LuaVM &#x63A5;&#x53E3;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">AddPC</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>pc <span class="token operator">+=</span> n
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">uint32</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>closure<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>Code<span class="token punctuation">[</span>state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>pc<span class="token punctuation">]</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>pc<span class="token operator">++</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">RegisterCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">int</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>closure<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>MaxStackSize<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">GetConst</span><span class="token punctuation">(</span>idx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	c <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>closure<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>Constants<span class="token punctuation">[</span>idx<span class="token punctuation">]</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">GetRK</span><span class="token punctuation">(</span>rk <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> rk <span class="token operator">&gt;</span> <span class="token number">0xFF</span> <span class="token punctuation">{</span> <span class="token comment">// constant</span>
		state<span class="token punctuation">.</span><span class="token function">GetConst</span><span class="token punctuation">(</span>rk <span class="token operator">&amp;</span> <span class="token number">0xFF</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// register</span>
		state<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>rk <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>AddPC() &#x548C; Fetch() &#x5C31;&#x53EF;&#x4EE5;&#x7EC4;&#x6210;&#x5411;&#x524D;&#x83B7;&#x53D6;&#x6307;&#x4EE4;&#x7684;&#x65B9;&#x6CD5;.</p>
<p>GetConst() &#x4ECE;&#x5E38;&#x91CF;&#x8868;&#x53D6;&#x503C;&#x5E76;&#x538B;&#x5165;&#x6808;&#x9876;.</p>
<h2 class="mume-header" id="62-%E5%AE%9E%E7%8E%B0-lua-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4">6.2 &#x5B9E;&#x73B0; Lua &#x865A;&#x62DF;&#x673A;&#x6307;&#x4EE4;</h2>

<h3 class="mume-header" id="621-%E7%A7%BB%E5%8A%A8%E5%92%8C%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4">6.2.1 &#x79FB;&#x52A8;&#x548C;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;</h3>

<h4 class="mume-header" id="1-move">1. MOVE</h4>

<p>move (iABC) &#x628A;&#x6E90;&#x5BC4;&#x5B58;&#x5668; (&#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570; B &#x6307;&#x5B9A;) &#x91CC;&#x7684;&#x503C;&#x79FB;&#x52A8;&#x5230;&#x76EE;&#x6807;&#x5BC4;&#x5B58;&#x5668; (&#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570;A&#x6307;&#x5B9A;).</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := R(B)</span>
<span class="token keyword">func</span> <span class="token function">move</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>

	vm<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p><code>+1</code> &#x5C06;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;&#x8F6C;&#x6362;&#x4E3A;&#x6808;&#x7D22;&#x5F15;.</p>
<p>Copy &#x5C06;&#x503C;&#x62F7;&#x8D1D;&#x5230;&#x6808;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +0, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_copy</span>
<span class="token comment">// lua-5.3.4/src/lapi.c#lua_copy()</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Copy</span><span class="token punctuation">(</span>fromIdx<span class="token punctuation">,</span> toIdx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fromIdx<span class="token punctuation">)</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>toIdx<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x7531;&#x4E8E;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5728;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;, &#x56E0;&#x6B64;&#x6700;&#x5927;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6570;&#x91CF;&#x4E0D;&#x80FD;&#x8D85;&#x8FC7; oprand A &#x7684;&#x957F;&#x5EA6; 8, &#x56E0;&#x6B64;&#x6700;&#x5927;&#x80FD;&#x5BB9;&#x7EB3; 255 &#x4E2A;. &#x5B9E;&#x9645;&#x4E0A;&#x88AB;&#x9650;&#x5236;&#x5230;&#x4E86; 200 &#x4E2A;&#x4EE5;&#x5185;.</p>
<h4>2. JMP</h4>
<p>JMP (iAsBx) &#x6267;&#x884C;&#x65E0;&#x6761;&#x4EF6;&#x8DF3;&#x8F6C;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// pc+=sBx; if (A) close all upvalues &gt;= R(A - 1)</span>
<span class="token keyword">func</span> <span class="token function">jmp</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> sBx <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">AsBx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span>sBx<span class="token punctuation">)</span>
	<span class="token keyword">if</span> a <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">CloseUpvalues</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">AddPC</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span>pc <span class="token operator">+=</span> n
<span class="token punctuation">}</span>
</pre><h3>6.2.2 &#x52A0;&#x8F7D;&#x6307;&#x4EE4;</h3>
<p>&#x7528;&#x4E8E;&#x628A; nil, &#x5E03;&#x5C14;, &#x5E38;&#x91CF;&#x52A0;&#x8F7D;&#x5230;&#x5BC4;&#x5B58;&#x5668;&#x91CC;.</p>
<h4>1. LOADNIL</h4>
<p>loadnil (iABC), &#x7528;&#x4E8E;&#x7ED9;&#x8FDE;&#x7EED; n &#x4E2A;&#x8FDB;&#x7C97;&#x6C14;&#x653E;&#x7F6E; nil &#x503C;. &#x5BC4;&#x5B58;&#x5668;&#x7684;&#x8D77;&#x59CB;&#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570; A &#x6307;&#x5B9A;, &#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF; B &#x6307;&#x5B9A;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A), R(A+1), ..., R(A+B) := nil</span>
<span class="token keyword">func</span> <span class="token function">loadNil</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">PushNil</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ~/nil</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> a<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	vm<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// ~</span>
<span class="token punctuation">}</span>
</pre><p>&#x5B9E;&#x73B0;&#x65B9;&#x5F0F;&#x662F;&#x5148;&#x5C06;&#x4E00;&#x4E2A;nil&#x503C;&#x538B;&#x5165;&#x6808;&#x9876;, &#x7136;&#x540E;&#x62F7;&#x8D1D;&#x8986;&#x76D6;, &#x6700;&#x540E;&#x518D;&#x5F39;&#x51FA;&#x538B;&#x5165;&#x7684;&#x591A;&#x4F59;&#x7684;&#x503C;.</p>
<h4>2. LOADBOOL</h4>
<p>loadbool (iABC) &#x7ED9;&#x5355;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x8BBE;&#x7F6E;&#x5E03;&#x5C14;&#x503C;. &#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;&#x7531; A &#x6307;&#x5B9A;, &#x5E03;&#x5C14;&#x503C;&#x7531; B &#x6307;&#x5B9A;. C &#x975E; 0 &#x5219;&#x8DF3;&#x8FC7;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := (bool)B; if (C) pc++</span>
<span class="token keyword">func</span> <span class="token function">loadBool</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">PushBoolean</span><span class="token punctuation">(</span>b <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// ~/b</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>          <span class="token comment">// ~</span>

	<span class="token keyword">if</span> c <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h4>3. LOADK &#x548C; LOADKX</h4>
<p>LOADK (iABx) &#x5C06;&#x5E38;&#x91CF;&#x8868;&#x91CC;&#x7684;&#x67D0;&#x4E2A;&#x5E38;&#x91CF;&#x52A0;&#x8F7D;&#x5230;&#x6307;&#x5B9A;&#x5BC4;&#x5B58;&#x5668;. &#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570; A &#x6307;&#x5B9A;, &#x5E38;&#x91CF;&#x8868;&#x7D22;&#x5F15;&#x7531; Bx &#x6307;&#x5B9A;.</p>
<p>Lua &#x51FD;&#x6570;&#x91CC;&#x51FA;&#x73B0;&#x7684;&#x5B57;&#x9762;&#x91CF; (&#x6570;&#x5B57;&#x548C;&#x5B57;&#x7B26;&#x4E32;) &#x4F1A;&#x88AB; Lua &#x7F16;&#x8BD1;&#x5668;&#x6536;&#x96C6;&#x8D77;&#x6765;, &#x653E;&#x8FDB;&#x5E38;&#x91CF;&#x8868;&#x91CC;&#x9762;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := Kst(Bx)</span>
<span class="token keyword">func</span> <span class="token function">loadK</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> bx <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">GetConst</span><span class="token punctuation">(</span>bx<span class="token punctuation">)</span> <span class="token comment">// ~/k[bx]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">// ~</span>
<span class="token punctuation">}</span>

</pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := Kst(extra arg)</span>
<span class="token keyword">func</span> <span class="token function">loadKx</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	ax <span class="token operator">:=</span> <span class="token function">Instruction</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Ax</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">GetConst</span><span class="token punctuation">(</span>ax<span class="token punctuation">)</span> <span class="token comment">// ~/k[ax]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">// ~</span>
<span class="token punctuation">}</span>

</pre><h3>6.2.3 &#x7B97;&#x672F;&#x8FD0;&#x7B97;&#x6307;&#x4EE4;</h3>
<h4>1. &#x4E8C;&#x5143;&#x7B97;&#x672F;&#x8FD0;&#x7B97;&#x6307;&#x4EE4;</h4>
<p>&#x4E8C;&#x5143;&#x7B97;&#x672F;&#x8FD0;&#x7B97;&#x6307;&#x4EE4; iABC &#x6A21;&#x5F0F;, &#x5BF9;&#x4E24;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x6216;&#x5E38;&#x91CF;&#x503C;&#x8FDB;&#x884C;&#x8FD0;&#x7B97; (Oprand B, C), &#x5C06;&#x7ED3;&#x679C;&#x653E;&#x5165; Oprand A.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := RK(B) op RK(C)</span>
<span class="token keyword">func</span> <span class="token function">_binaryArith</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">,</span> op ArithOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(2)</span>
	vm<span class="token punctuation">.</span><span class="token function">GetRK</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>   <span class="token comment">// ~/rk[b]</span>
	vm<span class="token punctuation">.</span><span class="token function">GetRK</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>   <span class="token comment">// ~/rk[b]/rk[c]</span>
	vm<span class="token punctuation">.</span><span class="token function">Arith</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>  <span class="token comment">// ~/result</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// ~</span>
<span class="token punctuation">}</span>

</pre><h4>2. &#x4E00;&#x5143;&#x7B97;&#x672F;&#x8FD0;&#x7B97;&#x6307;&#x4EE4;</h4>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := op R(B)</span>
<span class="token keyword">func</span> <span class="token function">_unaryArith</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">,</span> op ArithOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// ~/r[b]</span>
	vm<span class="token punctuation">.</span><span class="token function">Arith</span><span class="token punctuation">(</span>op<span class="token punctuation">)</span>    <span class="token comment">// ~/result</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>   <span class="token comment">// ~</span>
<span class="token punctuation">}</span>
</pre><p>&#x5176;&#x4ED6;&#x4E00;&#x5143;&#x7B97;&#x672F;&#x8FD0;&#x7B97;&#x4E5F;&#x5747;&#x662F;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;.</p>
<h3>6.2.4 &#x957F;&#x5EA6;&#x548C;&#x62FC;&#x63A5;&#x6307;&#x4EE4;</h3>
<h4>1. LEN</h4>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := length of R(B)</span>
<span class="token keyword">func</span> <span class="token function">length</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">Len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>     <span class="token comment">// ~/#r[b]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// ~</span>
<span class="token punctuation">}</span>
</pre><h4>2. CONCAT</h4>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := R(B).. ... ..R(C)</span>
<span class="token keyword">func</span> <span class="token function">concat</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>
	c <span class="token operator">+=</span> <span class="token number">1</span>

	n <span class="token operator">:=</span> c <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token number">1</span>
	vm<span class="token punctuation">.</span><span class="token function">CheckStack</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> b<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> c<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token comment">// ~/r[b]/.../r[c]</span>
	<span class="token punctuation">}</span>
	vm<span class="token punctuation">.</span><span class="token function">Concat</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>  <span class="token comment">// ~/result</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// ~</span>
<span class="token punctuation">}</span>

</pre><p>&#x8FD9;&#x91CC;&#x7684; B, C &#x4E3A;&#x8D77;&#x6B62;&#x7D22;&#x5F15;&#x4F4D;&#x7F6E;. &#x6700;&#x7EC8;&#x7ED3;&#x679C;&#x653E;&#x5165; A. &#x8BA1;&#x7B97;&#x51FA;&#x7684; n &#x5373;&#x4E3A;&#x62FC;&#x63A5;&#x7684;&#x6808;&#x957F;&#x5EA6;. &#x68C0;&#x67E5; Stack &#x540E;, &#x8C03;&#x7528; vm.Concat() &#x8FDB;&#x884C;&#x62FC;&#x63A5;. &#x53E6;&#x5916;&#x8FD8;&#x9700;&#x8981;&#x68C0;&#x67E5;&#x6808;&#x7A7A;&#x95F4;&#x662F;&#x5426;&#x591F;&#x7528;.</p>
<h3>6.2.5 &#x6BD4;&#x8F83;&#x6307;&#x4EE4;</h3>
<p>iABC &#x6A21;&#x5F0F;. &#x53EF;&#x4EE5;&#x6BD4;&#x8F83;&#x5BC4;&#x5B58;&#x5668;&#x6216;&#x5E38;&#x91CF;&#x8868;&#x91CC;&#x7684;&#x4E24;&#x4E2A;&#x503C;. &#x5982;&#x679C;&#x6BD4;&#x8F83;&#x7ED3;&#x679C;&#x548C; Oprand A (&#x9690;&#x5F0F;&#x8F6C;&#x6362;&#x4E3A;&#x5E03;&#x5C14;&#x503C;) &#x4E0D;&#x5339;&#x914D;, &#x5219;&#x8DF3;&#x8FC7;&#x4E0B;&#x4E00;&#x6761;&#x6307;&#x4EE4;. &#x5373;</p>
<pre data-role="codeBlock" data-info class="language-"><code>if ((RK(B) op RK(C)) ~= A ) then pc++
</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// if ((RK(B) op RK(C)) ~= A) then pc++</span>
<span class="token keyword">func</span> <span class="token function">_compare</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">,</span> op CompareOp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">//vm.CheckStack(2)</span>
	vm<span class="token punctuation">.</span><span class="token function">GetRK</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// ~/rk[b]</span>
	vm<span class="token punctuation">.</span><span class="token function">GetRK</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token comment">// ~/rk[b]/rk[c]</span>
	<span class="token keyword">if</span> vm<span class="token punctuation">.</span><span class="token function">Compare</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> op<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>a <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	vm<span class="token punctuation">.</span><span class="token function">Pop</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// ~</span>
<span class="token punctuation">}</span>
</pre><h3>6.2.6 &#x903B;&#x8F91;&#x8FD0;&#x7B97;&#x6307;&#x4EE4;</h3>
<h4>1. NOT</h4>
<p>iABC &#x6A21;&#x5F0F;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := not R(B)</span>
<span class="token keyword">func</span> <span class="token function">not</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">PushBoolean</span><span class="token punctuation">(</span><span class="token operator">!</span>vm<span class="token punctuation">.</span><span class="token function">ToBoolean</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// ~/!r[b]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>                    <span class="token comment">// ~</span>
<span class="token punctuation">}</span>
</pre><h4>2. TESTSET</h4>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// if (R(B) &lt;=&gt; C) then R(A) := R(B) else pc++</span>
<span class="token keyword">func</span> <span class="token function">testSet</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token keyword">if</span> vm<span class="token punctuation">.</span><span class="token function">ToBoolean</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h4>3. TEST</h4>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// if not (R(A) &lt;=&gt; C) then pc++</span>
<span class="token keyword">func</span> <span class="token function">test</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token keyword">if</span> vm<span class="token punctuation">.</span><span class="token function">ToBoolean</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token punctuation">(</span>c <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>6.2.7 for &#x5FAA;&#x73AF;&#x6307;&#x4EE4;</h3>
<p>for &#x5FAA;&#x73AF;&#x6709; &#x6570;&#x503C; &#x548C; &#x7EDF;&#x7528; &#x4E24;&#x79CD;&#x5F62;&#x5F0F;.&#x6570;&#x503C; for &#x7528;&#x4E8E;&#x6309;&#x4E00;&#x5B9A;&#x6B65;&#x957F;&#x904D;&#x5386;&#x67D0;&#x4E2A;&#x8303;&#x56F4;&#x5185;&#x7684;&#x6570;&#x503C;. &#x901A;&#x7528; for &#x5219;&#x7528;&#x4E8E;&#x4FBF;&#x5229;&#x8868;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A)-=R(A+2); pc+=sBx</span>
<span class="token keyword">func</span> <span class="token function">forPrep</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> sBx <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">AsBx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(2)</span>
	<span class="token keyword">if</span> vm<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TSTRING <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">PushNumber</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">ToNumber</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span>
		vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> vm<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TSTRING <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">PushNumber</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">ToNumber</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> vm<span class="token punctuation">.</span><span class="token function">Type</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> LUA_TSTRING <span class="token punctuation">{</span>
		vm<span class="token punctuation">.</span><span class="token function">PushNumber</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">ToNumber</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>     <span class="token comment">// ~/r[a]</span>
	vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// ~/r[a]/r[a+2]</span>
	vm<span class="token punctuation">.</span><span class="token function">Arith</span><span class="token punctuation">(</span>LUA_OPSUB<span class="token punctuation">)</span> <span class="token comment">// ~/r[a]-r[a+2]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>       <span class="token comment">// ~</span>
	vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span>sBx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// R(A)+=R(A+2);</span>
<span class="token comment">// if R(A) &lt;?= R(A+1) then {</span>
<span class="token comment">//   pc+=sBx; R(A+3)=R(A)</span>
<span class="token comment">// }</span>
<span class="token keyword">func</span> <span class="token function">forLoop</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> sBx <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">AsBx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(2)</span>
	<span class="token comment">// R(A)+=R(A+2);</span>
	vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>a <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// ~/r[a+2]</span>
	vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>     <span class="token comment">// ~/r[a+2]/r[a]</span>
	vm<span class="token punctuation">.</span><span class="token function">Arith</span><span class="token punctuation">(</span>LUA_OPADD<span class="token punctuation">)</span> <span class="token comment">// ~/r[a]+r[a+2]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>       <span class="token comment">// ~</span>

	isPositiveStep <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">ToNumber</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span>
	<span class="token keyword">if</span> isPositiveStep <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span><span class="token function">Compare</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> LUA_OPLE<span class="token punctuation">)</span> <span class="token operator">||</span>
		<span class="token operator">!</span>isPositiveStep <span class="token operator">&amp;&amp;</span> vm<span class="token punctuation">.</span><span class="token function">Compare</span><span class="token punctuation">(</span>a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> LUA_OPLE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// pc+=sBx; R(A+3)=R(A)</span>
		vm<span class="token punctuation">.</span><span class="token function">AddPC</span><span class="token punctuation">(</span>sBx<span class="token punctuation">)</span>
		vm<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> a<span class="token operator">+</span><span class="token number">3</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>FORPREP :</p>
<pre data-role="codeBlock" data-info class="language-"><code>R(A) -= R(A+2);
pc += sBx
</code></pre><p>FORLOOP:</p>
<pre data-role="codeBlock" data-info class="language-"><code>R(A)+=R(A+2);
if R(A) &lt;?= R(A+1) then {
  pc+=sBx; R(A+3)=R(A)
}
</code></pre><h2>6.3 &#x6307;&#x4EE4;&#x5206;&#x6D3E; (Dispatch)</h2>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>instr Instruction<span class="token punctuation">)</span> <span class="token function">Execute</span><span class="token punctuation">(</span>vm api<span class="token punctuation">.</span>LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	opcodes<span class="token punctuation">[</span>instr<span class="token punctuation">.</span><span class="token function">Opcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">action</span><span class="token punctuation">(</span>instr<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><h2>6.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>
<h2>6.5 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>
<h1>Chapter 7, &#x8868;</h1>
<h2>7.1 &#x8868;&#x4ECB;&#x7ECD;</h2>
<p>Lua &#x8868;&#x672C;&#x8D28;&#x4E0A;&#x662F;&#x5173;&#x8054;&#x6570;&#x7EC4;, Associative Array, Dictionary, Map. &#x5B58;&#x653E;&#x7684;&#x662F;&#x4E24;&#x4E24;&#x5173;&#x8054;&#x7684;&#x952E;&#x503C;&#x5BF9;. &#x8868;&#x6709; Record &#x548C; List (&#x6570;&#x5B57;&#x4E0B;&#x6807;) &#x4E4B;&#x5206;.</p>
<h2>7.2 &#x8868;&#x5185;&#x90E8;&#x5B9E;&#x73B0;</h2>
<p>Lua &#x4F18;&#x5316;&#x4E86;&#x4F5C;&#x4E3A;&#x6570;&#x7EC4;&#x548C;Map&#x65F6;&#x7684;&#x5177;&#x4F53;&#x8868;&#x73B0;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> luaTable <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	metatable <span class="token operator">*</span>luaTable
	arr       <span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue
	_map      <span class="token keyword">map</span><span class="token punctuation">[</span>luaValue<span class="token punctuation">]</span>luaValue
	keys      <span class="token keyword">map</span><span class="token punctuation">[</span>luaValue<span class="token punctuation">]</span>luaValue <span class="token comment">// used by next()</span>
	lastKey   luaValue              <span class="token comment">// used by next()</span>
	changed   <span class="token builtin">bool</span>                  <span class="token comment">// used by next()</span>
<span class="token punctuation">}</span>

</pre><p>arr &#x5B58;&#x653E;&#x6570;&#x7EC4;, _map &#x5B58;&#x653E; Map. &#x7136;&#x540E;&#x662F;&#x521D;&#x59CB;&#x5316;&#x51FD;&#x6570;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">newLuaTable</span><span class="token punctuation">(</span>nArr<span class="token punctuation">,</span> nRec <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>luaTable <span class="token punctuation">{</span>
	t <span class="token operator">:=</span> <span class="token operator">&amp;</span>luaTable<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">if</span> nArr <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span>arr <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> nArr<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> nRec <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		t<span class="token punctuation">.</span>_map <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>luaValue<span class="token punctuation">]</span>luaValue<span class="token punctuation">,</span> nRec<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> t
<span class="token punctuation">}</span>
</pre><p>&#x53C2;&#x6570;&#x7528;&#x4E8E;&#x9884;&#x4F30;&#x957F;&#x5EA6;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>table <span class="token operator">*</span>luaTable<span class="token punctuation">)</span> <span class="token function">get</span><span class="token punctuation">(</span>key luaValue<span class="token punctuation">)</span> luaValue <span class="token punctuation">{</span>
	key <span class="token operator">=</span> <span class="token function">_floatToInteger</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> idx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> idx <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&lt;=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> table<span class="token punctuation">.</span>arr<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> table<span class="token punctuation">.</span>_map<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</pre><p>&#x5148;&#x8F6C;&#x6362;&#x6210;&#x6574;&#x6570;&#x7136;&#x540E;&#x67E5;&#x770B;&#x662F;&#x5426;&#x5728;&#x8303;&#x56F4;&#x5185;, &#x7136;&#x540E;&#x8FDB;&#x884C;&#x67E5;&#x627E;&#x503C;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">_floatToInteger</span><span class="token punctuation">(</span>key luaValue<span class="token punctuation">)</span> luaValue <span class="token punctuation">{</span>
	<span class="token keyword">if</span> f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> i<span class="token punctuation">,</span> ok <span class="token operator">:=</span> number<span class="token punctuation">.</span><span class="token function">FloatToInteger</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">return</span> i
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> key
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>table <span class="token operator">*</span>luaTable<span class="token punctuation">)</span> <span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> val luaValue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> key <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;table index is nil!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">float64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> math<span class="token punctuation">.</span><span class="token function">IsNaN</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;table index is NaN!&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	table<span class="token punctuation">.</span>changed <span class="token operator">=</span> <span class="token boolean">true</span>
	key <span class="token operator">=</span> <span class="token function">_floatToInteger</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
	<span class="token keyword">if</span> idx<span class="token punctuation">,</span> ok <span class="token operator">:=</span> key<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token builtin">int64</span><span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token operator">&amp;&amp;</span> idx <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		arrLen <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>arr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> idx <span class="token operator">&lt;=</span> arrLen <span class="token punctuation">{</span>
			table<span class="token punctuation">.</span>arr<span class="token punctuation">[</span>idx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
			<span class="token keyword">if</span> idx <span class="token operator">==</span> arrLen <span class="token operator">&amp;&amp;</span> val <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				table<span class="token punctuation">.</span><span class="token function">_shrinkArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> idx <span class="token operator">==</span> arrLen<span class="token operator">+</span><span class="token number">1</span> <span class="token punctuation">{</span>
			<span class="token function">delete</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>_map<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
			<span class="token keyword">if</span> val <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				table<span class="token punctuation">.</span>arr <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>arr<span class="token punctuation">,</span> val<span class="token punctuation">)</span>
				table<span class="token punctuation">.</span><span class="token function">_expandArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> val <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> table<span class="token punctuation">.</span>_map <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			table<span class="token punctuation">.</span>_map <span class="token operator">=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">map</span><span class="token punctuation">[</span>luaValue<span class="token punctuation">]</span>luaValue<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		table<span class="token punctuation">.</span>_map<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> val
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>table<span class="token punctuation">.</span>_map<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x8FD9;&#x91CC;&#x6D89;&#x53CA;&#x4E86; Lua &#x8868;&#x7684;&#x7279;&#x6027;.</p>
<h2>7.3 &#x8868;&#x76F8;&#x5173; API</h2>
<h1>Chapter 8, &#x51FD;&#x6570;&#x8C03;&#x7528;</h1>
<h2>8.1 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x4ECB;&#x7ECD;</h2>
<p>&#x51FD;&#x6570;&#x8C03;&#x7528;&#x6709;&#x4E00;&#x4E9B;&#x7279;&#x6027;:</p>
<ul>
<li>&#x4F20;&#x9012;&#x53C2;&#x6570;&#x5982;&#x679C;&#x7F3A;&#x5C11;&#x4F1A;&#x586B;&#x5165; nil, &#x5982;&#x679C;&#x8FC7;&#x591A;&#x4F1A;&#x5FFD;&#x7565;&#x6216;&#x8FDB;&#x5165;&#x53D8;&#x957F;&#x53C2;&#x6570;&#x5217;&#x8868;.</li>
<li>&#x652F;&#x6301;&#x53D8;&#x957F;&#x53C2;&#x6570;&#x5217;&#x8868; vararg.</li>
<li>&#x51FD;&#x6570;&#x53EF;&#x4EE5;&#x8FD4;&#x56DE;&#x4EFB;&#x610F;&#x6570;&#x91CF;&#x8FD4;&#x56DE;&#x503C;.</li>
<li>&#x8868;&#x8FBE;&#x5F0F;&#x6C42;&#x503C;&#x7279;&#x6027;.</li>
</ul>
<h2>8.2 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x6808;</h2>
<p>&#x540C;&#x6837;, &#x4E3A;&#x4E86;&#x5904;&#x7406;&#x8C03;&#x7528;&#x5173;&#x7CFB;, &#x7528;&#x4E86;&#x6808;&#x7684;&#x7ED3;&#x6784;&#x5BF9;&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x8FDB;&#x884C;&#x62BD;&#x8C61;.</p>
<h3>8.2.1 &#x8C03;&#x7528;&#x5E27;&#x5B9E;&#x73B0;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> luaStack <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">/* virtual stack */</span>
	slots <span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue
	top   <span class="token builtin">int</span>
	<span class="token comment">/* call info */</span>
	state   <span class="token operator">*</span>luaState
	closure <span class="token operator">*</span>closure
	varargs <span class="token punctuation">[</span><span class="token punctuation">]</span>luaValue
	openuvs <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token operator">*</span>upvalue
	pc      <span class="token builtin">int</span>
	<span class="token comment">/* linked list */</span>
	prev <span class="token operator">*</span>luaStack
<span class="token punctuation">}</span>
</pre><p>&#x65B0;&#x589E;&#x4E86; prev, closure, varargs, pc.</p>
<p>&#x7136;&#x540E;&#x5B9A;&#x4E49; closure &#x7ED3;&#x6784;&#x4F53;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> closure <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	proto  <span class="token operator">*</span>binchunk<span class="token punctuation">.</span>Prototype <span class="token comment">// lua closure</span>
	goFunc GoFunction          <span class="token comment">// go closure</span>
	upvals <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>upvalue
<span class="token punctuation">}</span>
</pre><p>proto &#x7528;&#x4E8E;&#x5B58;&#x653E;&#x51FD;&#x6570;&#x539F;&#x578B;.</p>
<h3>8.2.2 &#x8C03;&#x7528;&#x6808;&#x5B9E;&#x73B0;</h3>
<p>&#x8C03;&#x7528;&#x6808;&#x91C7;&#x7528;&#x94FE;&#x8868;&#x5B9E;&#x73B0;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">pushLuaStack</span><span class="token punctuation">(</span>stack <span class="token operator">*</span>luaStack<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	stack<span class="token punctuation">.</span>prev <span class="token operator">=</span> state<span class="token punctuation">.</span>stack
	state<span class="token punctuation">.</span>stack <span class="token operator">=</span> stack
	state<span class="token punctuation">.</span>callDepth<span class="token operator">++</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">popLuaStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	stack <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack
	state<span class="token punctuation">.</span>stack <span class="token operator">=</span> stack<span class="token punctuation">.</span>prev
	stack<span class="token punctuation">.</span>prev <span class="token operator">=</span> <span class="token boolean">nil</span>
	state<span class="token punctuation">.</span>callDepth<span class="token operator">--</span>
<span class="token punctuation">}</span>
</pre><h2>8.3 &#x51FD;&#x6570;&#x8C03;&#x7528; API</h2>
<h3>8.3.1 Load()</h3>
<p>load() &#x65B9;&#x6CD5;&#x52A0;&#x8F7D;&#x4E8C;&#x8FDB;&#x5236; chunk, &#x628A;&#x4E3B;&#x51FD;&#x6570;&#x539F;&#x578B;&#x5B9E;&#x4F8B;&#x5316;&#x4E3A;&#x95ED;&#x5305;&#x5E76;&#x63A8;&#x5165;&#x6808;&#x9876;. &#x8BE5;&#x65B9;&#x6CD5;&#x540C;&#x6837;&#x53EF;&#x4EE5;&#x52A0;&#x8F7D; Lua &#x811A;&#x672C;.<br>
&#x89E3;&#x6790;&#x6D41;&#x7A0B;&#x4E3A;&#x8BFB;&#x53D6;&#x6587;&#x4EF6;, &#x89E3;&#x6790;&#x4E3B;&#x51FD;&#x6570;&#x539F;&#x578B;, &#x5B9E;&#x4F8B;&#x5316;&#x4E3A;&#x95ED;&#x5305;, &#x63A8;&#x5165;&#x6808;&#x9876;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-0, +1, &#x2013;]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_load</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Load</span><span class="token punctuation">(</span>chunk <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> chunkName<span class="token punctuation">,</span> mode <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>status ThreadStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	status <span class="token operator">=</span> LUA_ERRSYNTAX

	<span class="token comment">// catch error</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> r <span class="token operator">:=</span> <span class="token function">recover</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">_getErrObj</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token keyword">var</span> proto <span class="token operator">*</span>binchunk<span class="token punctuation">.</span>Prototype
	<span class="token keyword">if</span> binchunk<span class="token punctuation">.</span><span class="token function">IsBinaryChunk</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">&quot;t&quot;</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to load a binary chunk (mode is &apos;&quot;</span> <span class="token operator">+</span> mode <span class="token operator">+</span> <span class="token string">&quot;&apos;)&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		proto <span class="token operator">=</span> binchunk<span class="token punctuation">.</span><span class="token function">Undump</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> mode <span class="token operator">==</span> <span class="token string">&quot;b&quot;</span> <span class="token punctuation">{</span>
			<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to load a text chunk (mode is &apos;&quot;</span> <span class="token operator">+</span> mode <span class="token operator">+</span> <span class="token string">&quot;&apos;)&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		proto <span class="token operator">=</span> compiler<span class="token punctuation">.</span><span class="token function">Compile</span><span class="token punctuation">(</span><span class="token function">string</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">,</span> chunkName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	c <span class="token operator">:=</span> <span class="token function">newLuaClosure</span><span class="token punctuation">(</span>proto<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>proto<span class="token punctuation">.</span>Upvalues<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		env <span class="token operator">:=</span> state<span class="token punctuation">.</span>registry<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>LUA_RIDX_GLOBALS<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span>upvals<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">&amp;</span>upvalue<span class="token punctuation">{</span><span class="token operator">&amp;</span>env<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>
	status <span class="token operator">=</span> LUA_OK
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</pre><h3>8.3.2 Call()</h3>
<p>&#x5C06;&#x88AB;&#x8C03;&#x7528;&#x51FD;&#x6570;&#x63A8;&#x5165;&#x6808;&#x9876;, &#x63A5;&#x7740;&#x63A8;&#x5165;&#x51FD;&#x6570;&#x53C2;&#x6570;, &#x5373;&#x53EF;&#x8C03;&#x7528; call(). &#x6267;&#x884C;&#x5B8C;&#x6BD5;&#x540E;&#x8FD9;&#x4E9B;&#x88AB;&#x5F39;&#x51FA;, &#x5E76;&#x5C06;&#x7ED3;&#x679C;&#x538B;&#x5165;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [-(nargs+1), +nresults, e]</span>
<span class="token comment">// http://www.lua.org/manual/5.3/manual.html#lua_call</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">Call</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> nResults <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	val <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>nArgs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	c<span class="token punctuation">,</span> ok <span class="token operator">:=</span> val<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>closure<span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> mf <span class="token operator">:=</span> <span class="token function">getMetafield</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">&quot;__call&quot;</span><span class="token punctuation">,</span> state<span class="token punctuation">)</span><span class="token punctuation">;</span> mf <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token keyword">if</span> c<span class="token punctuation">,</span> ok <span class="token operator">=</span> mf<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>closure<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
				state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
				state<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token punctuation">(</span>nArgs <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
				nArgs <span class="token operator">+=</span> <span class="token number">1</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> c<span class="token punctuation">.</span>proto <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span><span class="token function">callLuaClosure</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> nResults<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			state<span class="token punctuation">.</span><span class="token function">callGoClosure</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> nResults<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		typeName <span class="token operator">:=</span> state<span class="token punctuation">.</span><span class="token function">TypeName</span><span class="token punctuation">(</span><span class="token function">typeOf</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;attempt to call a &quot;</span> <span class="token operator">+</span> typeName <span class="token operator">+</span> <span class="token string">&quot; value&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>state.callLuaClosure() &#x5219;&#x5145;&#x5F53;&#x4E86;&#x51FD;&#x6570;&#x7684;&#x5B9E;&#x9645;&#x8C03;&#x7528;&#x8005;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">callLuaClosure</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> nResults <span class="token builtin">int</span><span class="token punctuation">,</span> c <span class="token operator">*</span>closure<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	nRegs <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>MaxStackSize<span class="token punctuation">)</span>
	nParams <span class="token operator">:=</span> <span class="token function">int</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>NumParams<span class="token punctuation">)</span>
	isVararg <span class="token operator">:=</span> c<span class="token punctuation">.</span>proto<span class="token punctuation">.</span>IsVararg <span class="token operator">==</span> <span class="token number">1</span>

	<span class="token comment">// create new lua stack</span>
	newStack <span class="token operator">:=</span> <span class="token function">newLuaStack</span><span class="token punctuation">(</span>nRegs<span class="token operator">+</span>LUA_MINSTACK<span class="token punctuation">,</span> state<span class="token punctuation">)</span>
	newStack<span class="token punctuation">.</span>closure <span class="token operator">=</span> c

	<span class="token comment">// pass args, pop func</span>
	funcAndArgs <span class="token operator">:=</span> state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">popN</span><span class="token punctuation">(</span>nArgs <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	newStack<span class="token punctuation">.</span><span class="token function">pushN</span><span class="token punctuation">(</span>funcAndArgs<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> nParams<span class="token punctuation">)</span>
	newStack<span class="token punctuation">.</span>top <span class="token operator">=</span> nRegs
	<span class="token keyword">if</span> nArgs <span class="token operator">&gt;</span> nParams <span class="token operator">&amp;&amp;</span> isVararg <span class="token punctuation">{</span>
		newStack<span class="token punctuation">.</span>varargs <span class="token operator">=</span> funcAndArgs<span class="token punctuation">[</span>nParams<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// run closure</span>
	state<span class="token punctuation">.</span><span class="token function">pushLuaStack</span><span class="token punctuation">(</span>newStack<span class="token punctuation">)</span>
	state<span class="token punctuation">.</span><span class="token function">runLuaClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	state<span class="token punctuation">.</span><span class="token function">popLuaStack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// return results</span>
	<span class="token keyword">if</span> nResults <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		results <span class="token operator">:=</span> newStack<span class="token punctuation">.</span><span class="token function">popN</span><span class="token punctuation">(</span>newStack<span class="token punctuation">.</span>top <span class="token operator">-</span> nRegs<span class="token punctuation">)</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">)</span>
		state<span class="token punctuation">.</span>stack<span class="token punctuation">.</span><span class="token function">pushN</span><span class="token punctuation">(</span>results<span class="token punctuation">,</span> nResults<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x8C03;&#x7528;&#x8FC7;&#x7A0B;&#x4E3A;&#x521B;&#x5EFA;&#x65B0;&#x7684; stack, &#x4F20;&#x5165;&#x53C2;&#x6570;, &#x5F39;&#x51FA;&#x76EE;&#x6807;&#x51FD;&#x6570;, &#x8FD0;&#x884C; closure, &#x6700;&#x540E;&#x5C06;&#x7ED3;&#x679C;&#x653E;&#x5165; stack.</p>
<p>state.runLuaClosure() &#x4E3A;&#x5185;&#x90E8;&#x6267;&#x884C;&#x5177;&#x4F53;&#x51FD;&#x6570;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>state <span class="token operator">*</span>luaState<span class="token punctuation">)</span> <span class="token function">runLuaClosure</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		inst <span class="token operator">:=</span> vm<span class="token punctuation">.</span><span class="token function">Instruction</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span><span class="token function">Fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		inst<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span>

		<span class="token comment">// indent := fmt.Sprintf(&quot;%%%ds&quot;, state.callDepth*2)</span>
		<span class="token comment">// fmt.Printf(indent+&quot;[%02d: %s] =&gt; %s\n&quot;,</span>
		<span class="token comment">// 	&quot;&quot;, pc+1, inst.OpName(), state)</span>

		<span class="token keyword">if</span> inst<span class="token punctuation">.</span><span class="token function">Opcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> vm<span class="token punctuation">.</span>OP_RETURN <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x8FD9;&#x91CC;&#x7684; state.Fetch() &#x6839;&#x636E; PC &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x6307;&#x4EE4;, &#x7136;&#x540E; inst.Execute() &#x6267;&#x884C;&#x6307;&#x4EE4;.</p>
<h2>8.4 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x6307;&#x4EE4;</h2>
<h3>8.4.1 closure</h3>
<p>closure &#x6307;&#x4EE4;, iBx &#x6A21;&#x5F0F;, &#x628A;&#x5F53;&#x524D;&#x51FD;&#x6570;&#x7684;&#x5B50;&#x51FD;&#x6570;&#x539F;&#x578B;&#x5B9E;&#x4F8B;&#x5316;&#x4E3A;&#x95ED;&#x5305;, &#x653E;&#x5165;&#x7531;&#x64CD;&#x4F5C;&#x6570; A &#x6307;&#x5B9A;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A) := closure(KPROTO[Bx])</span>
<span class="token keyword">func</span> <span class="token function">closure</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> bx <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">LoadProto</span><span class="token punctuation">(</span>bx<span class="token punctuation">)</span> <span class="token comment">// ~/closure</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>    <span class="token comment">// ~</span>
<span class="token punctuation">}</span>
</pre><h3>8.4.1 CALL</h3>
<p>call &#x6307;&#x4EE4;, iABC &#x6A21;&#x5F0F;, &#x8C03;&#x7528; Lua &#x51FD;&#x6570;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A), ... ,R(A+C-2) := R(A)(R(A+1), ... ,R(A+B-1))</span>
<span class="token keyword">func</span> <span class="token function">call</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">// println(&quot;:::&quot;+ vm.StackToString())</span>
	nArgs <span class="token operator">:=</span> <span class="token function">_pushFuncAndArgs</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> c<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token function">_popResults</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> c<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><h3>8.4.3 return</h3>
<p>return &#x6307;&#x4EE4;, iABC &#x6A21;&#x5F0F;, &#x628A;&#x5B58;&#x653E;&#x5728;&#x8FDE;&#x7EED;&#x591A;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x91CC;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x8FD4;&#x56DE;&#x7ED9;&#x4E3B;&#x8C03;&#x51FD;&#x6570;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// return R(A), ... ,R(A+B-2)</span>
<span class="token keyword">func</span> <span class="token function">_return</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token keyword">if</span> b <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token comment">// no return values</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> b <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token comment">// b-1 return values</span>
		vm<span class="token punctuation">.</span><span class="token function">CheckStack</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span> i <span class="token operator">:=</span> a<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> a<span class="token operator">+</span>b<span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
			vm<span class="token punctuation">.</span><span class="token function">PushValue</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token function">_fixStack</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x5176;&#x4E2D;&#x7B2C;&#x4E00;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570; A &#x6307;&#x5B9A;, &#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;&#x7531;&#x64CD;&#x4F5C;&#x6570; B &#x6307;&#x5B9A;.</p>
<h3>8.4.4 vararg</h3>
<p>vararg &#x6307;&#x4EE4;, iABC &#x6A21;&#x5F0F;, &#x628A;&#x4F20;&#x9012;&#x7ED9;&#x5F53;&#x524D;&#x51FD;&#x6570;&#x7684;&#x53D8;&#x957F;&#x53C2;&#x6570;&#x52A0;&#x8F7D;&#x5230;&#x8FDE;&#x7EED;&#x591A;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;. &#x64CD;&#x4F5C;&#x6570; A &#x6307;&#x5B9A;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;, &#x64CD;&#x4F5C;&#x6570; B &#x6307;&#x5B9A;&#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A), R(A+1), ..., R(A+B-2) = vararg</span>
<span class="token keyword">func</span> <span class="token function">vararg</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token keyword">if</span> b <span class="token operator">!=</span> <span class="token number">1</span> <span class="token punctuation">{</span> <span class="token comment">// b==0 or b&gt;1</span>
		vm<span class="token punctuation">.</span><span class="token function">LoadVararg</span><span class="token punctuation">(</span>b <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token function">_popResults</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>8.4.5 tailcall</h3>
<p>return f(args) &#x4F1A;&#x88AB;&#x4F18;&#x5316;&#x6210;&#x5C3E;&#x9012;&#x5F52;, &#x5373; tailcall &#x6307;&#x4EE4;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// return R(A)(R(A+1), ... ,R(A+B-1))</span>
<span class="token keyword">func</span> <span class="token function">tailCall</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>

	<span class="token comment">// todo: optimize tail call!</span>
	c <span class="token operator">:=</span> <span class="token number">0</span>
	nArgs <span class="token operator">:=</span> <span class="token function">_pushFuncAndArgs</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
	vm<span class="token punctuation">.</span><span class="token function">Call</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">,</span> c<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token function">_popResults</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> c<span class="token punctuation">,</span> vm<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><h3>8.4.6 self</h3>
<p>self &#x6307;&#x4EE4;, iABC &#x6A21;&#x5F0F;, &#x628A;&#x5BF9;&#x5411;&#x548C;&#x65B9;&#x6CD5;&#x62F7;&#x8D1D;&#x5230;&#x76F8;&#x90BB;&#x7684;&#x4E24;&#x4E2A;&#x76EE;&#x6807;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;. &#x5BF9;&#x8C61;&#x5728;&#x5BC4;&#x5B58;&#x5668;&#x4E2D;&#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570; B &#x6307;&#x5B9A;. &#x65B9;&#x6CD5;&#x540D;&#x5728;&#x5E38;&#x91CF;&#x8868;, &#x7D22;&#x5F15;&#x7531;&#x64CD;&#x4F5C;&#x6570; C &#x6307;&#x5B9A;. &#x76EE;&#x6807;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;&#x7531; A &#x6307;&#x5B9A;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// R(A+1) := R(B); R(A) := R(B)[RK(C)]</span>
<span class="token keyword">func</span> <span class="token function">self</span><span class="token punctuation">(</span>i Instruction<span class="token punctuation">,</span> vm LuaVM<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token operator">:=</span> i<span class="token punctuation">.</span><span class="token function">ABC</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	a <span class="token operator">+=</span> <span class="token number">1</span>
	b <span class="token operator">+=</span> <span class="token number">1</span>

	vm<span class="token punctuation">.</span><span class="token function">Copy</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> a<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span>

	<span class="token comment">//vm.CheckStack(1)</span>
	vm<span class="token punctuation">.</span><span class="token function">GetRK</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span>    <span class="token comment">// ~/rk[c]</span>
	vm<span class="token punctuation">.</span><span class="token function">GetTable</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token comment">// ~/r[b][rk[c]]</span>
	vm<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>  <span class="token comment">// ~</span>
<span class="token punctuation">}</span>

</pre><h3>8.4.7 &#x6269;&#x5C55; LuaVM &#x63A5;&#x53E3;</h3>
<h3>8.4.8 &#x6539;&#x8FDB; SETLIST&#x6307;&#x4EE4;</h3>
<h2>8.5 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>
<h2>8.6 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>
<h1>Chapter 14, &#x8BCD;&#x6CD5;&#x5206;&#x6790;</h1>
<h2>14.1 &#x7F16;&#x8BD1;&#x5668;&#x4ECB;&#x7ECD;</h2>
<h2>14.2 Lua &#x8BCD;&#x6CD5;&#x4ECB;&#x7ECD;</h2>
<h2>14.3 &#x5B9E;&#x73B0;&#x8BCD;&#x6CD5;&#x5206;&#x6790;&#x5668;</h2>
<p>Lexer &#x7ED3;&#x6784;&#x4F53;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> Lexer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	chunk         <span class="token builtin">string</span> <span class="token comment">// source code</span>
	chunkName     <span class="token builtin">string</span> <span class="token comment">// source name</span>
	line          <span class="token builtin">int</span>    <span class="token comment">// current line number</span>
	nextToken     <span class="token builtin">string</span>
	nextTokenKind <span class="token builtin">int</span>
	nextTokenLine <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</pre><p>&#x5B9A;&#x4E49; NextToken():</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>line<span class="token punctuation">,</span> kind <span class="token builtin">int</span><span class="token punctuation">,</span> token <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span>nextTokenLine <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		line <span class="token operator">=</span> lexer<span class="token punctuation">.</span>nextTokenLine
		kind <span class="token operator">=</span> lexer<span class="token punctuation">.</span>nextTokenKind
		token <span class="token operator">=</span> lexer<span class="token punctuation">.</span>nextToken
		lexer<span class="token punctuation">.</span>line <span class="token operator">=</span> lexer<span class="token punctuation">.</span>nextTokenLine
		lexer<span class="token punctuation">.</span>nextTokenLine <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	lexer<span class="token punctuation">.</span><span class="token function">skipWhiteSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_EOF<span class="token punctuation">,</span> <span class="token string">&quot;EOF&quot;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token string">&apos;;&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_SEMI<span class="token punctuation">,</span> <span class="token string">&quot;;&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;,&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_COMMA<span class="token punctuation">,</span> <span class="token string">&quot;,&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;(&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_LPAREN<span class="token punctuation">,</span> <span class="token string">&quot;(&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;)&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_RPAREN<span class="token punctuation">,</span> <span class="token string">&quot;)&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;]&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_RBRACK<span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;{&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_LCURLY<span class="token punctuation">,</span> <span class="token string">&quot;{&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;}&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_RCURLY<span class="token punctuation">,</span> <span class="token string">&quot;}&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;+&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_ADD<span class="token punctuation">,</span> <span class="token string">&quot;+&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;-&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_MINUS<span class="token punctuation">,</span> <span class="token string">&quot;-&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;*&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_MUL<span class="token punctuation">,</span> <span class="token string">&quot;*&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;^&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_POW<span class="token punctuation">,</span> <span class="token string">&quot;^&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;%&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_MOD<span class="token punctuation">,</span> <span class="token string">&quot;%&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;&amp;&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_BAND<span class="token punctuation">,</span> <span class="token string">&quot;&amp;&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;|&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_BOR<span class="token punctuation">,</span> <span class="token string">&quot;|&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;#&apos;</span><span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_LEN<span class="token punctuation">,</span> <span class="token string">&quot;#&quot;</span>
	<span class="token keyword">case</span> <span class="token string">&apos;:&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;::&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_LABEL<span class="token punctuation">,</span> <span class="token string">&quot;::&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_COLON<span class="token punctuation">,</span> <span class="token string">&quot;:&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;/&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;//&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_IDIV<span class="token punctuation">,</span> <span class="token string">&quot;//&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_DIV<span class="token punctuation">,</span> <span class="token string">&quot;/&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;~&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;~=&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_NE<span class="token punctuation">,</span> <span class="token string">&quot;~=&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_WAVE<span class="token punctuation">,</span> <span class="token string">&quot;~&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;=&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;==&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_EQ<span class="token punctuation">,</span> <span class="token string">&quot;==&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_ASSIGN<span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;&lt;&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;&lt;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_SHL<span class="token punctuation">,</span> <span class="token string">&quot;&lt;&lt;&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;=&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_LE<span class="token punctuation">,</span> <span class="token string">&quot;&lt;=&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_LT<span class="token punctuation">,</span> <span class="token string">&quot;&lt;&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;&gt;&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;&gt;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_SHR<span class="token punctuation">,</span> <span class="token string">&quot;&gt;&gt;&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;&gt;=&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_GE<span class="token punctuation">,</span> <span class="token string">&quot;&gt;=&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_GT<span class="token punctuation">,</span> <span class="token string">&quot;&gt;&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;.&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;...&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_VARARG<span class="token punctuation">,</span> <span class="token string">&quot;...&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;..&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_OP_CONCAT<span class="token punctuation">,</span> <span class="token string">&quot;..&quot;</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isDigit</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_DOT<span class="token punctuation">,</span> <span class="token string">&quot;.&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;[&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;[[&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;[=&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_STRING<span class="token punctuation">,</span> lexer<span class="token punctuation">.</span><span class="token function">scanLongString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_SEP_LBRACK<span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span>
		<span class="token punctuation">}</span>
	<span class="token keyword">case</span> <span class="token string">&apos;\&apos;&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;&quot;&apos;</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_STRING<span class="token punctuation">,</span> lexer<span class="token punctuation">.</span><span class="token function">scanShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	c <span class="token operator">:=</span> lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
	<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">&apos;.&apos;</span> <span class="token operator">||</span> <span class="token function">isDigit</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		token <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">scanNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_NUMBER<span class="token punctuation">,</span> token
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> c <span class="token operator">==</span> <span class="token string">&apos;_&apos;</span> <span class="token operator">||</span> <span class="token function">isLetter</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		token <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">scanIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> kind<span class="token punctuation">,</span> found <span class="token operator">:=</span> keywords<span class="token punctuation">[</span>token<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> token <span class="token comment">// keyword</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>line<span class="token punctuation">,</span> TOKEN_IDENTIFIER<span class="token punctuation">,</span> token
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;unexpected symbol near %q&quot;</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</pre><p>lexer.next(n) &#x7528;&#x4E8E;&#x8DF3;&#x8FC7;&#x6307;&#x5B9A;&#x4E2A;&#x6570;&#x7684;&#x5B57;&#x7B26;. &#x68C0;&#x6D4B;&#x5230;&#x662F;&#x6307;&#x5B9A;&#x7684;&#x5B57;&#x7B26;&#x6216;&#x5B57;&#x7B26;&#x5E8F;&#x5217;&#x540E;&#x8FD4;&#x56DE; token &#x7C7B;&#x578B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">test</span><span class="token punctuation">(</span>s <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> strings<span class="token punctuation">.</span><span class="token function">HasPrefix</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</pre><h3>14.3.1 &#x5B9A;&#x4E49; Token &#x7C7B;&#x578B;</h3>
<h3>14.3.2 &#x7A7A;&#x767D;&#x5B57;&#x7B26;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">skipWhiteSpaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;--&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">skipComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;\r\n&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;\n\r&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>
			lexer<span class="token punctuation">.</span>line <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">isNewLine</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			lexer<span class="token punctuation">.</span>line <span class="token operator">+=</span> <span class="token number">1</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token function">isWhiteSpace</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x8DF3;&#x8FC7;&#x7A7A;&#x767D;&#x548C;&#x6CE8;&#x91CA;.</p>
<h3>14.3.3 &#x6CE8;&#x91CA;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">skipComment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token comment">// skip --</span>

	<span class="token comment">// long comment ?</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;[&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> reOpeningLongBracket<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">scanLongString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// short comment</span>
	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isNewLine</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>14.3.4 &#x5206;&#x9694;&#x7B26;&#x548C;&#x8FD0;&#x7B97;&#x7B26;</h3>
<h3>14.3.5 &#x957F;&#x5B57;&#x7B26;&#x4E32;&#x5B57;&#x9762;&#x91CF;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">scanLongString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	openingLongBracket <span class="token operator">:=</span> reOpeningLongBracket<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span>
	<span class="token keyword">if</span> openingLongBracket <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;invalid long string delimiter near &apos;%s&apos;&quot;</span><span class="token punctuation">,</span>
			lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	closingLongBracket <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Replace</span><span class="token punctuation">(</span>openingLongBracket<span class="token punctuation">,</span> <span class="token string">&quot;[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]&quot;</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	closingLongBracketIdx <span class="token operator">:=</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">,</span> closingLongBracket<span class="token punctuation">)</span>
	<span class="token keyword">if</span> closingLongBracketIdx <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;unfinished long string or comment&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	str <span class="token operator">:=</span> lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>openingLongBracket<span class="token punctuation">)</span><span class="token punctuation">:</span>closingLongBracketIdx<span class="token punctuation">]</span>
	lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span>closingLongBracketIdx <span class="token operator">+</span> <span class="token function">len</span><span class="token punctuation">(</span>closingLongBracket<span class="token punctuation">)</span><span class="token punctuation">)</span>

	str <span class="token operator">=</span> reNewLine<span class="token punctuation">.</span><span class="token function">ReplaceAllString</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
	lexer<span class="token punctuation">.</span>line <span class="token operator">+=</span> strings<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">&apos;\n&apos;</span> <span class="token punctuation">{</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> str
<span class="token punctuation">}</span>
</pre><p>&#x5373;&#x53EF;&#x4EE5;&#x6362;&#x884C;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x5B57;&#x9762;&#x91CF;&#x7684;&#x63D0;&#x53D6;.</p>
<h3>14.3.6 &#x77ED;&#x5B57;&#x7B26;&#x4E32;&#x5B57;&#x9762;&#x91CF;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">var</span> reShortStr <span class="token operator">=</span> regexp<span class="token punctuation">.</span><span class="token function">MustCompile</span><span class="token punctuation">(</span><span class="token string">`(?s)(^&apos;(\\\\|\\&apos;|\\\n|\\z\s*|[^&apos;\n])*&apos;)|(^&quot;(\\\\|\\&quot;|\\\n|\\z\s*|[^&quot;\n])*&quot;)`</span><span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">scanShortString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> str <span class="token operator">:=</span> reShortStr<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span> str <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
		str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">1</span> <span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
		<span class="token keyword">if</span> strings<span class="token punctuation">.</span><span class="token function">Index</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> `\`<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span>line <span class="token operator">+=</span> <span class="token function">len</span><span class="token punctuation">(</span>reNewLine<span class="token punctuation">.</span><span class="token function">FindAllString</span><span class="token punctuation">(</span>str<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> lexer<span class="token punctuation">.</span><span class="token function">escape</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> str
	<span class="token punctuation">}</span>
	lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;unfinished string&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token string">&quot;&quot;</span>
<span class="token punctuation">}</span>
</pre><p>&#x7528;&#x6B63;&#x5219;&#x5339;&#x914D;&#x77ED;&#x5B57;&#x7B26;&#x4E32;&#x5B57;&#x9762;&#x91CF;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">escape</span><span class="token punctuation">(</span>str <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">string</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> buf bytes<span class="token punctuation">.</span>Buffer

	<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">&apos;\\&apos;</span> <span class="token punctuation">{</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;unfinished string&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">switch</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token string">&apos;a&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\a&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;b&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\b&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;f&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\f&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;n&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;\n&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\n&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;r&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\r&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;t&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\t&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;v&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\v&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;&quot;&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;&quot;&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;\&apos;&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\&apos;&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;\\&apos;</span><span class="token punctuation">:</span>
			buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token string">&apos;\\&apos;</span><span class="token punctuation">)</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">continue</span>
		<span class="token keyword">case</span> <span class="token string">&apos;0&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;1&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;2&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;3&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;4&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;5&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;6&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;7&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;8&apos;</span><span class="token punctuation">,</span> <span class="token string">&apos;9&apos;</span><span class="token punctuation">:</span> <span class="token comment">// \ddd</span>
			<span class="token keyword">if</span> found <span class="token operator">:=</span> reDecEscapeSeq<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
				d<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>found<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> d <span class="token operator">&lt;=</span> <span class="token number">0xFF</span> <span class="token punctuation">{</span>
					buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token function">byte</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
					str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
				lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;decimal escape too large near &apos;%s&apos;&quot;</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token string">&apos;x&apos;</span><span class="token punctuation">:</span> <span class="token comment">// \xXX</span>
			<span class="token keyword">if</span> found <span class="token operator">:=</span> reHexEscapeSeq<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
				d<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>found<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
				buf<span class="token punctuation">.</span><span class="token function">WriteByte</span><span class="token punctuation">(</span><span class="token function">byte</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
				str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
				<span class="token keyword">continue</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token string">&apos;u&apos;</span><span class="token punctuation">:</span> <span class="token comment">// \u{XXX}</span>
			<span class="token keyword">if</span> found <span class="token operator">:=</span> reUnicodeEscapeSeq<span class="token punctuation">.</span><span class="token function">FindString</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span> found <span class="token operator">!=</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
				d<span class="token punctuation">,</span> err <span class="token operator">:=</span> strconv<span class="token punctuation">.</span><span class="token function">ParseInt</span><span class="token punctuation">(</span>found<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> err <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> d <span class="token operator">&lt;=</span> <span class="token number">0x10FFFF</span> <span class="token punctuation">{</span>
					buf<span class="token punctuation">.</span><span class="token function">WriteRune</span><span class="token punctuation">(</span><span class="token function">rune</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
					str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>found<span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
					<span class="token keyword">continue</span>
				<span class="token punctuation">}</span>
				lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8 value too large near &apos;%s&apos;&quot;</span><span class="token punctuation">,</span> found<span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token keyword">case</span> <span class="token string">&apos;z&apos;</span><span class="token punctuation">:</span>
			str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token keyword">for</span> <span class="token function">len</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isWhiteSpace</span><span class="token punctuation">(</span>str<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// todo</span>
				str <span class="token operator">=</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>
		lexer<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;invalid escape sequence near &apos;\\%c&apos;&quot;</span><span class="token punctuation">,</span> str<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> buf<span class="token punctuation">.</span><span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><h3>14.3.7 &#x6570;&#x5B57;&#x5B57;&#x9762;&#x91CF;</h3>
<p>&#x540C;&#x6837;, &#x7528;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#x5B8C;&#x6210;.</p>
<h3>14.3.8 &#x6807;&#x8BC6;&#x7B26;&#x548C;&#x5173;&#x952E;&#x5B57;</h3>
<h2>14.4 LookAhead() &#x548C;&#x5176;&#x4ED6;&#x65B9;&#x6CD5;</h2>
<p>&#x4E0D;&#x8DF3;&#x8FC7;&#x5E76;&#x5224;&#x65AD;&#x4E0B;&#x4E00;&#x4E2A; token &#x662F;&#x4EC0;&#x4E48;&#x7C7B;&#x578B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span>nextTokenLine <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> lexer<span class="token punctuation">.</span>nextTokenKind
	<span class="token punctuation">}</span>
	currentLine <span class="token operator">:=</span> lexer<span class="token punctuation">.</span>line
	line<span class="token punctuation">,</span> kind<span class="token punctuation">,</span> token <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	lexer<span class="token punctuation">.</span>line <span class="token operator">=</span> currentLine
	lexer<span class="token punctuation">.</span>nextTokenLine <span class="token operator">=</span> line
	lexer<span class="token punctuation">.</span>nextTokenKind <span class="token operator">=</span> kind
	lexer<span class="token punctuation">.</span>nextToken <span class="token operator">=</span> token
	<span class="token keyword">return</span> kind
<span class="token punctuation">}</span>
</pre><h1>Chapter 15, &#x62BD;&#x8C61;&#x8BED;&#x6CD5;&#x6811;</h1>
<h2>15.1 &#x62BD;&#x8C61;&#x8BED;&#x6CD5;&#x6811;&#x4ECB;&#x7ECD;</h2>
<p>&#x901A;&#x5E38;&#x7528; EBNF (&#x6269;&#x5C55;&#x5DF4;&#x79D1;&#x65AF;&#x8303;&#x5F0F;, Extended Backus-Naur Form) &#x63CF;&#x8FF0;.</p>
<h2>15.2 Chunk &#x548C;&#x5757;</h2>
<p>chunk ::= block</p>
<p>block ::= {stat} [retstat]<br>
retstat ::= return [explist] [&apos;;&apos;]<br>
explist ::= exp {&apos;,&apos; exp}</p>
<p>{A} &#x8868;&#x793A; 0 &#x6216;&#x591A;&#x6B21;, [A] &#x8868;&#x793A; 0 &#x6216; 1 &#x6B21;.</p>
<p>Block &#x7ED3;&#x6784;&#x4F53;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">package</span> ast

<span class="token comment">// chunk ::= block</span>
<span class="token comment">// type Chunk *Block</span>

<span class="token comment">// block ::= {stat} [retstat]</span>
<span class="token comment">// retstat ::= return [explist] [&#x2018;;&#x2019;]</span>
<span class="token comment">// explist ::= exp {&#x2018;,&#x2019; exp}</span>
<span class="token keyword">type</span> Block <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	LastLine <span class="token builtin">int</span>
	Stats    <span class="token punctuation">[</span><span class="token punctuation">]</span>Stat
	RetExps  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
<span class="token punctuation">}</span>

</pre><h2>15.3 &#x8BED;&#x53E5;</h2>
<p>&#x5728;&#x547D;&#x4EE4;&#x5F0F;&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#x91CC;, &#x8BED;&#x53E5; (statement) &#x7684;&#x6700;&#x57FA;&#x672C;&#x7684;&#x6267;&#x884C;&#x5355;&#x4F4D;, &#x8868;&#x8FBE;&#x5F0F; (expression) &#x5219;&#x662F;&#x6784;&#x6210;&#x8BED;&#x53E5;&#x7684;&#x8981;&#x7D20;&#x4E4B;&#x4E00;. &#x8BED;&#x53E5;&#x53EA;&#x80FD;&#x6267;&#x884C;&#x4E0D;&#x80FD;&#x7528;&#x4E8E;&#x6C42;&#x503C;, &#x8868;&#x8FBE;&#x5F0F;&#x53EA;&#x80FD;&#x7528;&#x4E8E;&#x6C42;&#x503C;&#x4E0D;&#x80FD;&#x5355;&#x72EC;&#x6267;&#x884C;.</p>
<pre data-role="codeBlock" data-info="ebnf" class="language-ebnf"><code>stat ::= &apos;;&apos;
    | varlist &apos;=&apos; explist
    | functioncall
    | label
    | break
    | goto Name
    | do block end
    | while exp do block end
    | repeat block until end
    | if exp then block {elseif exp then block} [else block] end
    | for Name &apos;=&apos; exp &apos;,&apos; exp [&apos;,&apos; exp] do block end
    | for namelist in explist do block end
    | function funcname funcbody
    | local function Name funcbody
    | local namelist [&apos;=&apos; explist]
</code></pre><h3>15.3.1 &#x7B80;&#x5355;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> EmptyStat <span class="token keyword">struct</span><span class="token punctuation">{</span><span class="token punctuation">}</span>            <span class="token comment">// &#x2018;;&#x2019;</span>
<span class="token keyword">type</span> BreakStat <span class="token keyword">struct</span><span class="token punctuation">{</span> Line <span class="token builtin">int</span> <span class="token punctuation">}</span>  <span class="token comment">// break</span>
<span class="token keyword">type</span> DoStat <span class="token keyword">struct</span><span class="token punctuation">{</span> Block <span class="token operator">*</span>Block <span class="token punctuation">}</span> <span class="token comment">// do block end</span>
<span class="token keyword">type</span> FuncCallStat <span class="token operator">=</span> FuncCallExp    <span class="token comment">// functioncall</span>


</pre><h3>15.3.2 while &#x548C; repeat &#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="ENBF" class="language-enbf"><code>while exp do block end
repeat block until exp
</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// while exp do block end</span>
<span class="token keyword">type</span> WhileStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Exp   Exp
	Block <span class="token operator">*</span>Block
<span class="token punctuation">}</span>

<span class="token comment">// repeat block until exp</span>
<span class="token keyword">type</span> RepeatStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Block <span class="token operator">*</span>Block
	Exp   Exp
<span class="token punctuation">}</span>
</pre><p>&#x672C;&#x662F;&#x4E0A;&#x90FD;&#x662F;&#x5305;&#x542B;&#x4E00;&#x4E2A; exp &#x548C;&#x4E00;&#x4E2A; block.</p>
<h3>15.3.3 if &#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>if exp then block {elseif exp then block} [else block] end
</code></pre><p>&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x9700;&#x8981;&#x6539;&#x5199;&#x6210;:</p>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>if exp then block {elseif exp then block} [elseif true then block] end
</code></pre><p>&#x5982;&#x679C;&#x628A; elseif &#x5757;&#x5408;&#x5E76;, EBNF &#x53EF;&#x4EE5;&#x7B80;&#x5316;&#x4E3A;</p>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>if exp then block {elseif exp then block} end
</code></pre><p>&#x8FD9;&#x4E2A;&#x8F6C;&#x5316;&#x4F1A;&#x5728;&#x8BED;&#x6CD5;&#x5206;&#x6790;&#x9636;&#x6BB5;&#x8FDB;&#x884C;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// if exp then block {elseif exp then block} [else block] end</span>
<span class="token keyword">type</span> IfStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Exps   <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
	Blocks <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Block
<span class="token punctuation">}</span>
</pre><h3>15.3.4 &#x6570;&#x503C; for &#x5FAA;&#x73AF;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>for Name &apos;=&apos; exp &apos;,&apos; exp [&apos;,&apos; exp] do block end
</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// for Name &#x2018;=&#x2019; exp &#x2018;,&#x2019; exp [&#x2018;,&#x2019; exp] do block end</span>
<span class="token keyword">type</span> ForNumStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	LineOfFor <span class="token builtin">int</span>
	LineOfDo  <span class="token builtin">int</span>
	VarName   <span class="token builtin">string</span>
	InitExp   Exp
	LimitExp  Exp
	StepExp   Exp
	Block     <span class="token operator">*</span>Block
<span class="token punctuation">}</span>
</pre><h3>15.3.5 &#x901A;&#x7528; for &#x5FAA;&#x73AF;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>for namelist in explist do block end
namelist ::= Name {&apos;,&apos; Name}
explist ::= exp {&apos;,&apos; exp}
</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// for namelist in explist do block end</span>
<span class="token comment">// namelist ::= Name {&#x2018;,&#x2019; Name}</span>
<span class="token comment">// explist ::= exp {&#x2018;,&#x2019; exp}</span>
<span class="token keyword">type</span> ForInStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	LineOfDo <span class="token builtin">int</span>
	NameList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	ExpList  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
	Block    <span class="token operator">*</span>Block
<span class="token punctuation">}</span>


</pre><p>&#x8BB0;&#x5F55;&#x884C;&#x53F7;&#x57FA;&#x672C;&#x90FD;&#x662F;&#x4E3A;&#x4E86;&#x4EE3;&#x7801;&#x751F;&#x6210;.</p>
<h3>15.3.6 &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>local namelist [&apos;=&apos; explist]
namelist ::= Name {&apos;,&apos; Name}
explist ::= exp {&apos;,&apos; exp}
</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// local namelist [&#x2018;=&#x2019; explist]</span>
<span class="token comment">// namelist ::= Name {&#x2018;,&#x2019; Name}</span>
<span class="token comment">// explist ::= exp {&#x2018;,&#x2019; exp}</span>
<span class="token keyword">type</span> LocalVarDeclStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	LastLine <span class="token builtin">int</span>
	NameList <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	ExpList  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
<span class="token punctuation">}</span>
</pre><h3>15.3.7 &#x8D4B;&#x503C;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>varlist &#x2018;=&#x2019; explist
varlist ::= var {&#x2018;,&#x2019; var}
var ::=  Name | prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019; | prefixexp &#x2018;.&#x2019; Name
</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// varlist &#x2018;=&#x2019; explist</span>
<span class="token comment">// varlist ::= var {&#x2018;,&#x2019; var}</span>
<span class="token comment">// var ::=  Name | prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019; | prefixexp &#x2018;.&#x2019; Name</span>
<span class="token keyword">type</span> AssignStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	LastLine <span class="token builtin">int</span>
	VarList  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
	ExpList  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
<span class="token punctuation">}</span>

</pre><h3>15.3.8 &#x975E;&#x5C40;&#x90E8;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>function ::= function funcbody
funcname ::= Name {`.&#xB4; Name} [`:&#xB4; Name]
funcbody ::= `(&#xB4; [parlist] `)&#xB4; block end

</code></pre><h3>15.3.9 &#x5C40;&#x90E8;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;</h3>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>local function Name funcbody 
</code></pre><p><code>local function f (params) body end</code> &#x4F1A;&#x88AB;&#x8F6C;&#x5316;&#x4E3A; <code>local f; f = function (params) body end</code></p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// local function Name funcbody</span>
<span class="token keyword">type</span> LocalFuncDefStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
	Exp  <span class="token operator">*</span>FuncDefExp
<span class="token punctuation">}</span>

</pre><h2 class="mume-header" id="154-%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4 &#x8868;&#x8FBE;&#x5F0F;</h2>

<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>exp ::=  nil | false | true | Number | String | `...&#xB4; | function | prefixexp | tableconstructor | exp binop exp | unop exp 
</code></pre><h3 class="mume-header" id="1541-%E7%AE%80%E5%8D%95%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.1 &#x7B80;&#x5355;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> NilExp <span class="token keyword">struct</span><span class="token punctuation">{</span> Line <span class="token builtin">int</span> <span class="token punctuation">}</span>    <span class="token comment">// nil</span>
<span class="token keyword">type</span> TrueExp <span class="token keyword">struct</span><span class="token punctuation">{</span> Line <span class="token builtin">int</span> <span class="token punctuation">}</span>   <span class="token comment">// true</span>
<span class="token keyword">type</span> FalseExp <span class="token keyword">struct</span><span class="token punctuation">{</span> Line <span class="token builtin">int</span> <span class="token punctuation">}</span>  <span class="token comment">// false</span>
<span class="token keyword">type</span> VarargExp <span class="token keyword">struct</span><span class="token punctuation">{</span> Line <span class="token builtin">int</span> <span class="token punctuation">}</span> <span class="token comment">// ...</span>

<span class="token comment">// Numeral</span>
<span class="token keyword">type</span> IntegerExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line <span class="token builtin">int</span>
	Val  <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> FloatExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line <span class="token builtin">int</span>
	Val  <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token comment">// LiteralString</span>
<span class="token keyword">type</span> StringExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line <span class="token builtin">int</span>
	Str  <span class="token builtin">string</span>
<span class="token punctuation">}</span>
</pre><p>&#x57FA;&#x672C;&#x90FD;&#x5305;&#x542B;&#x884C;&#x53F7;, &#x6709;&#x503C;&#x7684;&#x5305;&#x542B;&#x503C;.</p>
<h3 class="mume-header" id="1542-%E8%BF%90%E7%AE%97%E7%AC%A6%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.2 &#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// unop exp</span>
<span class="token keyword">type</span> UnopExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line <span class="token builtin">int</span> <span class="token comment">// line of operator</span>
	Op   <span class="token builtin">int</span> <span class="token comment">// operator</span>
	Exp  Exp
<span class="token punctuation">}</span>

<span class="token comment">// exp1 op exp2</span>
<span class="token keyword">type</span> BinopExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line <span class="token builtin">int</span> <span class="token comment">// line of operator</span>
	Op   <span class="token builtin">int</span> <span class="token comment">// operator</span>
	Exp1 Exp
	Exp2 Exp
<span class="token punctuation">}</span>

<span class="token keyword">type</span> ConcatExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line <span class="token builtin">int</span> <span class="token comment">// line of last ..</span>
	Exps <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
<span class="token punctuation">}</span>

</pre><h3 class="mume-header" id="1543-%E8%A1%A8%E6%9E%84%E9%80%A0%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.3 &#x8868;&#x6784;&#x9020;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// tableconstructor ::= &#x2018;{&#x2019; [fieldlist] &#x2018;}&#x2019;</span>
<span class="token comment">// fieldlist ::= field {fieldsep field} [fieldsep]</span>
<span class="token comment">// field ::= &#x2018;[&#x2019; exp &#x2018;]&#x2019; &#x2018;=&#x2019; exp | Name &#x2018;=&#x2019; exp | exp</span>
<span class="token comment">// fieldsep ::= &#x2018;,&#x2019; | &#x2018;;&#x2019;</span>
<span class="token keyword">type</span> TableConstructorExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line     <span class="token builtin">int</span> <span class="token comment">// line of `{` ?</span>
	LastLine <span class="token builtin">int</span> <span class="token comment">// line of `}`</span>
	KeyExps  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
	ValExps  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1544-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.4 &#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// functiondef ::= function funcbody</span>
<span class="token comment">// funcbody ::= &#x2018;(&#x2019; [parlist] &#x2018;)&#x2019; block end</span>
<span class="token comment">// parlist ::= namelist [&#x2018;,&#x2019; &#x2018;...&#x2019;] | &#x2018;...&#x2019;</span>
<span class="token comment">// namelist ::= Name {&#x2018;,&#x2019; Name}</span>
<span class="token keyword">type</span> FuncDefExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line     <span class="token builtin">int</span>
	LastLine <span class="token builtin">int</span> <span class="token comment">// line of `end`</span>
	ParList  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span>
	IsVararg <span class="token builtin">bool</span>
	Block    <span class="token operator">*</span>Block
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1545-%E5%89%8D%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.5 &#x524D;&#x7F00;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>/*
prefixexp ::= Name |
              &#x2018;(&#x2019; exp &#x2018;)&#x2019; |
              prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019; |
              prefixexp &#x2018;.&#x2019; Name |
              prefixexp &#x2018;:&#x2019; Name args |
              prefixexp args
*/
</code></pre><h3 class="mume-header" id="1546-%E5%9C%86%E6%8B%AC%E5%8F%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.6 &#x5706;&#x62EC;&#x53F7;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> ParensExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Exp Exp
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1547-%E8%A1%A8%E8%AE%BF%E9%97%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.7 &#x8868;&#x8BBF;&#x95EE;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> TableAccessExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	LastLine  <span class="token builtin">int</span> <span class="token comment">// line of `]` ?</span>
	PrefixExp Exp
	KeyExp    Exp
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1548-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.8 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>functioncall ::=  prefixexp args | prefixexp `:&#xB4; Name args 
args ::=  `(&#xB4; [explist] `)&#xB4; | tableconstructor | String 

</code></pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> FuncCallExp <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Line      <span class="token builtin">int</span> <span class="token comment">// line of `(` ?</span>
	LastLine  <span class="token builtin">int</span> <span class="token comment">// line of &apos;)&apos;</span>
	PrefixExp Exp
	NameExp   <span class="token operator">*</span>StringExp
	Args      <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
<span class="token punctuation">}</span>

</pre><h2 class="mume-header" id="155-%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93">15.5 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>

<p>&#x8FD9;&#x91CC;&#x662F; lua &#x8BED;&#x6CD5;&#x7684; EBNF &#x6C47;&#x603B;:</p>
<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>chunk = {stat [`;&#xB4;]} [laststat [`;&#xB4;]].

block ::= chunk

stat ::=  varlist `=&#xB4; explist | 
     functioncall | 
     do block end | 
     while exp do block end | 
     repeat block until exp | 
     if exp then block {elseif exp then block} [else block] end | 
     for Name `=&#xB4; exp `,&#xB4; exp [`,&#xB4; exp] do block end | 
     for namelist in explist do block end | 
     function funcname funcbody | 
     local function Name funcbody | 
     local namelist [`=&#xB4; explist] 

laststat ::= return [explist] | break

funcname ::= Name {`.&#xB4; Name} [`:&#xB4; Name]

varlist ::= var {`,&#xB4; var}

var ::=  Name | prefixexp `[&#xB4; exp `]&#xB4; | prefixexp `.&#xB4; Name 

namelist ::= Name {`,&#xB4; Name}

explist ::= {exp `,&#xB4;} exp

exp ::=  nil | false | true | Number | String | `...&#xB4; | function | prefixexp | tableconstructor | exp binop exp | unop exp 

prefixexp ::= var | functioncall | `(&#xB4; exp `)&#xB4;

functioncall ::=  prefixexp args | prefixexp `:&#xB4; Name args 

args ::=  `(&#xB4; [explist] `)&#xB4; | tableconstructor | String 

function ::= function funcbody

funcbody ::= `(&#xB4; [parlist] `)&#xB4; block end

parlist ::= namelist [`,&#xB4; `...&#xB4;] | `...&#xB4;

tableconstructor ::= `{&#xB4; [fieldlist] `}&#xB4;

fieldlist ::= field {fieldsep field} [fieldsep]

field ::= `[&#xB4; exp `]&#xB4; `=&#xB4; exp | Name `=&#xB4; exp | exp

fieldsep ::= `,&#xB4; | `;&#xB4;

binop ::= `+&#xB4; | `-&#xB4; | `*&#xB4; | `/&#xB4; | `^&#xB4; | `%&#xB4; | `..&#xB4; | `&lt;&#xB4; | `&lt;=&#xB4; | `&gt;&#xB4; | `&gt;=&#xB4; | `==&#xB4; | `~=&#xB4; | and | or

unop ::= `-&#xB4; | not | `#&#xB4;
</code></pre><p>&#x539F;&#x59CB;&#x6587;&#x6863;&#x5728;: <a href="http://www.lua.org/manual/5.1/manual.html#8">http://www.lua.org/manual/5.1/manual.html#8</a></p>
<h1 class="mume-header" id="chapter-16-%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90">Chapter 16, &#x8BED;&#x6CD5;&#x5206;&#x6790;</h1>

<h2 class="mume-header" id="161-%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E4%BB%8B%E7%BB%8D">16.1 &#x8BED;&#x6CD5;&#x5206;&#x6790;&#x4ECB;&#x7ECD;</h2>

<h3 class="mume-header" id="1611-%E6%AD%A7%E4%B9%89">16.1.1 &#x6B67;&#x4E49;</h3>

<p>&#x8BB2;&#x4E86; C &#x8BED;&#x8A00; EBNF &#x63CF;&#x8FF0;&#x4E2D; if else &#x5D4C;&#x5957;&#x60C5;&#x51B5;&#x4E0B;&#x7684;&#x6B67;&#x4E49;&#x95EE;&#x9898;. C &#x8BED;&#x8A00;&#x662F;&#x901A;&#x8FC7;&#x5B9A;&#x4E49; else &#x4E0E;&#x6700;&#x8FD1;&#x7684; if &#x7ED3;&#x5408;&#x6765;&#x907F;&#x514D;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#x7684;.</p>
<p>Lua &#x4E8C;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x5219;&#x662F;&#x901A;&#x8FC7;&#x8FD0;&#x7B97;&#x4F18;&#x5148;&#x7EA7;&#x89E3;&#x51B3;&#x6B67;&#x4E49;&#x7684;.</p>
<h3 class="mume-header" id="1612-%E5%89%8D%E7%9E%BB%E5%92%8C%E5%9B%9E%E6%BA%AF">16.1.2 &#x524D;&#x77BB;&#x548C;&#x56DE;&#x6EAF;</h3>

<p>&#x5982;&#x679C;&#x4E0A;&#x4E0B;&#x6587;&#x65E0;&#x5173;&#x8BED;&#x8A00; L &#x4E0D;&#x9700;&#x8981;&#x501F;&#x52A9;&#x56DE;&#x6EAF;&#x5C31;&#x53EF;&#x4EE5;&#x5B8C;&#x6210;&#x89E3;&#x6790;, &#x90A3;&#x4E48;&#x6210;&#x4E3A;&#x786E;&#x5B9A;&#x6027; (Deterministic) &#x8BED;&#x8A00;. &#x786E;&#x5B9A;&#x6027;&#x8BED;&#x8A00;&#x4E00;&#x5B9A;&#x6CA1;&#x6709;&#x6B67;&#x4E49;. &#x4E0A;&#x4E0B;&#x6587;&#x65E0;&#x5173;&#x5305;&#x542B;&#x65E0;&#x6B67;&#x4E49;&#x5305;&#x542B;&#x786E;&#x5B9A;&#x6027;.</p>
<h3 class="mume-header" id="1613-%E8%A7%A3%E6%9E%90%E6%96%B9%E5%BC%8F">16.1.3 &#x89E3;&#x6790;&#x65B9;&#x5F0F;</h3>

<p>&#x4F7F;&#x7528;&#x81EA;&#x9876;&#x5411;&#x4E0B; (Top-Down) &#x65B9;&#x6CD5;&#x4E0E;&#x4F7F;&#x7528;&#x81EA;&#x5E95;&#x5411;&#x4E0A; (Bottom-Up) &#x90FD;&#x53EF;&#x4EE5;&#x6784;&#x9020;&#x8BED;&#x6CD5;&#x6811;. &#x81EA;&#x5E95;&#x5411;&#x4E0A;&#x5305;&#x62EC; LR &#x89E3;&#x6790;&#x5668;&#x548C; CYK &#x89E3;&#x6790;&#x5668;&#x7B49;. &#x81EA;&#x9876;&#x5411;&#x4E0B;&#x89E3;&#x6790;&#x5668;&#x5305;&#x62EC; LL &#x89E3;&#x6790;&#x5668;&#x548C;***&#x9012;&#x5F52;&#x4E0B;&#x964D; (Recursive Descent Parser) &#x89E3;&#x6790;&#x5668;***</p>
<h3 class="mume-header" id="162-%E8%A7%A3%E6%9E%90%E5%9D%97">16.2 &#x89E3;&#x6790;&#x5757;</h3>

<p>Lua &#x811A;&#x672C;&#x5B9E;&#x9645;&#x4E0A;&#x5C31;&#x662F;&#x4E2A;&#x4EE3;&#x7801;&#x5757;, &#x89E3;&#x6790;&#x7ED3;&#x679C;&#x5E94;&#x8BE5;&#x662F;&#x4E00;&#x4E2A; Block &#x7ED3;&#x6784;&#x4F53;&#x5B9E;&#x4F8B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// block ::= {stat} [retstat]</span>
<span class="token keyword">func</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>Block <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>Block<span class="token punctuation">{</span>
		Stats<span class="token punctuation">:</span>    <span class="token function">parseStats</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">,</span>
		RetExps<span class="token punctuation">:</span>  <span class="token function">parseRetExps</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">,</span>
		LastLine<span class="token punctuation">:</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>parseStats() &#x89E3;&#x6790;&#x8BED;&#x53E5;&#x5E8F;&#x5217;, parseRetExps() &#x89E3;&#x6790;&#x53EF;&#x9009;&#x7684;&#x8FD4;&#x56DE;&#x8BED;&#x53E5;, &#x5E76;&#x8BB0;&#x5F55;&#x672B;&#x5C3E;&#x884C;&#x53F7;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">parseStats</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Stat <span class="token punctuation">{</span>
	stats <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Stat<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token operator">!</span><span class="token function">_isReturnOrBlockEnd</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		stat <span class="token operator">:=</span> <span class="token function">parseStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token boolean">_</span><span class="token punctuation">,</span> ok <span class="token operator">:=</span> stat<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>EmptyStat<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token operator">!</span>ok <span class="token punctuation">{</span>
			stats <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>stats<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> stats
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">_isReturnOrBlockEnd</span><span class="token punctuation">(</span>tokenKind <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> tokenKind <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_KW_RETURN<span class="token punctuation">,</span> TOKEN_EOF<span class="token punctuation">,</span> TOKEN_KW_END<span class="token punctuation">,</span>
		TOKEN_KW_ELSE<span class="token punctuation">,</span> TOKEN_KW_ELSEIF<span class="token punctuation">,</span> TOKEN_KW_UNTIL<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>
</pre><p>_isReturnOrBlockEnd &#x786E;&#x5B9A;&#x4E86; block &#x7684;&#x7ED3;&#x675F;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// retstat ::= return [explist] [&#x2018;;&#x2019;]</span>
<span class="token comment">// explist ::= exp {&#x2018;,&#x2019; exp}</span>
<span class="token keyword">func</span> <span class="token function">parseRetExps</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp <span class="token punctuation">{</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> TOKEN_KW_RETURN <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span>
	<span class="token punctuation">}</span>

	lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_EOF<span class="token punctuation">,</span> TOKEN_KW_END<span class="token punctuation">,</span>
		TOKEN_KW_ELSE<span class="token punctuation">,</span> TOKEN_KW_ELSEIF<span class="token punctuation">,</span> TOKEN_KW_UNTIL<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">case</span> TOKEN_SEP_SEMI<span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		exps <span class="token operator">:=</span> <span class="token function">parseExpList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_SEMI <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> exps
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x63A5;&#x4E0B;&#x6765;&#x662F;&#x8868;&#x8FBE;&#x5F0F;&#x7684; parser</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// explist ::= exp {&#x2018;,&#x2019; exp}</span>
<span class="token keyword">func</span> <span class="token function">parseExpList</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp <span class="token punctuation">{</span>
	exps <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	exps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exps<span class="token punctuation">,</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COMMA <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		exps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exps<span class="token punctuation">,</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> exps
<span class="token punctuation">}</span>
</pre><h2 class="mume-header" id="163-%E8%A7%A3%E6%9E%90%E8%AF%AD%E5%8F%A5">16.3 &#x89E3;&#x6790;&#x8BED;&#x53E5;</h2>

<pre data-role="codeBlock" data-info="EBNF" class="language-ebnf"><code>stat ::=  varlist `=&#xB4; explist | 
     functioncall | 
     do block end | 
     while exp do block end | 
     repeat block until exp | 
     if exp then block {elseif exp then block} [else block] end | 
     for Name `=&#xB4; exp `,&#xB4; exp [`,&#xB4; exp] do block end | 
     for namelist in explist do block end | 
     function funcname funcbody | 
     local function Name funcbody | 
     local namelist [`=&#xB4; explist] 

</code></pre><p>&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x9700;&#x8981;&#x5927;&#x91CF;&#x524D;&#x77BB;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
stat ::=  &#x2018;;&#x2019;
	| break
	| &#x2018;::&#x2019; Name &#x2018;::&#x2019;
	| goto Name
	| do block end
	| while exp do block end
	| repeat block until exp
	| if exp then block {elseif exp then block} [else block] end
	| for Name &#x2018;=&#x2019; exp &#x2018;,&#x2019; exp [&#x2018;,&#x2019; exp] do block end
	| for namelist in explist do block end
	| function funcname funcbody
	| local function Name funcbody
	| local namelist [&#x2018;=&#x2019; explist]
	| varlist &#x2018;=&#x2019; explist
	| functioncall
*/</span>
<span class="token keyword">func</span> <span class="token function">parseStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Stat <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_SEP_SEMI<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseEmptyStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_BREAK<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseBreakStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_SEP_LABEL<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseLabelStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_GOTO<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseGotoStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_DO<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseDoStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_WHILE<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseWhileStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_REPEAT<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseRepeatStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_IF<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseIfStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_FOR<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseForStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_FUNCTION<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseFuncDefStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_LOCAL<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseLocalAssignOrFuncDefStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">parseAssignOrFuncCallStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x5373;&#x8FDB;&#x884C;&#x4E00;&#x6B21;&#x524D;&#x77BB;, &#x7136;&#x540E;&#x5C1D;&#x8BD5;&#x8FDB;&#x884C;&#x5339;&#x914D;.</p>
<h3 class="mume-header" id="1631-%E7%AE%80%E5%8D%95%E8%AF%AD%E5%8F%A5">16.3.1 &#x7B80;&#x5355;&#x8BED;&#x53E5;</h3>

<p>&#x5305;&#x62EC; &#x7A7A;&#x8BED;&#x53E5;, break, label goto, do, while, repeat.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// ;</span>
<span class="token keyword">func</span> <span class="token function">parseEmptyStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>EmptyStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_SEMI<span class="token punctuation">)</span>
	<span class="token keyword">return</span> _statEmpty
<span class="token punctuation">}</span>

<span class="token comment">// break</span>
<span class="token keyword">func</span> <span class="token function">parseBreakStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>BreakStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_BREAK<span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>BreakStat<span class="token punctuation">{</span>lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// &#x2018;::&#x2019; Name &#x2018;::&#x2019;</span>
<span class="token keyword">func</span> <span class="token function">parseLabelStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>LabelStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_LABEL<span class="token punctuation">)</span> <span class="token comment">// ::</span>
	line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>   <span class="token comment">// name</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_LABEL<span class="token punctuation">)</span> <span class="token comment">// ::</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>LabelStat<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// goto Name</span>
<span class="token keyword">func</span> <span class="token function">parseGotoStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>GotoStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_GOTO<span class="token punctuation">)</span> <span class="token comment">// goto</span>
	line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// name</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>GotoStat<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// do block end</span>
<span class="token keyword">func</span> <span class="token function">parseDoStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>DoStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_DO<span class="token punctuation">)</span>  <span class="token comment">// do</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>          <span class="token comment">// block</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_END<span class="token punctuation">)</span> <span class="token comment">// end</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>DoStat<span class="token punctuation">{</span>block<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// while exp do block end</span>
<span class="token keyword">func</span> <span class="token function">parseWhileStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>WhileStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_WHILE<span class="token punctuation">)</span> <span class="token comment">// while</span>
	exp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                <span class="token comment">// exp</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_DO<span class="token punctuation">)</span>    <span class="token comment">// do</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>            <span class="token comment">// block</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_END<span class="token punctuation">)</span>   <span class="token comment">// end</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>WhileStat<span class="token punctuation">{</span>exp<span class="token punctuation">,</span> block<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// repeat block until exp</span>
<span class="token keyword">func</span> <span class="token function">parseRepeatStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>RepeatStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_REPEAT<span class="token punctuation">)</span> <span class="token comment">// repeat</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>             <span class="token comment">// block</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_UNTIL<span class="token punctuation">)</span>  <span class="token comment">// until</span>
	exp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                 <span class="token comment">// exp</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>RepeatStat<span class="token punctuation">{</span>block<span class="token punctuation">,</span> exp<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x5177;&#x4F53;&#x5904;&#x7406;&#x903B;&#x8F91;.</p>
<p>&#x8FD9;&#x91CC;&#x7684; parseBlock() &#x4E0E; parseDoStat() &#x4E92;&#x76F8;&#x8C03;&#x7528;, &#x56E0;&#x6B64;&#x88AB;&#x79F0;&#x4F5C;&#x9012;&#x5F52;&#x4E0B;&#x964D;.</p>
<h3 class="mume-header" id="1632-if-%E8%AF%AD%E5%8F%A5">16.3.2 if &#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// if exp then block {elseif exp then block} [else block] end</span>
<span class="token keyword">type</span> IfStat <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Exps   <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp
	Blocks <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Block
<span class="token punctuation">}</span>

<span class="token comment">// if exp then block {elseif exp then block} [else block] end</span>
<span class="token keyword">func</span> <span class="token function">parseIfStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>IfStat <span class="token punctuation">{</span>
	exps <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>
	blocks <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Block<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span>

	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_IF<span class="token punctuation">)</span>         <span class="token comment">// if</span>
	exps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exps<span class="token punctuation">,</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">// exp</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_THEN<span class="token punctuation">)</span>       <span class="token comment">// then</span>
	blocks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// block</span>

	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_KW_ELSEIF <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                          <span class="token comment">// elseif</span>
		exps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exps<span class="token punctuation">,</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span>       <span class="token comment">// exp</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_THEN<span class="token punctuation">)</span>       <span class="token comment">// then</span>
		blocks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// block</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// else block =&gt; elseif true then block</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_KW_ELSE <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                           <span class="token comment">// else</span>
		exps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exps<span class="token punctuation">,</span> <span class="token operator">&amp;</span>TrueExp<span class="token punctuation">{</span>lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//</span>
		blocks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>blocks<span class="token punctuation">,</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment">// block</span>
	<span class="token punctuation">}</span>

	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_END<span class="token punctuation">)</span> <span class="token comment">// end</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>IfStat<span class="token punctuation">{</span>exps<span class="token punctuation">,</span> blocks<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x6E90;&#x7801;&#x5199;&#x7684;&#x5F88;&#x6D41;&#x7545;.</p>
<h3 class="mume-header" id="1633-for-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5">16.3.3 for &#x5FAA;&#x73AF;&#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// for Name &#x2018;=&#x2019; exp &#x2018;,&#x2019; exp [&#x2018;,&#x2019; exp] do block end</span>
<span class="token comment">// for namelist in explist do block end</span>
<span class="token keyword">func</span> <span class="token function">parseForStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Stat <span class="token punctuation">{</span>
	lineOfFor<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_FOR<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_OP_ASSIGN <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">_finishForNumStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> lineOfFor<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">_finishForInStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// for Name &#x2018;=&#x2019; exp &#x2018;,&#x2019; exp [&#x2018;,&#x2019; exp] do block end</span>
<span class="token keyword">func</span> <span class="token function">_finishForNumStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> lineOfFor <span class="token builtin">int</span><span class="token punctuation">,</span> varName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>ForNumStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_OP_ASSIGN<span class="token punctuation">)</span> <span class="token comment">// for name =</span>
	initExp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>             <span class="token comment">// exp</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_COMMA<span class="token punctuation">)</span> <span class="token comment">// ,</span>
	limitExp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>            <span class="token comment">// exp</span>

	<span class="token keyword">var</span> stepExp Exp
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COMMA <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>         <span class="token comment">// ,</span>
		stepExp <span class="token operator">=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span> <span class="token comment">// exp</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		stepExp <span class="token operator">=</span> <span class="token operator">&amp;</span>IntegerExp<span class="token punctuation">{</span>lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	lineOfDo<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_DO<span class="token punctuation">)</span> <span class="token comment">// do</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                        <span class="token comment">// block</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_END<span class="token punctuation">)</span>               <span class="token comment">// end</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ForNumStat<span class="token punctuation">{</span>lineOfFor<span class="token punctuation">,</span> lineOfDo<span class="token punctuation">,</span>
		varName<span class="token punctuation">,</span> initExp<span class="token punctuation">,</span> limitExp<span class="token punctuation">,</span> stepExp<span class="token punctuation">,</span> block<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// for namelist in explist do block end</span>
<span class="token comment">// namelist ::= Name {&#x2018;,&#x2019; Name}</span>
<span class="token comment">// explist ::= exp {&#x2018;,&#x2019; exp}</span>
<span class="token keyword">func</span> <span class="token function">_finishForInStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> name0 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>ForInStat <span class="token punctuation">{</span>
	nameList <span class="token operator">:=</span> <span class="token function">_finishNameList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> name0<span class="token punctuation">)</span>         <span class="token comment">// for namelist</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_IN<span class="token punctuation">)</span>                <span class="token comment">// in</span>
	expList <span class="token operator">:=</span> <span class="token function">parseExpList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                    <span class="token comment">// explist</span>
	lineOfDo<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_DO<span class="token punctuation">)</span> <span class="token comment">// do</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                        <span class="token comment">// block</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_END<span class="token punctuation">)</span>               <span class="token comment">// end</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ForInStat<span class="token punctuation">{</span>lineOfDo<span class="token punctuation">,</span> nameList<span class="token punctuation">,</span> expList<span class="token punctuation">,</span> block<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// namelist ::= Name {&#x2018;,&#x2019; Name}</span>
<span class="token keyword">func</span> <span class="token function">_finishNameList</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> name0 <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	names <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>name0<span class="token punctuation">}</span>
	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COMMA <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                 <span class="token comment">// ,</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Name</span>
		names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> names
<span class="token punctuation">}</span>

</pre><h3 class="mume-header" id="1634-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%92%8C%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E8%AF%AD%E5%8F%A5">16.3.4 &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x548C;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;</h3>

<p>&#x5373; local &#x8BED;&#x53E5;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// local function Name funcbody</span>
<span class="token comment">// local namelist [&#x2018;=&#x2019; explist]</span>
<span class="token keyword">func</span> <span class="token function">parseLocalAssignOrFuncDefStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Stat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_LOCAL<span class="token punctuation">)</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_KW_FUNCTION <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">_finishLocalFuncDefStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">_finishLocalVarDeclStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x5373;&#x8DF3;&#x8FC7; local &#x67E5;&#x770B;&#x524D;&#x9762;&#x662F; function &#x5219;&#x662F;&#x521D;&#x59CB;&#x5316;&#x5C40;&#x90E8;&#x51FD;&#x6570;, &#x5982;&#x679C;&#x662F;&#x53D8;&#x91CF;&#x5219;&#x521D;&#x59CB;&#x5316;&#x5C40;&#x90E8;&#x53D8;&#x91CF;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
http://www.lua.org/manual/5.3/manual.html#3.4.11

function f() end          =&gt;  f = function() end
function t.a.b.c.f() end  =&gt;  t.a.b.c.f = function() end
function t.a.b.c:f() end  =&gt;  t.a.b.c.f = function(self) end
local function f() end    =&gt;  local f; f = function() end

The statement `local function f () body end`
translates to `local f; f = function () body end`
not to `local f = function () body end`
(This only makes a difference when the body of the function
 contains references to f.)
*/</span>
<span class="token comment">// local function Name funcbody</span>
<span class="token keyword">func</span> <span class="token function">_finishLocalFuncDefStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>LocalFuncDefStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_FUNCTION<span class="token punctuation">)</span> <span class="token comment">// local function</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">// name</span>
	fdExp <span class="token operator">:=</span> <span class="token function">parseFuncDefExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>          <span class="token comment">// funcbody</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>LocalFuncDefStat<span class="token punctuation">{</span>name<span class="token punctuation">,</span> fdExp<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// local namelist [&#x2018;=&#x2019; explist]</span>
<span class="token keyword">func</span> <span class="token function">_finishLocalVarDeclStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>LocalVarDeclStat <span class="token punctuation">{</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> name0 <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token comment">// local Name</span>
	nameList <span class="token operator">:=</span> <span class="token function">_finishNameList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> name0<span class="token punctuation">)</span> <span class="token comment">// { , Name }</span>
	<span class="token keyword">var</span> expList <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp <span class="token operator">=</span> <span class="token boolean">nil</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_OP_ASSIGN <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>             <span class="token comment">// ==</span>
		expList <span class="token operator">=</span> <span class="token function">parseExpList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span> <span class="token comment">// explist</span>
	<span class="token punctuation">}</span>
	lastLine <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>LocalVarDeclStat<span class="token punctuation">{</span>lastLine<span class="token punctuation">,</span> nameList<span class="token punctuation">,</span> expList<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1635-%E8%B5%8B%E5%80%BC%E5%92%8C%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%AF%AD%E5%8F%A5">16.3.5 &#x8D4B;&#x503C;&#x548C;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// varlist &#x2018;=&#x2019; explist</span>
<span class="token comment">// functioncall</span>
<span class="token keyword">func</span> <span class="token function">parseAssignOrFuncCallStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Stat <span class="token punctuation">{</span>
	prefixExp <span class="token operator">:=</span> <span class="token function">parsePrefixExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> fc<span class="token punctuation">,</span> ok <span class="token operator">:=</span> prefixExp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>FuncCallExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> fc
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">parseAssignStat</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> prefixExp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// varlist &#x2018;=&#x2019; explist |</span>
<span class="token keyword">func</span> <span class="token function">parseAssignStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> var0 Exp<span class="token punctuation">)</span> <span class="token operator">*</span>AssignStat <span class="token punctuation">{</span>
	varList <span class="token operator">:=</span> <span class="token function">_finishVarList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> var0<span class="token punctuation">)</span> <span class="token comment">// varlist</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_OP_ASSIGN<span class="token punctuation">)</span> <span class="token comment">// =</span>
	expList <span class="token operator">:=</span> <span class="token function">parseExpList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>         <span class="token comment">// explist</span>
	lastLine <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AssignStat<span class="token punctuation">{</span>lastLine<span class="token punctuation">,</span> varList<span class="token punctuation">,</span> expList<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// varlist ::= var {&#x2018;,&#x2019; var}</span>
<span class="token keyword">func</span> <span class="token function">_finishVarList</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> var0 Exp<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp <span class="token punctuation">{</span>
	vars <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span><span class="token function">_checkVar</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> var0<span class="token punctuation">)</span><span class="token punctuation">}</span>      <span class="token comment">// var</span>
	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COMMA <span class="token punctuation">{</span> <span class="token comment">// {</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                          <span class="token comment">// ,</span>
		exp <span class="token operator">:=</span> <span class="token function">parsePrefixExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>               <span class="token comment">// var</span>
		vars <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vars<span class="token punctuation">,</span> <span class="token function">_checkVar</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> exp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//</span>
	<span class="token punctuation">}</span> <span class="token comment">// }</span>
	<span class="token keyword">return</span> vars
<span class="token punctuation">}</span>

<span class="token comment">// var ::=  Name | prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019; | prefixexp &#x2018;.&#x2019; Name</span>
<span class="token keyword">func</span> <span class="token function">_checkVar</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> exp Exp<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>NameExp<span class="token punctuation">,</span> <span class="token operator">*</span>TableAccessExp<span class="token punctuation">:</span>
		<span class="token keyword">return</span> exp
	<span class="token punctuation">}</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token comment">// trigger error</span>
	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;unreachable!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

</pre><h3 class="mume-header" id="1636-%E9%9D%9E%E5%B1%80%E9%83%A8%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E8%AF%AD%E5%8F%A5">16.3.6 &#x975E;&#x5C40;&#x90E8;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// function funcname funcbody</span>
<span class="token comment">// funcname ::= Name {&#x2018;.&#x2019; Name} [&#x2018;:&#x2019; Name]</span>
<span class="token comment">// funcbody ::= &#x2018;(&#x2019; [parlist] &#x2018;)&#x2019; block end</span>
<span class="token comment">// parlist ::= namelist [&#x2018;,&#x2019; &#x2018;...&#x2019;] | &#x2018;...&#x2019;</span>
<span class="token comment">// namelist ::= Name {&#x2018;,&#x2019; Name}</span>
<span class="token keyword">func</span> <span class="token function">parseFuncDefStat</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>AssignStat <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_FUNCTION<span class="token punctuation">)</span> <span class="token comment">// function</span>
	fnExp<span class="token punctuation">,</span> hasColon <span class="token operator">:=</span> <span class="token function">_parseFuncName</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span> <span class="token comment">// funcname</span>
	fdExp <span class="token operator">:=</span> <span class="token function">parseFuncDefExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>          <span class="token comment">// funcbody</span>
	<span class="token keyword">if</span> hasColon <span class="token punctuation">{</span>                            <span class="token comment">// insert self</span>
		fdExp<span class="token punctuation">.</span>ParList <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fdExp<span class="token punctuation">.</span>ParList<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
		<span class="token function">copy</span><span class="token punctuation">(</span>fdExp<span class="token punctuation">.</span>ParList<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">,</span> fdExp<span class="token punctuation">.</span>ParList<span class="token punctuation">)</span>
		fdExp<span class="token punctuation">.</span>ParList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">&quot;self&quot;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token operator">&amp;</span>AssignStat<span class="token punctuation">{</span>
		LastLine<span class="token punctuation">:</span> fdExp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span>
		VarList<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span>fnExp<span class="token punctuation">}</span><span class="token punctuation">,</span>
		ExpList<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span>fdExp<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// funcname ::= Name {&#x2018;.&#x2019; Name} [&#x2018;:&#x2019; Name]</span>
<span class="token keyword">func</span> <span class="token function">_parseFuncName</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">(</span>exp Exp<span class="token punctuation">,</span> hasColon <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	exp <span class="token operator">=</span> <span class="token operator">&amp;</span>NameExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>

	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_DOT <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		idx <span class="token operator">:=</span> <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
		exp <span class="token operator">=</span> <span class="token operator">&amp;</span>TableAccessExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> idx<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COLON <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		idx <span class="token operator">:=</span> <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
		exp <span class="token operator">=</span> <span class="token operator">&amp;</span>TableAccessExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> idx<span class="token punctuation">}</span>
		hasColon <span class="token operator">=</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

</pre><h3 class="mume-header" id="164-%E8%A7%A3%E6%9E%90%E8%A1%A8%E8%BE%BE%E5%BC%8F">16.4 &#x89E3;&#x6790;&#x8868;&#x8FBE;&#x5F0F;</h3>

<p>&#x5C06;&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;&#x5206;&#x89E3;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
exp ::=  nil | false | true | Numeral | LiteralString | &#x2018;...&#x2019; | functiondef |
	 prefixexp | tableconstructor | exp binop exp | unop exp
*/</span>
<span class="token comment">/*
exp   ::= exp12
exp12 ::= exp11 {or exp11}
exp11 ::= exp10 {and exp10}
exp10 ::= exp9 {(&#x2018;&lt;&#x2019; | &#x2018;&gt;&#x2019; | &#x2018;&lt;=&#x2019; | &#x2018;&gt;=&#x2019; | &#x2018;~=&#x2019; | &#x2018;==&#x2019;) exp9}
exp9  ::= exp8 {&#x2018;|&#x2019; exp8}
exp8  ::= exp7 {&#x2018;~&#x2019; exp7}
exp7  ::= exp6 {&#x2018;&amp;&#x2019; exp6}
exp6  ::= exp5 {(&#x2018;&lt;&lt;&#x2019; | &#x2018;&gt;&gt;&#x2019;) exp5}
exp5  ::= exp4 {&#x2018;..&#x2019; exp4}
exp4  ::= exp3 {(&#x2018;+&#x2019; | &#x2018;-&#x2019;) exp3}
exp3  ::= exp2 {(&#x2018;*&#x2019; | &#x2018;/&#x2019; | &#x2018;//&#x2019; | &#x2018;%&#x2019;) exp2}
exp2  ::= {(&#x2018;not&#x2019; | &#x2018;#&#x2019; | &#x2018;-&#x2019; | &#x2018;~&#x2019;)} exp1
exp1  ::= exp0 {&#x2018;^&#x2019; exp2}
exp0  ::= nil | false | true | Numeral | LiteralString
		| &#x2018;...&#x2019; | functiondef | prefixexp | tableconstructor
*/</span>
<span class="token keyword">func</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">parseExp12</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1641-%E8%BF%90%E7%AE%97%E7%AC%A6%E8%A1%A8%E8%BE%BE%E5%BC%8F">16.4.1 &#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// x or y</span>
<span class="token keyword">func</span> <span class="token function">parseExp12</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	exp <span class="token operator">:=</span> <span class="token function">parseExp11</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_OP_OR <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		lor <span class="token operator">:=</span> <span class="token operator">&amp;</span>BinopExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token function">parseExp11</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">}</span>
		exp <span class="token operator">=</span> <span class="token function">optimizeLogicalOr</span><span class="token punctuation">(</span>lor<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> exp
<span class="token punctuation">}</span>
</pre><p>&#x8FD9;&#x91CC;&#x8981;&#x6839;&#x636E;&#x8FD0;&#x7B97;&#x7B26;&#x7684;&#x7ED3;&#x5408;&#x6027;&#x4E66;&#x5199;&#x5177;&#x4F53;&#x903B;&#x8F91;. &#x5C24;&#x5176;&#x662F; <code>...</code> &#x548C; <code>^</code> &#x5177;&#x6709;&#x5411;&#x53F3;&#x7ED3;&#x5408;&#x6027;. &#x4E0B;&#x9762;&#x662F; <code>^</code> &#x7684;&#x5177;&#x4F53;&#x4F8B;&#x5B50;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// x ^ y</span>
<span class="token keyword">func</span> <span class="token function">parseExp1</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span> <span class="token comment">// pow is right associative</span>
	exp <span class="token operator">:=</span> <span class="token function">parseExp0</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_OP_POW <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		exp <span class="token operator">=</span> <span class="token operator">&amp;</span>BinopExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> <span class="token function">parseExp2</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">optimizePow</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">optimizePow</span><span class="token punctuation">(</span>exp Exp<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">if</span> binop<span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>BinopExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> binop<span class="token punctuation">.</span>Op <span class="token operator">==</span> TOKEN_OP_POW <span class="token punctuation">{</span>
			binop<span class="token punctuation">.</span>Exp2 <span class="token operator">=</span> <span class="token function">optimizePow</span><span class="token punctuation">(</span>binop<span class="token punctuation">.</span>Exp2<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">optimizeArithBinaryOp</span><span class="token punctuation">(</span>binop<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> exp
<span class="token punctuation">}</span>

</pre><p><code>^</code> &#x662F;&#x53EF;&#x4EE5;&#x8FDE;&#x7528;&#x7684;, &#x6BD4;&#x5982;  <code>a^b^c</code>.</p>
<p>&#x4E0B;&#x9762;&#x662F;&#x4E00;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x7684;&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// exp2  ::= {(&#x2018;not&#x2019; | &#x2018;#&#x2019; | &#x2018;-&#x2019; | &#x2018;~&#x2019;)} exp1</span>
<span class="token comment">// unary</span>
<span class="token keyword">func</span> <span class="token function">parseExp2</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_OP_UNM<span class="token punctuation">,</span> TOKEN_OP_BNOT<span class="token punctuation">,</span> TOKEN_OP_LEN<span class="token punctuation">,</span> TOKEN_OP_NOT<span class="token punctuation">:</span>
		line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		exp <span class="token operator">:=</span> <span class="token operator">&amp;</span>UnopExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token function">parseExp2</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">optimizeUnaryOp</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">parseExp1</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x62FC;&#x63A5;&#x8FD0;&#x7B97;&#x7B26;&#x5219;&#x662F;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// a .. b</span>
<span class="token keyword">func</span> <span class="token function">parseExp5</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	exp <span class="token operator">:=</span> <span class="token function">parseExp4</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> TOKEN_OP_CONCAT <span class="token punctuation">{</span>
		<span class="token keyword">return</span> exp
	<span class="token punctuation">}</span>

	line <span class="token operator">:=</span> <span class="token number">0</span>
	exps <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span>exp<span class="token punctuation">}</span>
	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_OP_CONCAT <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		exps <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>exps<span class="token punctuation">,</span> <span class="token function">parseExp4</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>ConcatExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> exps<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x62FC;&#x63A5;&#x8FD0;&#x7B97;&#x7B26;&#x7279;&#x6B8A;&#x5904;&#x7406;, &#x91C7;&#x7528;&#x591A;&#x53C9;&#x6811;&#x65B9;&#x4FBF;&#x7EDF;&#x4E00;&#x8FD0;&#x7B97;&#x3002;</p>
<h3>16.4.2 &#x975E;&#x8FD0;&#x7B97;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">parseExp0</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_VARARG<span class="token punctuation">:</span> <span class="token comment">// ...</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>VarargExp<span class="token punctuation">{</span>line<span class="token punctuation">}</span>
	<span class="token keyword">case</span> TOKEN_KW_NIL<span class="token punctuation">:</span> <span class="token comment">// nil</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>NilExp<span class="token punctuation">{</span>line<span class="token punctuation">}</span>
	<span class="token keyword">case</span> TOKEN_KW_TRUE<span class="token punctuation">:</span> <span class="token comment">// true</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>TrueExp<span class="token punctuation">{</span>line<span class="token punctuation">}</span>
	<span class="token keyword">case</span> TOKEN_KW_FALSE<span class="token punctuation">:</span> <span class="token comment">// false</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>FalseExp<span class="token punctuation">{</span>line<span class="token punctuation">}</span>
	<span class="token keyword">case</span> TOKEN_STRING<span class="token punctuation">:</span> <span class="token comment">// LiteralString</span>
		line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> token <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> token<span class="token punctuation">}</span>
	<span class="token keyword">case</span> TOKEN_NUMBER<span class="token punctuation">:</span> <span class="token comment">// Numeral</span>
		<span class="token keyword">return</span> <span class="token function">parseNumberExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_SEP_LCURLY<span class="token punctuation">:</span> <span class="token comment">// tableconstructor</span>
		<span class="token keyword">return</span> <span class="token function">parseTableConstructorExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_KW_FUNCTION<span class="token punctuation">:</span> <span class="token comment">// functiondef</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">parseFuncDefExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token comment">// prefixexp</span>
		<span class="token keyword">return</span> <span class="token function">parsePrefixExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x5355;&#x4E2A;&#x8868;&#x8FBE;&#x5F0F;&#x90FD;&#x5F88;&#x7B80;&#x5355;, &#x76F4;&#x63A5;&#x5224;&#x65AD;&#x7C7B;&#x578B;&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x7C7B;&#x578B;&#x5373;&#x53EF;. &#x5176;&#x4E2D;&#x6570;&#x5B57;&#x5B57;&#x9762;&#x91CF;&#x4F1A;&#x590D;&#x6742;&#x4E00;&#x4E9B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">parseNumberExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	line<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> token <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> i<span class="token punctuation">,</span> ok <span class="token operator">:=</span> number<span class="token punctuation">.</span><span class="token function">ParseInteger</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>IntegerExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> i<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> f<span class="token punctuation">,</span> ok <span class="token operator">:=</span> number<span class="token punctuation">.</span><span class="token function">ParseFloat</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>FloatExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> f<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// todo</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;not a number: &quot;</span> <span class="token operator">+</span> token<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>16.4.3 &#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// functiondef ::= function funcbody</span>
<span class="token comment">// funcbody ::= &#x2018;(&#x2019; [parlist] &#x2018;)&#x2019; block end</span>
<span class="token keyword">func</span> <span class="token function">parseFuncDefExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>FuncDefExp <span class="token punctuation">{</span>
	line <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                               <span class="token comment">// function</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_LPAREN<span class="token punctuation">)</span>            <span class="token comment">// (</span>
	parList<span class="token punctuation">,</span> isVararg <span class="token operator">:=</span> <span class="token function">_parseParList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>          <span class="token comment">// [parlist]</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_RPAREN<span class="token punctuation">)</span>            <span class="token comment">// )</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                         <span class="token comment">// block</span>
	lastLine<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_KW_END<span class="token punctuation">)</span> <span class="token comment">// end</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>FuncDefExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> lastLine<span class="token punctuation">,</span> parList<span class="token punctuation">,</span> isVararg<span class="token punctuation">,</span> block<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>_parseParList() &#x7528;&#x4E8E;&#x53C2;&#x6570;&#x5217;&#x8868;&#x89E3;&#x6790;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// [parlist]</span>
<span class="token comment">// parlist ::= namelist [&#x2018;,&#x2019; &#x2018;...&#x2019;] | &#x2018;...&#x2019;</span>
<span class="token keyword">func</span> <span class="token function">_parseParList</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">(</span>names <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> isVararg <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_SEP_RPAREN<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span>
	<span class="token keyword">case</span> TOKEN_VARARG<span class="token punctuation">:</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">true</span>
	<span class="token punctuation">}</span>

	<span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
	<span class="token keyword">for</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COMMA <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_IDENTIFIER <span class="token punctuation">{</span>
			<span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			names <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>names<span class="token punctuation">,</span> name<span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_VARARG<span class="token punctuation">)</span>
			isVararg <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">break</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</pre><h3>16.4.4 &#x8868;&#x6784;&#x9020;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// tableconstructor ::= &#x2018;{&#x2019; [fieldlist] &#x2018;}&#x2019;</span>
<span class="token keyword">func</span> <span class="token function">parseTableConstructorExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>TableConstructorExp <span class="token punctuation">{</span>
	line <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_LCURLY<span class="token punctuation">)</span>    <span class="token comment">// {</span>
	keyExps<span class="token punctuation">,</span> valExps <span class="token operator">:=</span> <span class="token function">_parseFieldList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span> <span class="token comment">// [fieldlist]</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_RCURLY<span class="token punctuation">)</span>    <span class="token comment">// }</span>
	lastLine <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>TableConstructorExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> lastLine<span class="token punctuation">,</span> keyExps<span class="token punctuation">,</span> valExps<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// fieldlist ::= field {fieldsep field} [fieldsep]</span>
<span class="token keyword">func</span> <span class="token function">_parseFieldList</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">(</span>ks<span class="token punctuation">,</span> vs <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> TOKEN_SEP_RCURLY <span class="token punctuation">{</span>
		k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token function">_parseField</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
		ks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ks<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
		vs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vs<span class="token punctuation">,</span> v<span class="token punctuation">)</span>

		<span class="token keyword">for</span> <span class="token function">_isFieldSep</span><span class="token punctuation">(</span>lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> TOKEN_SEP_RCURLY <span class="token punctuation">{</span>
				k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token function">_parseField</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
				ks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>ks<span class="token punctuation">,</span> k<span class="token punctuation">)</span>
				vs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>vs<span class="token punctuation">,</span> v<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token keyword">break</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token comment">// fieldsep ::= &#x2018;,&#x2019; | &#x2018;;&#x2019;</span>
<span class="token keyword">func</span> <span class="token function">_isFieldSep</span><span class="token punctuation">(</span>tokenKind <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">bool</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> tokenKind <span class="token operator">==</span> TOKEN_SEP_COMMA <span class="token operator">||</span> tokenKind <span class="token operator">==</span> TOKEN_SEP_SEMI
<span class="token punctuation">}</span>

<span class="token comment">// field ::= &#x2018;[&#x2019; exp &#x2018;]&#x2019; &#x2018;=&#x2019; exp | Name &#x2018;=&#x2019; exp | exp</span>
<span class="token keyword">func</span> <span class="token function">_parseField</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">(</span>k<span class="token punctuation">,</span> v Exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_LBRACK <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                       <span class="token comment">// [</span>
		k <span class="token operator">=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                     <span class="token comment">// exp</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_RBRACK<span class="token punctuation">)</span> <span class="token comment">// ]</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_OP_ASSIGN<span class="token punctuation">)</span>  <span class="token comment">// =</span>
		v <span class="token operator">=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                     <span class="token comment">// exp</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	exp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token keyword">if</span> nameExp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>NameExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_OP_ASSIGN <span class="token punctuation">{</span>
			<span class="token comment">// Name &#x2018;=&#x2019; exp =&gt; &#x2018;[&#x2019; LiteralString &#x2018;]&#x2019; = exp</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			k <span class="token operator">=</span> <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>nameExp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> nameExp<span class="token punctuation">.</span>Name<span class="token punctuation">}</span>
			v <span class="token operator">=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token boolean">nil</span><span class="token punctuation">,</span> exp
<span class="token punctuation">}</span>

</pre><h3>16.4.5 &#x524D;&#x7F00;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// prefixexp ::= var | functioncall | &#x2018;(&#x2019; exp &#x2018;)&#x2019;</span>
<span class="token comment">// var ::=  Name | prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019; | prefixexp &#x2018;.&#x2019; Name</span>
<span class="token comment">// functioncall ::=  prefixexp args | prefixexp &#x2018;:&#x2019; Name args</span>

<span class="token comment">/*
prefixexp ::= Name
	| &#x2018;(&#x2019; exp &#x2018;)&#x2019;
	| prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019;
	| prefixexp &#x2018;.&#x2019; Name
	| prefixexp [&#x2018;:&#x2019; Name] args
*/</span>
<span class="token keyword">func</span> <span class="token function">parsePrefixExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">var</span> exp Exp
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_IDENTIFIER <span class="token punctuation">{</span>
		line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Name</span>
		exp <span class="token operator">=</span> <span class="token operator">&amp;</span>NameExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// &#x2018;(&#x2019; exp &#x2018;)&#x2019;</span>
		exp <span class="token operator">=</span> <span class="token function">parseParensExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">_finishPrefixExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">_finishPrefixExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> exp Exp<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">case</span> TOKEN_SEP_LBRACK<span class="token punctuation">:</span> <span class="token comment">// prefixexp &#x2018;[&#x2019; exp &#x2018;]&#x2019;</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                       <span class="token comment">// &#x2018;[&#x2019;</span>
			keyExp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>               <span class="token comment">// exp</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_RBRACK<span class="token punctuation">)</span> <span class="token comment">// &#x2018;]&#x2019;</span>
			exp <span class="token operator">=</span> <span class="token operator">&amp;</span>TableAccessExp<span class="token punctuation">{</span>lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exp<span class="token punctuation">,</span> keyExp<span class="token punctuation">}</span>
		<span class="token keyword">case</span> TOKEN_SEP_DOT<span class="token punctuation">:</span> <span class="token comment">// prefixexp &#x2018;.&#x2019; Name</span>
			lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token comment">// &#x2018;.&#x2019;</span>
			line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// Name</span>
			keyExp <span class="token operator">:=</span> <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
			exp <span class="token operator">=</span> <span class="token operator">&amp;</span>TableAccessExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> keyExp<span class="token punctuation">}</span>
		<span class="token keyword">case</span> TOKEN_SEP_COLON<span class="token punctuation">,</span> <span class="token comment">// prefixexp &#x2018;:&#x2019; Name args</span>
			TOKEN_SEP_LPAREN<span class="token punctuation">,</span> TOKEN_SEP_LCURLY<span class="token punctuation">,</span> TOKEN_STRING<span class="token punctuation">:</span> <span class="token comment">// prefixexp args</span>
			exp <span class="token operator">=</span> <span class="token function">_finishFuncCallExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">,</span> exp<span class="token punctuation">)</span>
		<span class="token keyword">default</span><span class="token punctuation">:</span>
			<span class="token keyword">return</span> exp
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> exp
<span class="token punctuation">}</span>
</pre><h3>16.4.6 &#x5706;&#x62EC;&#x53F7;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">parseParensExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_LPAREN<span class="token punctuation">)</span> <span class="token comment">// (</span>
	exp <span class="token operator">:=</span> <span class="token function">parseExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>                  <span class="token comment">// exp</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_RPAREN<span class="token punctuation">)</span> <span class="token comment">// )</span>

	<span class="token keyword">switch</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>VarargExp<span class="token punctuation">,</span> <span class="token operator">*</span>FuncCallExp<span class="token punctuation">,</span> <span class="token operator">*</span>NameExp<span class="token punctuation">,</span> <span class="token operator">*</span>TableAccessExp<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>ParensExp<span class="token punctuation">{</span>exp<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// no need to keep parens</span>
	<span class="token keyword">return</span> exp
<span class="token punctuation">}</span>

</pre><p>&#x8FD0;&#x7B97;&#x4F18;&#x5148;&#x7EA7;&#x8C03;&#x8282;&#x5E94;&#x8BE5;&#x662F;&#x653E;&#x5230;&#x4E86;&#x4EE3;&#x7801;&#x751F;&#x6210;&#x9636;&#x6BB5;.</p>
<h3>16.4.7 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// functioncall ::=  prefixexp args | prefixexp &#x2018;:&#x2019; Name args</span>
<span class="token keyword">func</span> <span class="token function">_finishFuncCallExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">,</span> prefixExp Exp<span class="token punctuation">)</span> <span class="token operator">*</span>FuncCallExp <span class="token punctuation">{</span>
	nameExp <span class="token operator">:=</span> <span class="token function">_parseNameExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	line <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// todo</span>
	args <span class="token operator">:=</span> <span class="token function">_parseArgs</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	lastLine <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">Line</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>FuncCallExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> lastLine<span class="token punctuation">,</span> prefixExp<span class="token punctuation">,</span> nameExp<span class="token punctuation">,</span> args<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">_parseNameExp</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token operator">*</span>StringExp <span class="token punctuation">{</span>
	<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TOKEN_SEP_COLON <span class="token punctuation">{</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		line<span class="token punctuation">,</span> name <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextIdentifier</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> name<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>

<span class="token comment">// args ::=  &#x2018;(&#x2019; [explist] &#x2018;)&#x2019; | tableconstructor | LiteralString</span>
<span class="token keyword">func</span> <span class="token function">_parseArgs</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> <span class="token punctuation">(</span>args <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_SEP_LPAREN<span class="token punctuation">:</span> <span class="token comment">// &#x2018;(&#x2019; [explist] &#x2018;)&#x2019;</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// TOKEN_SEP_LPAREN</span>
		<span class="token keyword">if</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> TOKEN_SEP_RPAREN <span class="token punctuation">{</span>
			args <span class="token operator">=</span> <span class="token function">parseExpList</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_SEP_RPAREN<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_SEP_LCURLY<span class="token punctuation">:</span> <span class="token comment">// &#x2018;{&#x2019; [fieldlist] &#x2018;}&#x2019;</span>
		args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span><span class="token function">parseTableConstructorExp</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">}</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token comment">// LiteralString</span>
		line<span class="token punctuation">,</span> str <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_STRING<span class="token punctuation">)</span>
		args <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span><span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> str<span class="token punctuation">}</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</pre><h3>16.4.8 &#x8868;&#x8FBE;&#x5F0F;&#x4F18;&#x5316;</h3>
<p>&#x5177;&#x4F53;&#x800C;&#x8A00;, &#x4F18;&#x5316;&#x5305;&#x62EC;&#x5B57;&#x9762;&#x91CF;&#x53C2;&#x4E0E;&#x7684;&#x7B97;&#x672F;, &#x6309;&#x4F4D;, &#x903B;&#x8F91;&#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x4F18;&#x5316;.</p>
<p>&#x5373;&#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;&#x5982;&#x679C;&#x80FD;&#x5728;&#x7F16;&#x8BD1;&#x671F;&#x8FDB;&#x884C;&#x6C42;&#x503C;, &#x4F1A;&#x76F4;&#x63A5;&#x8FDB;&#x884C;&#x6C42;&#x503C;.</p>
<p>&#x4E00;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x4F18;&#x5316;&#x7684;&#x4F8B;&#x5B50;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// unary</span>
<span class="token keyword">func</span> <span class="token function">parseExp2</span><span class="token punctuation">(</span>lexer <span class="token operator">*</span>Lexer<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> lexer<span class="token punctuation">.</span><span class="token function">LookAhead</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_OP_UNM<span class="token punctuation">,</span> TOKEN_OP_BNOT<span class="token punctuation">,</span> TOKEN_OP_LEN<span class="token punctuation">,</span> TOKEN_OP_NOT<span class="token punctuation">:</span>
		line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> lexer<span class="token punctuation">.</span><span class="token function">NextToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		exp <span class="token operator">:=</span> <span class="token operator">&amp;</span>UnopExp<span class="token punctuation">{</span>line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> <span class="token function">parseExp2</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token keyword">return</span> <span class="token function">optimizeUnaryOp</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token function">parseExp1</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">optimizeUnaryOp</span><span class="token punctuation">(</span>exp <span class="token operator">*</span>UnopExp<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> exp<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_OP_UNM<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">optimizeUnm</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_OP_NOT<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">optimizeNot</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_OP_BNOT<span class="token punctuation">:</span>
		<span class="token keyword">return</span> <span class="token function">optimizeBnot</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token keyword">return</span> exp
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x5177;&#x4F53;&#x5230;&#x53D6;&#x8D1F;&#x503C;&#x7684;&#x4F18;&#x5316;&#x662F;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">optimizeUnm</span><span class="token punctuation">(</span>exp <span class="token operator">*</span>UnopExp<span class="token punctuation">)</span> Exp <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> x <span class="token operator">:=</span> exp<span class="token punctuation">.</span>Exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// number?</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>IntegerExp<span class="token punctuation">:</span>
		x<span class="token punctuation">.</span>Val <span class="token operator">=</span> <span class="token operator">-</span>x<span class="token punctuation">.</span>Val
		<span class="token keyword">return</span> x
	<span class="token keyword">case</span> <span class="token operator">*</span>FloatExp<span class="token punctuation">:</span>
		<span class="token keyword">if</span> x<span class="token punctuation">.</span>Val <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			x<span class="token punctuation">.</span>Val <span class="token operator">=</span> <span class="token operator">-</span>x<span class="token punctuation">.</span>Val
			<span class="token keyword">return</span> x
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> exp
<span class="token punctuation">}</span>
</pre><p>&#x6700;&#x540E;&#x662F;&#x6574;&#x4F53;&#x7684; Parser &#x5165;&#x53E3;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">Parse</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> chunkName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>Block <span class="token punctuation">{</span>
	lexer <span class="token operator">:=</span> <span class="token function">NewLexer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> chunkName<span class="token punctuation">)</span>
	block <span class="token operator">:=</span> <span class="token function">parseBlock</span><span class="token punctuation">(</span>lexer<span class="token punctuation">)</span>
	lexer<span class="token punctuation">.</span><span class="token function">NextTokenOfKind</span><span class="token punctuation">(</span>TOKEN_EOF<span class="token punctuation">)</span>
	<span class="token keyword">return</span> block
<span class="token punctuation">}</span>

</pre><h2>16.5 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>
<h2>16.6 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>
<h1>Chapter 17, &#x4EE3;&#x7801;&#x751F;&#x6210;</h1>
<h2>17.1 &#x5B9A;&#x4E49; funcInfo &#x7ED3;&#x6784;&#x4F53;</h2>
<p>&#x4EE3;&#x7801;&#x751F;&#x6210;&#x4F1A;&#x5206;&#x4E3A;&#x4E24;&#x4E2A;&#x9636;&#x6BB5;, &#x7B2C;&#x4E00;&#x9636;&#x6BB5;&#x5BF9;AST&#x8FDB;&#x884C;&#x5904;&#x7406;, &#x751F;&#x6210;&#x81EA;&#x5B9A;&#x4E49;&#x5185;&#x90E8;&#x7ED3;&#x6784;, &#x7B2C;&#x4E8C;&#x4E2A;&#x9636;&#x6BB5;&#x628A;&#x5185;&#x90E8;&#x7ED3;&#x6784;&#x8F6C;&#x6362;&#x4E3A;&#x51FD;&#x6570;&#x539F;&#x578B;.</p>
<h3>17.1.1 &#x5E38;&#x91CF;&#x8868;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> funcInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	codeBuf
	parent    <span class="token operator">*</span>funcInfo
	subFuncs  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>funcInfo
	usedRegs  <span class="token builtin">int</span>
	maxRegs   <span class="token builtin">int</span>
	scopeLv   <span class="token builtin">int</span>
	locVars   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>locVarInfo
	locNames  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>locVarInfo
	upvalues  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>upvalInfo
	constants <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	labels    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>labelInfo
	gotos     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>gotoInfo
	breaks    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	line      <span class="token builtin">int</span>
	lastLine  <span class="token builtin">int</span>
	numParams <span class="token builtin">int</span>
	isVararg  <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</pre><p>constants &#x5B57;&#x6BB5;&#x8D1F;&#x8D23;&#x5B58;&#x50A8;&#x51FD;&#x6570;&#x539F;&#x578B;&#x7684;&#x5E38;&#x91CF;&#x8868;. &#x63A5;&#x4E0B;&#x6765;&#x662F; indexOfConstant().</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">indexOfConstant</span><span class="token punctuation">(</span>k <span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> idx<span class="token punctuation">,</span> found <span class="token operator">:=</span> fi<span class="token punctuation">.</span>constants<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> idx
	<span class="token punctuation">}</span>

	idx <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>constants<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span>constants<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">=</span> idx
	<span class="token keyword">return</span> idx
<span class="token punctuation">}</span>
</pre><p>&#x5982;&#x679C;&#x5E38;&#x91CF;&#x4E0D;&#x5728;&#x5217;&#x8868;&#x5219;&#x4F1A;&#x585E;&#x8FDB;&#x53BB;&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x7D22;&#x5F15;.</p>
<h3>17.1.2 &#x5BC4;&#x5B58;&#x5668;&#x5206;&#x914D;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> funcInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	codeBuf

	usedRegs  <span class="token builtin">int</span>
	maxRegs   <span class="token builtin">int</span>
	
<span class="token punctuation">}</span>
</pre><p>&#x4EC5;&#x4EC5;&#x8BB0;&#x5F55;&#x5DF2;&#x5206;&#x914D;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;&#x548C;&#x6700;&#x5927;&#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;&#x5373;&#x53EF;. allocReg() &#x8D1F;&#x8D23;&#x5206;&#x914D;&#x5E76;&#x66F4;&#x65B0;&#x6700;&#x5927;&#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;, &#x5E76;&#x8FD4;&#x56DE;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	fi<span class="token punctuation">.</span>usedRegs<span class="token operator">++</span>
	<span class="token keyword">if</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">&gt;=</span> <span class="token number">255</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;function or expression needs too many registers&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">&gt;</span> fi<span class="token punctuation">.</span>maxRegs <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span>maxRegs <span class="token operator">=</span> fi<span class="token punctuation">.</span>usedRegs
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">-</span> <span class="token number">1</span>
<span class="token punctuation">}</span>

</pre><p>freeReg() &#x7528;&#x4E8E;&#x56DE;&#x6536;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">freeReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;usedRegs &lt;= 0 !&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fi<span class="token punctuation">.</span>usedRegs<span class="token operator">--</span>
<span class="token punctuation">}</span>
</pre><p>allocRegs() &#x7528;&#x4E8E;&#x8FDE;&#x7EED;&#x5206;&#x914D; n &#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x5E76;&#x8FD4;&#x56DE;&#x7B2C;&#x4E00;&#x4E2A;&#x7D22;&#x5F15;, freeRegs &#x5219;&#x8D1F;&#x8D23;&#x56DE;&#x6536;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">allocRegs</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;n &lt;= 0 !&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">-</span> n
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">freeRegs</span><span class="token punctuation">(</span>n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> n <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;n &lt; 0 !&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> n<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">freeReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>17.1.3 &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;</h3>
<p>&#x8FD9;&#x91CC;&#x7528;&#x5355;&#x94FE;&#x8868;&#x6765;&#x4E32;&#x8054;&#x540C;&#x540D;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;. &#x5373; locVarInfo.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> locVarInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	prev     <span class="token operator">*</span>locVarInfo
	name     <span class="token builtin">string</span>
	scopeLv  <span class="token builtin">int</span>
	slot     <span class="token builtin">int</span>
	startPC  <span class="token builtin">int</span>
	endPC    <span class="token builtin">int</span>
	captured <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</pre><p>name &#x4E3A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x540D;, scopeLv &#x8BB0;&#x5F55;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x6240;&#x5728;&#x7684;&#x4F5C;&#x7528;&#x4E8E;&#x5C42;&#x6B21;, slot &#x5B57;&#x6BB5;&#x8BB0;&#x5F55;&#x4E0E;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x540D;&#x7ED1;&#x5B9A;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;, captured &#x8868;&#x793A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x662F;&#x5426;&#x88AB;&#x95ED;&#x5305;&#x6355;&#x83B7;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> funcInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	codeBuf
	parent    <span class="token operator">*</span>funcInfo
	subFuncs  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>funcInfo
	usedRegs  <span class="token builtin">int</span>
    maxRegs   <span class="token builtin">int</span>
    
	scopeLv   <span class="token builtin">int</span>
	locVars   <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>locVarInfo
    locNames  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>locVarInfo
    
	upvalues  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>upvalInfo
	constants <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	labels    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>labelInfo
	gotos     <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>gotoInfo
	breaks    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	line      <span class="token builtin">int</span>
	lastLine  <span class="token builtin">int</span>
	numParams <span class="token builtin">int</span>
	isVararg  <span class="token builtin">bool</span>
<span class="token punctuation">}</span>
</pre><p>&#x5728; funcInfo &#x4E2D; scopeLv &#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x4F5C;&#x7528;&#x57DF;&#x5C42;&#x6B21;, locVars &#x6309;&#x987A;&#x5E8F;&#x8BB0;&#x5F55;&#x51FD;&#x6570;&#x5185;&#x90E8;&#x58F0;&#x660E;&#x7684;&#x5168;&#x90E8;&#x5C40;&#x90E8;&#x53D8;&#x91CF;. locNames &#x8BB0;&#x5F55;&#x5F53;&#x524D;&#x751F;&#x6548;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;.</p>
<p>enterScope() &#x7528;&#x4E8E;&#x8FDB;&#x5165;&#x65B0;&#x7684;&#x4F5C;&#x7528;&#x57DF;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">enterScope</span><span class="token punctuation">(</span>breakable <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fi<span class="token punctuation">.</span>scopeLv<span class="token operator">++</span>
	<span class="token keyword">if</span> breakable <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span>breaks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span>breaks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>addLocVar() &#x65B9;&#x6CD5;&#x5728;&#x5F53;&#x524D;&#x4F5C;&#x7528;&#x57DF;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, &#x8FD4;&#x56DE;&#x5176;&#x5206;&#x914D;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">addLocVar</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> startPC <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	newVar <span class="token operator">:=</span> <span class="token operator">&amp;</span>locVarInfo<span class="token punctuation">{</span>
		name<span class="token punctuation">:</span>    name<span class="token punctuation">,</span>
		prev<span class="token punctuation">:</span>    fi<span class="token punctuation">.</span>locNames<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>
		scopeLv<span class="token punctuation">:</span> fi<span class="token punctuation">.</span>scopeLv<span class="token punctuation">,</span>
		slot<span class="token punctuation">:</span>    fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// alloc new register</span>
		startPC<span class="token punctuation">:</span> startPC<span class="token punctuation">,</span>
		endPC<span class="token punctuation">:</span>   <span class="token number">0</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	fi<span class="token punctuation">.</span>locVars <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>locVars<span class="token punctuation">,</span> newVar<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span>locNames<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> newVar

	<span class="token keyword">return</span> newVar<span class="token punctuation">.</span>slot
<span class="token punctuation">}</span>
</pre><p>slotOfLocVar() &#x65B9;&#x6CD5;&#x68C0;&#x67E5;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x540D;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x548C;&#x67D0;&#x4E2A;&#x5BC4;&#x5B58;&#x5668;&#x7ED1;&#x5B9A;, &#x5982;&#x679C;&#x662F;&#x5219;&#x8FD4;&#x56DE;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;, &#x5426;&#x5219;&#x8FD4;&#x56DE; -1.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">slotOfLocVar</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> locVar<span class="token punctuation">,</span> found <span class="token operator">:=</span> fi<span class="token punctuation">.</span>locNames<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
		<span class="token keyword">return</span> locVar<span class="token punctuation">.</span>slot
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</pre><p>exitScope() &#x7528;&#x4E8E;&#x9000;&#x51FA;&#x4F5C;&#x7528;&#x4E8E;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">exitScope</span><span class="token punctuation">(</span>endPC <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pendingBreakJmps <span class="token operator">:=</span> fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	fi<span class="token punctuation">.</span>breaks <span class="token operator">=</span> fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

	a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">getJmpArgA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pc <span class="token operator">:=</span> <span class="token keyword">range</span> pendingBreakJmps <span class="token punctuation">{</span>
		sBx <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pc
		i <span class="token operator">:=</span> <span class="token punctuation">(</span>sBx<span class="token operator">+</span>MAXARG_sBx<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span> <span class="token operator">|</span> a<span class="token operator">&lt;&lt;</span><span class="token number">6</span> <span class="token operator">|</span> OP_JMP
		fi<span class="token punctuation">.</span>insts<span class="token punctuation">[</span>pc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fi<span class="token punctuation">.</span><span class="token function">fixGotoJmps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span>scopeLv<span class="token operator">--</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> locVar <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>locNames <span class="token punctuation">{</span>
		<span class="token keyword">if</span> locVar<span class="token punctuation">.</span>scopeLv <span class="token operator">&gt;</span> fi<span class="token punctuation">.</span>scopeLv <span class="token punctuation">{</span> <span class="token comment">// out of scope</span>
			locVar<span class="token punctuation">.</span>endPC <span class="token operator">=</span> endPC
			fi<span class="token punctuation">.</span><span class="token function">removeLocVar</span><span class="token punctuation">(</span>locVar<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x5224;&#x65AD;&#x79BB;&#x5F00;&#x4E86;&#x5F53;&#x524D;&#x4F5C;&#x7528;&#x57DF;&#x540E;, &#x4F1A;&#x79FB;&#x9664; locVar. &#x4F7F;&#x7528; removeLocVar()</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">removeLocVar</span><span class="token punctuation">(</span>locVar <span class="token operator">*</span>locVarInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fi<span class="token punctuation">.</span><span class="token function">freeReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> locVar<span class="token punctuation">.</span>prev <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">delete</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>locNames<span class="token punctuation">,</span> locVar<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> locVar<span class="token punctuation">.</span>prev<span class="token punctuation">.</span>scopeLv <span class="token operator">==</span> locVar<span class="token punctuation">.</span>scopeLv <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">removeLocVar</span><span class="token punctuation">(</span>locVar<span class="token punctuation">.</span>prev<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span>locNames<span class="token punctuation">[</span>locVar<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> locVar<span class="token punctuation">.</span>prev
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x6D89;&#x53CA;&#x5230;&#x79FB;&#x9664;, &#x540C;&#x540D;&#x91CD;&#x65B0;&#x7ED1;&#x5B9A;&#x7684;&#x8FC7;&#x7A0B;.</p>
<h3>17.1.4 Break &#x8868;</h3>
<p>Break &#x53EF;&#x4EE5;&#x6253;&#x65AD;&#x5FAA;&#x73AF;, &#x5904;&#x7406;&#x96BE;&#x70B9;&#x6709;:</p>
<ul>
<li>&#x4E00;&#x4E2A;&#x662F; break &#x53EF;&#x80FD;&#x8FC7;&#x6DF1;</li>
<li>&#x53E6;&#x4E00;&#x4E2A;&#x662F; break &#x540E;&#x8DF3;&#x8F6C;&#x7684;&#x76EE;&#x6807;&#x5730;&#x5740;&#x4E0D;&#x786E;&#x5B9A;</li>
</ul>
<p>&#x6240;&#x4EE5;&#x4E3A;&#x4E86;&#x89E3;&#x51B3;, &#x9700;&#x8981;&#x628A;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;&#x7684;&#x5730;&#x5740;&#x8BB0;&#x5F55;&#x5728;&#x5BF9;&#x5E94;&#x7684; for, repeat, while &#x5757;&#x91CC;, &#x7ED3;&#x675F;&#x540E;&#x518D;&#x4FEE;&#x590D;&#x8DF3;&#x8F6C;&#x7684;&#x76EE;&#x6807;&#x5730;&#x5740;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> funcInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>

	breaks    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span>

<span class="token punctuation">}</span>
</pre><p>&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x6570;&#x7EC4;&#x6765;&#x8BB0;&#x5F55;&#x5FAA;&#x73AF;&#x5757;&#x5185;&#x5F85;&#x5904;&#x7406;&#x7684;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;, &#x6570;&#x5B57;&#x957F;&#x5EA6;&#x548C;&#x5757;&#x7684;&#x6DF1;&#x5EA6;&#x5BF9;&#x5E94;. &#x901A;&#x8FC7;&#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A; nil &#x5C31;&#x53EF;&#x4EE5;&#x5224;&#x65AD;&#x5BF9;&#x5E94;&#x7684;&#x5757;&#x662F;&#x5426;&#x662F;&#x5FAA;&#x73AF;&#x5757;. &#x8FD9;&#x91CC;&#x9700;&#x8981;&#x4FEE;&#x6539; enterScope()</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">enterScope</span><span class="token punctuation">(</span>breakable <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fi<span class="token punctuation">.</span>scopeLv<span class="token operator">++</span>
	<span class="token keyword">if</span> breakable <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span>breaks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span>breaks <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>addBreakJmp() &#x65B9;&#x6CD5;&#x628A; break &#x8BED;&#x53E5;&#x5BF9;&#x5E94;&#x7684;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;&#x6DFB;&#x52A0;&#x5230;&#x6700;&#x8FD1;&#x7684;&#x5FAA;&#x73AF;&#x5757;&#x91CC;, &#x627E;&#x4E0D;&#x5230;&#x5219; painc().</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">addBreakJmp</span><span class="token punctuation">(</span>pc <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> fi<span class="token punctuation">.</span>scopeLv<span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span> <span class="token comment">// breakable</span>
			fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> pc<span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;break&gt; at line ? not inside a loop!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>exitScope() &#x4E5F;&#x8981;&#x589E;&#x52A0;&#x76F8;&#x5173;&#x4EE3;&#x7801;:</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">exitScope</span><span class="token punctuation">(</span>endPC <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pendingBreakJmps <span class="token operator">:=</span> fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span><span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>
	fi<span class="token punctuation">.</span>breaks <span class="token operator">=</span> fi<span class="token punctuation">.</span>breaks<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>breaks<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>

	a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">getJmpArgA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pc <span class="token operator">:=</span> <span class="token keyword">range</span> pendingBreakJmps <span class="token punctuation">{</span>
		sBx <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> pc
		i <span class="token operator">:=</span> <span class="token punctuation">(</span>sBx<span class="token operator">+</span>MAXARG_sBx<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span> <span class="token operator">|</span> a<span class="token operator">&lt;&lt;</span><span class="token number">6</span> <span class="token operator">|</span> OP_JMP
		fi<span class="token punctuation">.</span>insts<span class="token punctuation">[</span>pc<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	fi<span class="token punctuation">.</span><span class="token function">fixGotoJmps</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span>scopeLv<span class="token operator">--</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> locVar <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>locNames <span class="token punctuation">{</span>
		<span class="token keyword">if</span> locVar<span class="token punctuation">.</span>scopeLv <span class="token operator">&gt;</span> fi<span class="token punctuation">.</span>scopeLv <span class="token punctuation">{</span> <span class="token comment">// out of scope</span>
			locVar<span class="token punctuation">.</span>endPC <span class="token operator">=</span> endPC
			fi<span class="token punctuation">.</span><span class="token function">removeLocVar</span><span class="token punctuation">(</span>locVar<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x7B80;&#x5355;&#x6765;&#x8BB2;, &#x5728; enterScope &#x8FC7;&#x7A0B;&#x5C06; fi.breaks &#x589E;&#x52A0;, &#x7136;&#x540E; addBreakJmp &#x8D1F;&#x8D23;&#x5C06;&#x8DF3;&#x8F6C;&#x5730;&#x5740; (pc) &#x603C;&#x5230;&#x5F53;&#x524D; fi.breaks &#x7684;&#x4F4D;&#x7F6E;&#x91CC;&#x9762;. &#x5F53; exitScope &#x65F6;, &#x5219;&#x8FDB;&#x884C;&#x9012;&#x51CF;&#x6D41;&#x7A0B;.</p>
<h3>17.1.5 Upvalue &#x8868;</h3>
<p>&#x5373;&#x5728;&#x5F53;&#x524D;&#x4F5C;&#x7528;&#x57DF;&#x6355;&#x83B7;&#x5916;&#x56F4;&#x51FD;&#x6570;&#x4E2D;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;. Upvalue &#x540D;&#x53EA;&#x80FD;&#x7ED1;&#x5B9A;&#x552F;&#x4E00;&#x7684; Upvalue. &#x6240;&#x4EE5;&#x7ED3;&#x6784;&#x76F8;&#x5BF9;&#x7B80;&#x5355;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> upvalInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	locVarSlot <span class="token builtin">int</span>
	upvalIndex <span class="token builtin">int</span>
	index      <span class="token builtin">int</span>
<span class="token punctuation">}</span>
</pre><p>locVarSlot &#x8BB0;&#x5F55;&#x8BE5;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x5360;&#x7528;&#x7684;&#x5BC4;&#x5B58;&#x5668;&#x7D22;&#x5F15;, &#x5982;&#x679C;&#x4E3A;&#x7A7A;&#x5219;&#x5DF2;&#x7ECF;&#x88AB;&#x5916;&#x56F4;&#x51FD;&#x6570;&#x6355;&#x83B7;. upvalIndex &#x8BB0;&#x5F55;&#x8BE5; Upvalue &#x5728;&#x76F4;&#x63A5;&#x5916;&#x56F4;&#x51FD;&#x6570; Upvalue &#x8868;&#x4E2D;&#x7684;&#x7D22;&#x5F15;. index &#x8BB0;&#x5F55; Upvalue &#x5728;&#x51FD;&#x6570;&#x4E2D;&#x51FA;&#x73B0;&#x7684;&#x987A;&#x5E8F;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> funcInfo <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	codeBuf
	parent    <span class="token operator">*</span>funcInfo

    
	upvalues  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>upvalInfo

<span class="token punctuation">}</span>
</pre><p>upvalues &#x5373; Upvalue &#x8868;. parent &#x7528;&#x4E8E;&#x5B9A;&#x4F4D;&#x5916;&#x56F4;&#x51FD;&#x6570;&#x7684;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;&#x548C; Upvalue &#x8868;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">indexOfUpval</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> upval<span class="token punctuation">,</span> ok <span class="token operator">:=</span> fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> upval<span class="token punctuation">.</span>index
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> fi<span class="token punctuation">.</span>parent <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> locVar<span class="token punctuation">,</span> found <span class="token operator">:=</span> fi<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>locNames<span class="token punctuation">[</span>name<span class="token punctuation">]</span><span class="token punctuation">;</span> found <span class="token punctuation">{</span>
			idx <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">)</span>
			fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> upvalInfo<span class="token punctuation">{</span>locVar<span class="token punctuation">.</span>slot<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> idx<span class="token punctuation">}</span>
			locVar<span class="token punctuation">.</span>captured <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token keyword">return</span> idx
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> uvIdx <span class="token operator">:=</span> fi<span class="token punctuation">.</span>parent<span class="token punctuation">.</span><span class="token function">indexOfUpval</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span> uvIdx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			idx <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">)</span>
			fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">[</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> upvalInfo<span class="token punctuation">{</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> uvIdx<span class="token punctuation">,</span> idx<span class="token punctuation">}</span>
			<span class="token keyword">return</span> idx
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span>
<span class="token punctuation">}</span>
</pre><p>indexOfUpval &#x7528;&#x4E8E;&#x5B9E;&#x65BD;&#x7ED1;&#x5B9A;&#x5E76;&#x8FD4;&#x56DE;&#x7D22;&#x5F15;.</p>
<h3>17.1.6 &#x5B57;&#x8282;&#x7801;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">type</span> codeBuf <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	insts    <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
	lineNums <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
<span class="token punctuation">}</span>

</pre><p>insts &#x5B58;&#x50A8;&#x5B57;&#x8282;&#x7801;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>codeBuf<span class="token punctuation">)</span> <span class="token function">emitABC</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> opcode<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> b<span class="token operator">&lt;&lt;</span><span class="token number">23</span> <span class="token operator">|</span> c<span class="token operator">&lt;&lt;</span><span class="token number">14</span> <span class="token operator">|</span> a<span class="token operator">&lt;&lt;</span><span class="token number">6</span> <span class="token operator">|</span> opcode
	cb<span class="token punctuation">.</span>insts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>insts<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	cb<span class="token punctuation">.</span>lineNums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>lineNums<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>codeBuf<span class="token punctuation">)</span> <span class="token function">emitABx</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> opcode<span class="token punctuation">,</span> a<span class="token punctuation">,</span> bx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> bx<span class="token operator">&lt;&lt;</span><span class="token number">14</span> <span class="token operator">|</span> a<span class="token operator">&lt;&lt;</span><span class="token number">6</span> <span class="token operator">|</span> opcode
	cb<span class="token punctuation">.</span>insts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>insts<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	cb<span class="token punctuation">.</span>lineNums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>lineNums<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>codeBuf<span class="token punctuation">)</span> <span class="token function">emitAsBx</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> opcode<span class="token punctuation">,</span> a<span class="token punctuation">,</span> sBx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> <span class="token punctuation">(</span>sBx<span class="token operator">+</span>MAXARG_sBx<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span> <span class="token operator">|</span> a<span class="token operator">&lt;&lt;</span><span class="token number">6</span> <span class="token operator">|</span> opcode
	cb<span class="token punctuation">.</span>insts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>insts<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	cb<span class="token punctuation">.</span>lineNums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>lineNums<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>codeBuf<span class="token punctuation">)</span> <span class="token function">emitAx</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> opcode<span class="token punctuation">,</span> ax <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	i <span class="token operator">:=</span> ax<span class="token operator">&lt;&lt;</span><span class="token number">6</span> <span class="token operator">|</span> opcode
	cb<span class="token punctuation">.</span>insts <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>insts<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span>
	cb<span class="token punctuation">.</span>lineNums <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>cb<span class="token punctuation">.</span>lineNums<span class="token punctuation">,</span> <span class="token function">uint32</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x8FD9;&#x6BB5;&#x4EE3;&#x7801;&#x7528;&#x4E8E;&#x5C06; line, opcode, abc &#x5BC4;&#x5B58;&#x5668;&#x62FC;&#x63A5;&#x6210;&#x6307;&#x4EE4;&#x5E76;&#x653E;&#x5165; insts.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>codeBuf<span class="token punctuation">)</span> <span class="token function">fixSbx</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> sBx <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> sBx <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> sBx <span class="token operator">&gt;</span> MAXARG_sBx <span class="token operator">||</span> sBx <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">-</span>sBx <span class="token operator">&gt;</span> MAXARG_sBx <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;control structure too long&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	i <span class="token operator">:=</span> cb<span class="token punctuation">.</span>insts<span class="token punctuation">[</span>pc<span class="token punctuation">]</span>
	i <span class="token operator">=</span> i <span class="token operator">&lt;&lt;</span> <span class="token number">18</span> <span class="token operator">&gt;&gt;</span> <span class="token number">18</span>                  <span class="token comment">// clear sBx</span>
	i <span class="token operator">=</span> i <span class="token operator">|</span> <span class="token function">uint32</span><span class="token punctuation">(</span>sBx<span class="token operator">+</span>MAXARG_sBx<span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">14</span> <span class="token comment">// reset sBx</span>
	cb<span class="token punctuation">.</span>insts<span class="token punctuation">[</span>pc<span class="token punctuation">]</span> <span class="token operator">=</span> i
<span class="token punctuation">}</span>
</pre><h3>17.1.7 &#x5176;&#x4ED6;&#x4FE1;&#x606F;</h3>
<p>&#x5B9A;&#x4E49; funcInfo &#x7684;&#x751F;&#x6210;&#x51FD;&#x6570;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">newFuncInfo</span><span class="token punctuation">(</span>parent <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> fd <span class="token operator">*</span>FuncDefExp<span class="token punctuation">)</span> <span class="token operator">*</span>funcInfo <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>funcInfo<span class="token punctuation">{</span>
		codeBuf<span class="token punctuation">:</span> codeBuf<span class="token punctuation">{</span>
			insts<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
			lineNums<span class="token punctuation">:</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uint32</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span><span class="token punctuation">,</span>
		parent<span class="token punctuation">:</span>    parent<span class="token punctuation">,</span>
		subFuncs<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>funcInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		locVars<span class="token punctuation">:</span>   <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>locVarInfo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		locNames<span class="token punctuation">:</span>  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">*</span>locVarInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		upvalues<span class="token punctuation">:</span>  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>upvalInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		constants<span class="token punctuation">:</span> <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		labels<span class="token punctuation">:</span>    <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>labelInfo<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
		gotos<span class="token punctuation">:</span>     <span class="token boolean">nil</span><span class="token punctuation">,</span>
		breaks<span class="token punctuation">:</span>    <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
		line<span class="token punctuation">:</span>      fd<span class="token punctuation">.</span>Line<span class="token punctuation">,</span>
		lastLine<span class="token punctuation">:</span>  fd<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span>
		numParams<span class="token punctuation">:</span> <span class="token function">len</span><span class="token punctuation">(</span>fd<span class="token punctuation">.</span>ParList<span class="token punctuation">)</span><span class="token punctuation">,</span>
		isVararg<span class="token punctuation">:</span>  fd<span class="token punctuation">.</span>IsVararg<span class="token punctuation">,</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h2>17.2 &#x7F16;&#x8BD1;&#x5757;</h2>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgBlock</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>Block<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> stat <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Stats <span class="token punctuation">{</span>
		<span class="token function">cgStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> node<span class="token punctuation">.</span>RetExps <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">cgRetStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>RetExps<span class="token punctuation">,</span> node<span class="token punctuation">.</span>LastLine<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">cgRetStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> exps <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">,</span> lastLine <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	nExps <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>exps<span class="token punctuation">)</span>
	<span class="token keyword">if</span> nExps <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">emitReturn</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> nExps <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> nameExp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> exps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>NameExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			<span class="token keyword">if</span> r <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">slotOfLocVar</span><span class="token punctuation">(</span>nameExp<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				fi<span class="token punctuation">.</span><span class="token function">emitReturn</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token keyword">return</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> fcExp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> exps<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>FuncCallExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			r <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">cgTailCallExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> fcExp<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
			fi<span class="token punctuation">.</span><span class="token function">freeReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			fi<span class="token punctuation">.</span><span class="token function">emitReturn</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	multRet <span class="token operator">:=</span> <span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>exps<span class="token punctuation">[</span>nExps<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> exps <span class="token punctuation">{</span>
		r <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> multRet <span class="token punctuation">{</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fi<span class="token punctuation">.</span><span class="token function">freeRegs</span><span class="token punctuation">(</span>nExps<span class="token punctuation">)</span>

	a <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs <span class="token comment">// correct?</span>
	<span class="token keyword">if</span> multRet <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">emitReturn</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">emitReturn</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> nExps<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><h2>17.3 &#x7F16;&#x8BD1;&#x8BED;&#x53E5;</h2>
<p>&#x63A5;&#x4E0B;&#x6765;&#x65F6;&#x8BED;&#x53E5;&#x7684;&#x7F16;&#x8BD1;&#x8FC7;&#x7A0B;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node Stat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> stat <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>FuncCallStat<span class="token punctuation">:</span>
		<span class="token function">cgFuncCallStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>BreakStat<span class="token punctuation">:</span>
		<span class="token function">cgBreakStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>DoStat<span class="token punctuation">:</span>
		<span class="token function">cgDoStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>WhileStat<span class="token punctuation">:</span>
		<span class="token function">cgWhileStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>RepeatStat<span class="token punctuation">:</span>
		<span class="token function">cgRepeatStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>IfStat<span class="token punctuation">:</span>
		<span class="token function">cgIfStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ForNumStat<span class="token punctuation">:</span>
		<span class="token function">cgForNumStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ForInStat<span class="token punctuation">:</span>
		<span class="token function">cgForInStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>AssignStat<span class="token punctuation">:</span>
		<span class="token function">cgAssignStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>LocalVarDeclStat<span class="token punctuation">:</span>
		<span class="token function">cgLocalVarDeclStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>LocalFuncDefStat<span class="token punctuation">:</span>
		<span class="token function">cgLocalFuncDefStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>LabelStat<span class="token punctuation">:</span>
		<span class="token function">cgLabelStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>GotoStat<span class="token punctuation">:</span>
		<span class="token function">cgGotoStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> stat<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>17.3.1 &#x7B80;&#x5355;&#x8BED;&#x53E5;</h3>
<p><code>local function f() end</code> &#x7B49;&#x4EF7;&#x4E8E; <code>local f; f=function() end</code></p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgLocalFuncDefStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>LocalFuncDefStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">addLocVar</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token function">cgFuncDefExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">func</span> <span class="token function">cgFuncCallStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>FuncCallStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	r <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">cgFuncCallExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">,</span> r<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">freeReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">cgBreakStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>BreakStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pc <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">addBreakJmp</span><span class="token punctuation">(</span>pc<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">cgDoStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>DoStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fi<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
	<span class="token function">cgBlock</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>LastLine<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x751F;&#x6210;&#x8FC7;&#x7A0B;&#x5927;&#x90E8;&#x5206;&#x90FD;&#x662F; addLocVar &#x58F0;&#x660E;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, allocReg &#x7533;&#x8BF7;&#x5BC4;&#x5B58;&#x5668;, enterScope, &#x8FDB;&#x5165;&#x65B0;&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x7B49;.</p>
<p>closeOpenUpvals() &#x8D1F;&#x8D23; Upvalue &#x95ED;&#x5408;, getJmpArgA &#x8D1F;&#x8D23;&#x83B7;&#x53D6;&#x8DF3;&#x8F6C;&#x5730;&#x5740; A.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>line <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">getJmpArgA</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> a <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token function">getJmpArgA</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	hasCapturedLocVars <span class="token operator">:=</span> <span class="token boolean">false</span>
	minSlotOfLocVars <span class="token operator">:=</span> fi<span class="token punctuation">.</span>maxRegs
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> locVar <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>locNames <span class="token punctuation">{</span>
		<span class="token keyword">if</span> locVar<span class="token punctuation">.</span>scopeLv <span class="token operator">==</span> fi<span class="token punctuation">.</span>scopeLv <span class="token punctuation">{</span>
			<span class="token keyword">for</span> v <span class="token operator">:=</span> locVar<span class="token punctuation">;</span> v <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>scopeLv <span class="token operator">==</span> fi<span class="token punctuation">.</span>scopeLv<span class="token punctuation">;</span> v <span class="token operator">=</span> v<span class="token punctuation">.</span>prev <span class="token punctuation">{</span>
				<span class="token keyword">if</span> v<span class="token punctuation">.</span>captured <span class="token punctuation">{</span>
					hasCapturedLocVars <span class="token operator">=</span> <span class="token boolean">true</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">if</span> v<span class="token punctuation">.</span>slot <span class="token operator">&lt;</span> minSlotOfLocVars <span class="token operator">&amp;&amp;</span> v<span class="token punctuation">.</span>name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token string">&apos;(&apos;</span> <span class="token punctuation">{</span>
					minSlotOfLocVars <span class="token operator">=</span> v<span class="token punctuation">.</span>slot
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> hasCapturedLocVars <span class="token punctuation">{</span>
		<span class="token keyword">return</span> minSlotOfLocVars <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3 class="mume-header" id="1732-while-%E5%92%8C-repeat-%E8%AF%AD%E5%8F%A5">17.3.2 while &#x548C; repeat &#x8BED;&#x53E5;.</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
           ______________
          /  false? jmp  |
         /               |
while exp do block end &lt;-&apos;
      ^           \
      |___________/
           jmp
*/</span>
<span class="token keyword">func</span> <span class="token function">cgWhileStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>WhileStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pcBeforeExp <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs
	a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp<span class="token punctuation">,</span> ArgReg<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs

	line <span class="token operator">:=</span> <span class="token function">lastLineOf</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Exp<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitTest</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	pcJmpToEnd <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
	<span class="token function">cgBlock</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>LastLine<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pcBeforeExp<span class="token operator">-</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pcJmpToEnd<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>pcJmpToEnd<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/*
        ______________
       |  false? jmp  |
       V              /
repeat block until exp
*/</span>
<span class="token keyword">func</span> <span class="token function">cgRepeatStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>RepeatStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fi<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

	pcBeforeBlock <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">cgBlock</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>

	oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs
	a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp<span class="token punctuation">,</span> ArgReg<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs

	line <span class="token operator">:=</span> <span class="token function">lastLineOf</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Exp<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitTest</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">getJmpArgA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pcBeforeBlock<span class="token operator">-</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>


</pre><p>&#x8FD9;&#x4E24;&#x4E2A;&#x8BED;&#x53E5;&#x7684;&#x6838;&#x5FC3;&#x5373;&#x83B7;&#x53D6;&#x5F53;&#x524D;&#x5730;&#x5740;, &#x7136;&#x540E;&#x751F;&#x6210;&#x8DF3;&#x8F6C;&#x5730;&#x5740;&#x5B9E;&#x73B0;&#x5FAA;&#x73AF;. &#x7136;&#x540E;&#x5BF9;&#x6761;&#x4EF6;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x6C42;&#x503C;, &#x51B3;&#x5B9A;&#x662F;&#x5426;&#x8DF3;&#x51FA;.</p>
<h3 class="mume-header" id="1733-if-%E8%AF%AD%E5%8F%A5">17.3.3 if &#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">/*
         _________________       _________________       _____________
        / false? jmp      |     / false? jmp      |     / false? jmp  |
       /                  V    /                  V    /              V
if exp1 then block1 elseif exp2 then block2 elseif true then block3 end &lt;-.
                   \                       \                       \      |
                    \_______________________\_______________________\_____|
                    jmp                     jmp                     jmp
*/</span>
<span class="token keyword">func</span> <span class="token function">cgIfStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>IfStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	pcJmpToEnds <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Exps<span class="token punctuation">)</span><span class="token punctuation">)</span>
	pcJmpToNextExp <span class="token operator">:=</span> <span class="token operator">-</span><span class="token number">1</span>

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Exps <span class="token punctuation">{</span>
		<span class="token keyword">if</span> pcJmpToNextExp <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pcJmpToNextExp<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>pcJmpToNextExp<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>

		oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs
		a<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> ArgReg<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs

		line <span class="token operator">:=</span> <span class="token function">lastLineOf</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">emitTest</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		pcJmpToNextExp <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

		block <span class="token operator">:=</span> node<span class="token punctuation">.</span>Blocks<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
		fi<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token function">cgBlock</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> block<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>LastLine<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Exps<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">{</span>
			pcJmpToEnds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>block<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			pcJmpToEnds<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> pcJmpToNextExp
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> pc <span class="token operator">:=</span> <span class="token keyword">range</span> pcJmpToEnds <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pc<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>pc<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x6C42;&#x503C;, &#x6267;&#x884C;&#x4EE3;&#x7801;&#x5757;, &#x6216;&#x6C42;&#x503C;, &#x8DF3;&#x8F6C;&#x7684;&#x8FC7;&#x7A0B;.</p>
<h3 class="mume-header" id="1734-for-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5">17.3.4 for &#x5FAA;&#x73AF;&#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgForNumStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>ForNumStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	forIndexVar <span class="token operator">:=</span> <span class="token string">&quot;(for index)&quot;</span>
	forLimitVar <span class="token operator">:=</span> <span class="token string">&quot;(for limit)&quot;</span>
	forStepVar <span class="token operator">:=</span> <span class="token string">&quot;(for step)&quot;</span>

	fi<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

	<span class="token function">cgLocalVarDeclStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>LocalVarDeclStat<span class="token punctuation">{</span>
		NameList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>forIndexVar<span class="token punctuation">,</span> forLimitVar<span class="token punctuation">,</span> forStepVar<span class="token punctuation">}</span><span class="token punctuation">,</span>
		ExpList<span class="token punctuation">:</span>  <span class="token punctuation">[</span><span class="token punctuation">]</span>Exp<span class="token punctuation">{</span>node<span class="token punctuation">.</span>InitExp<span class="token punctuation">,</span> node<span class="token punctuation">.</span>LimitExp<span class="token punctuation">,</span> node<span class="token punctuation">.</span>StepExp<span class="token punctuation">}</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">addLocVar</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>VarName<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>

	a <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">-</span> <span class="token number">4</span>
	pcForPrep <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">emitForPrep</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LineOfDo<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token function">cgBlock</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>LastLine<span class="token punctuation">)</span>
	pcForLoop <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">emitForLoop</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LineOfFor<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pcForPrep<span class="token punctuation">,</span> pcForLoop<span class="token operator">-</span>pcForPrep<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pcForLoop<span class="token punctuation">,</span> pcForPrep<span class="token operator">-</span>pcForLoop<span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixEndPC</span><span class="token punctuation">(</span>forIndexVar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixEndPC</span><span class="token punctuation">(</span>forLimitVar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixEndPC</span><span class="token punctuation">(</span>forStepVar<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">cgForInStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>ForInStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	forGeneratorVar <span class="token operator">:=</span> <span class="token string">&quot;(for generator)&quot;</span>
	forStateVar <span class="token operator">:=</span> <span class="token string">&quot;(for state)&quot;</span>
	forControlVar <span class="token operator">:=</span> <span class="token string">&quot;(for control)&quot;</span>

	fi<span class="token punctuation">.</span><span class="token function">enterScope</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>

	<span class="token function">cgLocalVarDeclStat</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> <span class="token operator">&amp;</span>LocalVarDeclStat<span class="token punctuation">{</span>
		<span class="token comment">//LastLine: 0,</span>
		NameList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span>forGeneratorVar<span class="token punctuation">,</span> forStateVar<span class="token punctuation">,</span> forControlVar<span class="token punctuation">}</span><span class="token punctuation">,</span>
		ExpList<span class="token punctuation">:</span>  node<span class="token punctuation">.</span>ExpList<span class="token punctuation">,</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>NameList <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">addLocVar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	pcJmpToTFC <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LineOfDo<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token function">cgBlock</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">closeOpenUpvals</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Block<span class="token punctuation">.</span>LastLine<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pcJmpToTFC<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>pcJmpToTFC<span class="token punctuation">)</span>

	line <span class="token operator">:=</span> <span class="token function">lineOf</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ExpList<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
	rGenerator <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">slotOfLocVar</span><span class="token punctuation">(</span>forGeneratorVar<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitTForCall</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> rGenerator<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>NameList<span class="token punctuation">)</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitTForLoop</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> rGenerator<span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">,</span> pcJmpToTFC<span class="token operator">-</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixEndPC</span><span class="token punctuation">(</span>forGeneratorVar<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixEndPC</span><span class="token punctuation">(</span>forStateVar<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">fixEndPC</span><span class="token punctuation">(</span>forControlVar<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>for &#x5FAA;&#x73AF;&#x9700;&#x8981;&#x4E09;&#x4E2A;&#x7279;&#x6B8A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, &#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x7D22;&#x5F15;, &#x9650;&#x5236;, &#x6B65;&#x957F;. &#x7136;&#x540E;&#x6267;&#x884C; block, &#x6700;&#x540E;&#x4FEE;&#x590D;&#x504F;&#x79FB;&#x91CF;.</p>
<h3 class="mume-header" id="1735-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E8%AF%AD%E5%8F%A5">17.3.5 &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgLocalVarDeclStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>LocalVarDeclStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	exps <span class="token operator">:=</span> <span class="token function">removeTailNils</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ExpList<span class="token punctuation">)</span>
	nExps <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>exps<span class="token punctuation">)</span>
	nNames <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>NameList<span class="token punctuation">)</span>

	oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs
	<span class="token keyword">if</span> nExps <span class="token operator">==</span> nNames <span class="token punctuation">{</span>
		<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> exps <span class="token punctuation">{</span>
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> nExps <span class="token operator">&gt;</span> nNames <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> exps <span class="token punctuation">{</span>
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// nNames &gt; nExps</span>
		multRet <span class="token operator">:=</span> <span class="token boolean">false</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> exps <span class="token punctuation">{</span>
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				multRet <span class="token operator">=</span> <span class="token boolean">true</span>
				n <span class="token operator">:=</span> nNames <span class="token operator">-</span> nExps <span class="token operator">+</span> <span class="token number">1</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
				fi<span class="token punctuation">.</span><span class="token function">allocRegs</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>multRet <span class="token punctuation">{</span>
			n <span class="token operator">:=</span> nNames <span class="token operator">-</span> nExps
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocRegs</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
			fi<span class="token punctuation">.</span><span class="token function">emitLoadNil</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs
	startPC <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> name <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>NameList <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">addLocVar</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> startPC<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#x662F;&#x7B49;&#x53F7;&#x5DE6;&#x53F3;&#x76F8;&#x7B49;, &#x5219;&#x5206;&#x914D;&#x4E34;&#x65F6;&#x53D8;&#x91CF;, &#x8FDB;&#x884C;&#x8868;&#x8FBE;&#x5F0F;&#x6C42;&#x503C;, &#x7136;&#x540E;&#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x4E0E;&#x5BC4;&#x5B58;&#x5668;&#x7ED1;&#x5B9A;.<br>
&#x7B2C;&#x4E8C;&#x90E8;&#x5206;&#x662F;&#x8868;&#x8FBE;&#x5F0F;&#x6BD4;&#x540D;&#x79F0;&#x591A;, &#x591A;&#x4F59;&#x7684;&#x4E5F;&#x8FDB;&#x884C;&#x6C42;&#x503C;&#x5373;&#x53EF;.<br>
&#x7B2C;&#x4E09;&#x90E8;&#x5206;&#x662F;&#x8868;&#x8FBE;&#x5F0F;&#x6BD4;&#x53D8;&#x91CF;&#x540D;&#x79F0;&#x5C11;, &#x5219;&#x8981;&#x4E48;&#x591A;&#x6B21;&#x8D4B;&#x503C;, &#x8981;&#x4E48;&#x88C5;&#x5165; nil.</p>
<h3 class="mume-header" id="1736-%E8%B5%8B%E5%80%BC%E8%AF%AD%E5%8F%A5">17.3.6 &#x8D4B;&#x503C;&#x8BED;&#x53E5;</h3>

<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgAssignStat</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>AssignStat<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	exps <span class="token operator">:=</span> <span class="token function">removeTailNils</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ExpList<span class="token punctuation">)</span>
	nExps <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>exps<span class="token punctuation">)</span>
	nVars <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>VarList<span class="token punctuation">)</span>

	tRegs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> nVars<span class="token punctuation">)</span>
	kRegs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> nVars<span class="token punctuation">)</span>
	vRegs <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> nVars<span class="token punctuation">)</span>
	oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs

	<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>VarList <span class="token punctuation">{</span>
		<span class="token keyword">if</span> taExp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>TableAccessExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			tRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> taExp<span class="token punctuation">.</span>PrefixExp<span class="token punctuation">,</span> tRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> taExp<span class="token punctuation">.</span>KeyExp<span class="token punctuation">,</span> kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			name <span class="token operator">:=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>NameExp<span class="token punctuation">)</span><span class="token punctuation">.</span>Name
			<span class="token keyword">if</span> fi<span class="token punctuation">.</span><span class="token function">slotOfLocVar</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> fi<span class="token punctuation">.</span><span class="token function">indexOfUpval</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token comment">// global var</span>
				kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
				<span class="token keyword">if</span> fi<span class="token punctuation">.</span><span class="token function">indexOfConstant</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0xFF</span> <span class="token punctuation">{</span>
					kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> nVars<span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">+</span> i
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> nExps <span class="token operator">&gt;=</span> nVars <span class="token punctuation">{</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> exps <span class="token punctuation">{</span>
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> i <span class="token operator">&gt;=</span> nVars <span class="token operator">&amp;&amp;</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// nVars &gt; nExps</span>
		multRet <span class="token operator">:=</span> <span class="token boolean">false</span>
		<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> exps <span class="token punctuation">{</span>
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>exp<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				multRet <span class="token operator">=</span> <span class="token boolean">true</span>
				n <span class="token operator">:=</span> nVars <span class="token operator">-</span> nExps <span class="token operator">+</span> <span class="token number">1</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
				fi<span class="token punctuation">.</span><span class="token function">allocRegs</span><span class="token punctuation">(</span>n <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>multRet <span class="token punctuation">{</span>
			n <span class="token operator">:=</span> nVars <span class="token operator">-</span> nExps
			a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocRegs</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
			fi<span class="token punctuation">.</span><span class="token function">emitLoadNil</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	lastLine <span class="token operator">:=</span> node<span class="token punctuation">.</span>LastLine
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> exp <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>VarList <span class="token punctuation">{</span>
		<span class="token keyword">if</span> nameExp<span class="token punctuation">,</span> ok <span class="token operator">:=</span> exp<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token operator">*</span>NameExp<span class="token punctuation">)</span><span class="token punctuation">;</span> ok <span class="token punctuation">{</span>
			varName <span class="token operator">:=</span> nameExp<span class="token punctuation">.</span>Name
			<span class="token keyword">if</span> a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">slotOfLocVar</span><span class="token punctuation">(</span>varName<span class="token punctuation">)</span><span class="token punctuation">;</span> a <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				fi<span class="token punctuation">.</span><span class="token function">emitMove</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> b <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">indexOfUpval</span><span class="token punctuation">(</span>varName<span class="token punctuation">)</span><span class="token punctuation">;</span> b <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				fi<span class="token punctuation">.</span><span class="token function">emitSetUpval</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> b<span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">slotOfLocVar</span><span class="token punctuation">(</span><span class="token string">&quot;_ENV&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> a <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					b <span class="token operator">:=</span> <span class="token number">0x100</span> <span class="token operator">+</span> fi<span class="token punctuation">.</span><span class="token function">indexOfConstant</span><span class="token punctuation">(</span>varName<span class="token punctuation">)</span>
					fi<span class="token punctuation">.</span><span class="token function">emitSetTable</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					fi<span class="token punctuation">.</span><span class="token function">emitSetTable</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// global var</span>
				a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">indexOfUpval</span><span class="token punctuation">(</span><span class="token string">&quot;_ENV&quot;</span><span class="token punctuation">)</span>
				<span class="token keyword">if</span> kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					b <span class="token operator">:=</span> <span class="token number">0x100</span> <span class="token operator">+</span> fi<span class="token punctuation">.</span><span class="token function">indexOfConstant</span><span class="token punctuation">(</span>varName<span class="token punctuation">)</span>
					fi<span class="token punctuation">.</span><span class="token function">emitSetTabUp</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					fi<span class="token punctuation">.</span><span class="token function">emitSetTabUp</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			fi<span class="token punctuation">.</span><span class="token function">emitSetTable</span><span class="token punctuation">(</span>lastLine<span class="token punctuation">,</span> tRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> kRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> vRegs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// todo</span>
	fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs
<span class="token punctuation">}</span>

</pre><p>&#x8D4B;&#x503C;&#x8BED;&#x53E5;&#x590D;&#x6742;&#x5728;&#x53EF;&#x4EE5;&#x591A;&#x91CD;&#x8D4B;&#x503C;, &#x7ED9;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, Upvalue, &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x8D4B;&#x503C;, &#x8FD8;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x7D22;&#x5F15;&#x4FEE;&#x6539;&#x8868;.<br>
&#x7B2C;&#x4E00;&#x90E8;&#x5206;&#x9996;&#x5148;&#x5206;&#x914D;&#x4E34;&#x65F6;&#x53D8;&#x91CF;, &#x5BF9;&#x8868;&#x8FBE;&#x5F0F;&#x8FDB;&#x884C;&#x6C42;&#x503C;. tRegs, kRegs, vRegs &#x5206;&#x522B;&#x8868;&#x793A;&#x8868;, &#x952E;, &#x503C;&#x5206;&#x914D;&#x7684;&#x4E34;&#x65F6;&#x53D8;&#x91CF;.</p>
<p><code>for i, exp := range node.VarList</code> &#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x5904;&#x7406;&#x7D22;&#x5F15;&#x8D4B;&#x503C;.<br>
<code>if nExps &gt;= nVars</code> &#x8FD9;&#x91CC;&#x5F00;&#x59CB;&#x662F;&#x591A;&#x91CD;&#x8D4B;&#x503C;.<br>
<code>for i, exp := range node.VarList</code> &#x8FD9;&#x91CC;&#x505A;&#x5177;&#x4F53;&#x7684;&#x8D4B;&#x503C;&#x5904;&#x7406;, &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8D4B;&#x503C;&#x4F7F;&#x7528; MOVE, Upvalue &#x8D4B;&#x503C;&#x4F7F;&#x7528; SETUPVALUE, &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x751F;&#x6210; SETTABUP. &#x6309;&#x7D22;&#x5F15;&#x5219;&#x751F;&#x6210; SETTABLE, &#x6700;&#x540E;&#x8FD8;&#x8981;&#x91CA;&#x653E;&#x4E34;&#x65F6;&#x53D8;&#x91CF;.</p>
<h2>17.4 &#x7F16;&#x8BD1;&#x8868;&#x8FBE;&#x5F0F;</h2>
<p>Lua &#x8868;&#x8FBE;&#x5F0F;&#x53EF;&#x5206;&#x4E3A;&#x5B57;&#x9762;&#x91CF;&#x8868;&#x8FBE;&#x5F0F;, &#x6784;&#x9020;&#x5668;&#x8868;&#x8FBE;&#x5F0F;, &#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;, &#x524D;&#x7F00;&#x8868;&#x8FBE;&#x5F0F;, vararg &#x8868;&#x8FBE;&#x5F0F;.</p>
<p>cgExp &#x8D1F;&#x8D23;&#x8868;&#x8FBE;&#x5F0F;&#x7F16;&#x8BD1;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// todo: rename to evalExp()?</span>
<span class="token keyword">func</span> <span class="token function">cgExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node Exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> exp <span class="token operator">:=</span> node<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token keyword">type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>NilExp<span class="token punctuation">:</span>
		fi<span class="token punctuation">.</span><span class="token function">emitLoadNil</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>FalseExp<span class="token punctuation">:</span>
		fi<span class="token punctuation">.</span><span class="token function">emitLoadBool</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>TrueExp<span class="token punctuation">:</span>
		fi<span class="token punctuation">.</span><span class="token function">emitLoadBool</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>IntegerExp<span class="token punctuation">:</span>
		fi<span class="token punctuation">.</span><span class="token function">emitLoadK</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">indexOfConstant</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Val<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>FloatExp<span class="token punctuation">:</span>
		fi<span class="token punctuation">.</span><span class="token function">emitLoadK</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">indexOfConstant</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Val<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>StringExp<span class="token punctuation">:</span>
		fi<span class="token punctuation">.</span><span class="token function">emitLoadK</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">indexOfConstant</span><span class="token punctuation">(</span>exp<span class="token punctuation">.</span>Str<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ParensExp<span class="token punctuation">:</span>
		<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">.</span>Exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>VarargExp<span class="token punctuation">:</span>
		<span class="token function">cgVarargExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>FuncDefExp<span class="token punctuation">:</span>
		<span class="token function">cgFuncDefExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>TableConstructorExp<span class="token punctuation">:</span>
		<span class="token function">cgTableConstructorExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>UnopExp<span class="token punctuation">:</span>
		<span class="token function">cgUnopExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>BinopExp<span class="token punctuation">:</span>
		<span class="token function">cgBinopExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>ConcatExp<span class="token punctuation">:</span>
		<span class="token function">cgConcatExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>NameExp<span class="token punctuation">:</span>
		<span class="token function">cgNameExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>TableAccessExp<span class="token punctuation">:</span>
		<span class="token function">cgTableAccessExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token keyword">case</span> <span class="token operator">*</span>FuncCallExp<span class="token punctuation">:</span>
		<span class="token function">cgFuncCallExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> exp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x5B57;&#x9762;&#x91CF;&#x5168;&#x90E8;&#x5728;&#x51FD;&#x6570;&#x4E2D;&#x5904;&#x7406;&#x4E86;, &#x6267;&#x884C;&#x76F8;&#x5173;&#x7684; load &#x6307;&#x4EE4;&#x5373;&#x53EF;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgVarargExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>VarargExp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> <span class="token operator">!</span>fi<span class="token punctuation">.</span>isVararg <span class="token punctuation">{</span>
		<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;cannot use &apos;...&apos; outside a vararg function&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fi<span class="token punctuation">.</span><span class="token function">emitVararg</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><h3>17.4.1 &#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// f[a] := function(args) body end</span>
<span class="token keyword">func</span> <span class="token function">cgFuncDefExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>FuncDefExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	subFI <span class="token operator">:=</span> <span class="token function">newFuncInfo</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span>subFuncs <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>subFuncs<span class="token punctuation">,</span> subFI<span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> param <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>ParList <span class="token punctuation">{</span>
		subFI<span class="token punctuation">.</span><span class="token function">addLocVar</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	<span class="token function">cgBlock</span><span class="token punctuation">(</span>subFI<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Block<span class="token punctuation">)</span>
	subFI<span class="token punctuation">.</span><span class="token function">exitScope</span><span class="token punctuation">(</span>subFI<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span>
	subFI<span class="token punctuation">.</span><span class="token function">emitReturn</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

	bx <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>subFuncs<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span>
	fi<span class="token punctuation">.</span><span class="token function">emitClosure</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>LastLine<span class="token punctuation">,</span> a<span class="token punctuation">,</span> bx<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x5373;, &#x751F;&#x6210;&#x65B0;&#x7684; funcInfo, &#x7136;&#x540E;&#x8DDF;&#x4E0A;&#x5C42; funcInfo &#x7ED1;&#x5B9A;, &#x7136;&#x540E;&#x5C06;&#x53C2;&#x6570;&#x8F6C;&#x5316;&#x4E3A;&#x5C40;&#x90E8;&#x53D8;&#x91CF;, &#x7136;&#x540E;&#x8FDB;&#x884C; return, &#x6700;&#x540E;&#x6DFB;&#x52A0; closure.</p>
<h3>17.4.2 &#x8868;&#x6784;&#x9020;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">cgTableConstructorExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>TableConstructorExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	nArr <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> keyExp <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>KeyExps <span class="token punctuation">{</span>
		<span class="token keyword">if</span> keyExp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			nArr<span class="token operator">++</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	nExps <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>KeyExps<span class="token punctuation">)</span>
	multRet <span class="token operator">:=</span> nExps <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span>
		<span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>ValExps<span class="token punctuation">[</span>nExps<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

	fi<span class="token punctuation">.</span><span class="token function">emitNewTable</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> nArr<span class="token punctuation">,</span> nExps<span class="token operator">-</span>nArr<span class="token punctuation">)</span>

	arrIdx <span class="token operator">:=</span> <span class="token number">0</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> keyExp <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>KeyExps <span class="token punctuation">{</span>
		valExp <span class="token operator">:=</span> node<span class="token punctuation">.</span>ValExps<span class="token punctuation">[</span>i<span class="token punctuation">]</span>

		<span class="token keyword">if</span> keyExp <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			arrIdx<span class="token operator">++</span>
			tmp <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
			<span class="token keyword">if</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> multRet <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> valExp<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
				<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> valExp<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">if</span> arrIdx<span class="token operator">%</span><span class="token number">50</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> arrIdx <span class="token operator">==</span> nArr <span class="token punctuation">{</span> <span class="token comment">// LFIELDS_PER_FLUSH</span>
				n <span class="token operator">:=</span> arrIdx <span class="token operator">%</span> <span class="token number">50</span>
				<span class="token keyword">if</span> n <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
					n <span class="token operator">=</span> <span class="token number">50</span>
				<span class="token punctuation">}</span>
				fi<span class="token punctuation">.</span><span class="token function">freeRegs</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span>
				line <span class="token operator">:=</span> <span class="token function">lastLineOf</span><span class="token punctuation">(</span>valExp<span class="token punctuation">)</span>
				c <span class="token operator">:=</span> <span class="token punctuation">(</span>arrIdx<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">50</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token comment">// todo: c &gt; 0xFF</span>
				<span class="token keyword">if</span> i <span class="token operator">==</span> nExps<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> multRet <span class="token punctuation">{</span>
					fi<span class="token punctuation">.</span><span class="token function">emitSetList</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> c<span class="token punctuation">)</span>
				<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
					fi<span class="token punctuation">.</span><span class="token function">emitSetList</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">continue</span>
		<span class="token punctuation">}</span>

		b <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> keyExp<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		c <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> valExp<span class="token punctuation">,</span> c<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">freeRegs</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

		line <span class="token operator">:=</span> <span class="token function">lastLineOf</span><span class="token punctuation">(</span>valExp<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">emitSetTable</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x5148;&#x521D;&#x59CB;&#x5316;, &#x7136;&#x540E; emitNewTable(). &#x63A5;&#x4E0B;&#x6765;&#x5F00;&#x59CB;&#x6784;&#x9020;&#x8868;. &#x6700;&#x540E;&#x505A;&#x5173;&#x8054;&#x5904;&#x7406;&#x5E76; emitSetTable().</p>
<h3>17.4.3 &#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// r[a] := op exp</span>
<span class="token keyword">func</span> <span class="token function">cgUnopExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>UnopExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs
	b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp<span class="token punctuation">,</span> ArgReg<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitUnaryOp</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Op<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs
<span class="token punctuation">}</span>

<span class="token comment">// r[a] = op r[b]</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>cb <span class="token operator">*</span>codeBuf<span class="token punctuation">)</span> <span class="token function">emitUnaryOp</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> op<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_OP_NOT<span class="token punctuation">:</span>
		cb<span class="token punctuation">.</span><span class="token function">emitABC</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> OP_NOT<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_OP_BNOT<span class="token punctuation">:</span>
		cb<span class="token punctuation">.</span><span class="token function">emitABC</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> OP_BNOT<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_OP_LEN<span class="token punctuation">:</span>
		cb<span class="token punctuation">.</span><span class="token function">emitABC</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> OP_LEN<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">case</span> TOKEN_OP_UNM<span class="token punctuation">:</span>
		cb<span class="token punctuation">.</span><span class="token function">emitABC</span><span class="token punctuation">(</span>line<span class="token punctuation">,</span> OP_UNM<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><p>&#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;&#x540C;&#x6837;&#x5148;&#x7533;&#x8BF7;&#x4E34;&#x65F6;&#x53D8;&#x91CF;, &#x5BF9;&#x8868;&#x8FBE;&#x5F0F;&#x6C42;&#x503C;, &#x6700;&#x540E;&#x91CA;&#x653E;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#x5E76;&#x751F;&#x6210;&#x76F8;&#x5E94;&#x7684;&#x4E00;&#x5143;&#x8FD0;&#x7B97;&#x7B26;&#x5373;&#x53EF;.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// r[a] := exp1 .. exp2</span>
<span class="token keyword">func</span> <span class="token function">cgConcatExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>ConcatExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> subExp <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Exps <span class="token punctuation">{</span>
		a <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> subExp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>

	c <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs <span class="token operator">-</span> <span class="token number">1</span>
	b <span class="token operator">:=</span> c <span class="token operator">-</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Exps<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span>
	fi<span class="token punctuation">.</span><span class="token function">freeRegs</span><span class="token punctuation">(</span>c <span class="token operator">-</span> b <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitABC</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> OP_CONCAT<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</pre><p>&#x7531;&#x4E8E;&#x62FC;&#x63A5;&#x8868;&#x8FBE;&#x5F0F;&#x88AB;&#x6211;&#x4EEC;&#x5904;&#x7406;&#x6210;&#x4E86;&#x6811;&#x72B6;&#x7ED3;&#x6784;, &#x56E0;&#x6B64;&#x6BCF;&#x6B21;&#x5FAA;&#x73AF;&#x5148;&#x8FDB;&#x884C;&#x6C42;&#x503C;, &#x7136;&#x540E;&#x6267;&#x884C; emitABC.</p>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// r[a] := exp1 op exp2</span>
<span class="token keyword">func</span> <span class="token function">cgBinopExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>BinopExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">switch</span> node<span class="token punctuation">.</span>Op <span class="token punctuation">{</span>
	<span class="token keyword">case</span> TOKEN_OP_AND<span class="token punctuation">,</span> TOKEN_OP_OR<span class="token punctuation">:</span>
		oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs

		b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp1<span class="token punctuation">,</span> ArgReg<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs
		<span class="token keyword">if</span> node<span class="token punctuation">.</span>Op <span class="token operator">==</span> TOKEN_OP_AND <span class="token punctuation">{</span>
			fi<span class="token punctuation">.</span><span class="token function">emitTestSet</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			fi<span class="token punctuation">.</span><span class="token function">emitTestSet</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		pcOfJmp <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">emitJmp</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>

		b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp2<span class="token punctuation">,</span> ArgReg<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs
		fi<span class="token punctuation">.</span><span class="token function">emitMove</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">fixSbx</span><span class="token punctuation">(</span>pcOfJmp<span class="token punctuation">,</span> fi<span class="token punctuation">.</span><span class="token function">pc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span>pcOfJmp<span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		oldRegs <span class="token operator">:=</span> fi<span class="token punctuation">.</span>usedRegs
		b<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp1<span class="token punctuation">,</span> ArgRK<span class="token punctuation">)</span>
		c<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Exp2<span class="token punctuation">,</span> ArgRK<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">emitBinaryOp</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Op<span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span>usedRegs <span class="token operator">=</span> oldRegs
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</pre><h3>17.4.4 &#x540D;&#x5B57;&#x548C;&#x8868;&#x8BBF;&#x95EE;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// r[a] := name</span>
<span class="token keyword">func</span> <span class="token function">cgNameExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>NameExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">slotOfLocVar</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">emitMove</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> idx <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">indexOfUpval</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span> idx <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">emitGetUpval</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> idx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// x =&gt; _ENV[&apos;x&apos;]</span>
		taExp <span class="token operator">:=</span> <span class="token operator">&amp;</span>TableAccessExp<span class="token punctuation">{</span>
			LastLine<span class="token punctuation">:</span>  node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span>
			PrefixExp<span class="token punctuation">:</span> <span class="token operator">&amp;</span>NameExp<span class="token punctuation">{</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> <span class="token string">&quot;_ENV&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
			KeyExp<span class="token punctuation">:</span>    <span class="token operator">&amp;</span>StringExp<span class="token punctuation">{</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> node<span class="token punctuation">.</span>Name<span class="token punctuation">}</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
		<span class="token function">cgTableAccessExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> taExp<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><p>&#x540C;&#x6837;&#x533A;&#x5206;&#x5C40;&#x90E8;, Upvalue, &#x5168;&#x5C40;&#x53D8;&#x91CF;&#x5904;&#x7406;&#x5373;&#x53EF;.</p>
<h3>17.4.5 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x8868;&#x8FBE;&#x5F0F;</h3>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token comment">// r[a] := f(args)</span>
<span class="token keyword">func</span> <span class="token function">cgFuncCallExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>FuncCallExp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> n <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	nArgs <span class="token operator">:=</span> <span class="token function">prepFuncCall</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitCall</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> nArgs<span class="token punctuation">,</span> n<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// return f(args)</span>
<span class="token keyword">func</span> <span class="token function">cgTailCallExp</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>FuncCallExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	nArgs <span class="token operator">:=</span> <span class="token function">prepFuncCall</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">,</span> a<span class="token punctuation">)</span>
	fi<span class="token punctuation">.</span><span class="token function">emitTailCall</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> nArgs<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">prepFuncCall</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">,</span> node <span class="token operator">*</span>FuncCallExp<span class="token punctuation">,</span> a <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	nArgs <span class="token operator">:=</span> <span class="token function">len</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Args<span class="token punctuation">)</span>
	lastArgIsVarargOrFuncCall <span class="token operator">:=</span> <span class="token boolean">false</span>

	<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>PrefixExp<span class="token punctuation">,</span> a<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> node<span class="token punctuation">.</span>NameExp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		c<span class="token punctuation">,</span> k <span class="token operator">:=</span> <span class="token function">expToOpArg</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> node<span class="token punctuation">.</span>NameExp<span class="token punctuation">,</span> ArgRK<span class="token punctuation">)</span>
		fi<span class="token punctuation">.</span><span class="token function">emitSelf</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>Line<span class="token punctuation">,</span> a<span class="token punctuation">,</span> a<span class="token punctuation">,</span> c<span class="token punctuation">)</span>
		<span class="token keyword">if</span> k <span class="token operator">==</span> ArgReg <span class="token punctuation">{</span>
			fi<span class="token punctuation">.</span><span class="token function">freeRegs</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> arg <span class="token operator">:=</span> <span class="token keyword">range</span> node<span class="token punctuation">.</span>Args <span class="token punctuation">{</span>
		tmp <span class="token operator">:=</span> fi<span class="token punctuation">.</span><span class="token function">allocReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> i <span class="token operator">==</span> nArgs<span class="token operator">-</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isVarargOrFuncCall</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			lastArgIsVarargOrFuncCall <span class="token operator">=</span> <span class="token boolean">true</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			<span class="token function">cgExp</span><span class="token punctuation">(</span>fi<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> tmp<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	fi<span class="token punctuation">.</span><span class="token function">freeRegs</span><span class="token punctuation">(</span>nArgs<span class="token punctuation">)</span>

	<span class="token keyword">if</span> node<span class="token punctuation">.</span>NameExp <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		fi<span class="token punctuation">.</span><span class="token function">freeReg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		nArgs<span class="token operator">++</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> lastArgIsVarargOrFuncCall <span class="token punctuation">{</span>
		nArgs <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> nArgs
<span class="token punctuation">}</span>

</pre><h2>17.5 &#x751F;&#x6210;&#x51FD;&#x6570;&#x539F;&#x578B;</h2>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">toProto</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token operator">*</span>Prototype <span class="token punctuation">{</span>
	proto <span class="token operator">:=</span> <span class="token operator">&amp;</span>Prototype<span class="token punctuation">{</span>
		LineDefined<span class="token punctuation">:</span>     <span class="token function">uint32</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>line<span class="token punctuation">)</span><span class="token punctuation">,</span>
		LastLineDefined<span class="token punctuation">:</span> <span class="token function">uint32</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>lastLine<span class="token punctuation">)</span><span class="token punctuation">,</span>
		NumParams<span class="token punctuation">:</span>       <span class="token function">byte</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>numParams<span class="token punctuation">)</span><span class="token punctuation">,</span>
		MaxStackSize<span class="token punctuation">:</span>    <span class="token function">byte</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>maxRegs<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Code<span class="token punctuation">:</span>            fi<span class="token punctuation">.</span>insts<span class="token punctuation">,</span>
		Constants<span class="token punctuation">:</span>       <span class="token function">getConstants</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Upvalues<span class="token punctuation">:</span>        <span class="token function">getUpvalues</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">,</span>
		Protos<span class="token punctuation">:</span>          <span class="token function">toProtos</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>subFuncs<span class="token punctuation">)</span><span class="token punctuation">,</span>
		LineInfo<span class="token punctuation">:</span>        fi<span class="token punctuation">.</span>lineNums<span class="token punctuation">,</span>
		LocVars<span class="token punctuation">:</span>         <span class="token function">getLocVars</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">,</span>
		UpvalueNames<span class="token punctuation">:</span>    <span class="token function">getUpvalueNames</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span><span class="token punctuation">,</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> fi<span class="token punctuation">.</span>line <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		proto<span class="token punctuation">.</span>LastLineDefined <span class="token operator">=</span> <span class="token number">0</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> proto<span class="token punctuation">.</span>MaxStackSize <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token punctuation">{</span>
		proto<span class="token punctuation">.</span>MaxStackSize <span class="token operator">=</span> <span class="token number">2</span> <span class="token comment">// todo</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> fi<span class="token punctuation">.</span>isVararg <span class="token punctuation">{</span>
		proto<span class="token punctuation">.</span>IsVararg <span class="token operator">=</span> <span class="token number">1</span> <span class="token comment">// todo</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> proto
<span class="token punctuation">}</span>


<span class="token keyword">func</span> <span class="token function">toProtos</span><span class="token punctuation">(</span>fis <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Prototype <span class="token punctuation">{</span>
	protos <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>Prototype<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fis<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> fi <span class="token operator">:=</span> <span class="token keyword">range</span> fis <span class="token punctuation">{</span>
		protos<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">toProto</span><span class="token punctuation">(</span>fi<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> protos
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getConstants</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
	consts <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token keyword">interface</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>constants<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> k<span class="token punctuation">,</span> idx <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>constants <span class="token punctuation">{</span>
		consts<span class="token punctuation">[</span>idx<span class="token punctuation">]</span> <span class="token operator">=</span> k
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> consts
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getLocVars</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>LocVar <span class="token punctuation">{</span>
	locVars <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>LocVar<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>locVars<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i<span class="token punctuation">,</span> locVar <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>locVars <span class="token punctuation">{</span>
		locVars<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> LocVar<span class="token punctuation">{</span>
			VarName<span class="token punctuation">:</span> locVar<span class="token punctuation">.</span>name<span class="token punctuation">,</span>
			StartPC<span class="token punctuation">:</span> <span class="token function">uint32</span><span class="token punctuation">(</span>locVar<span class="token punctuation">.</span>startPC<span class="token punctuation">)</span><span class="token punctuation">,</span>
			EndPC<span class="token punctuation">:</span>   <span class="token function">uint32</span><span class="token punctuation">(</span>locVar<span class="token punctuation">.</span>endPC<span class="token punctuation">)</span><span class="token punctuation">,</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> locVars
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getUpvalues</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>Upvalue <span class="token punctuation">{</span>
	upvals <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span>Upvalue<span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> uv <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>upvalues <span class="token punctuation">{</span>
		<span class="token keyword">if</span> uv<span class="token punctuation">.</span>locVarSlot <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// instack</span>
			upvals<span class="token punctuation">[</span>uv<span class="token punctuation">.</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> Upvalue<span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token function">byte</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>locVarSlot<span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			upvals<span class="token punctuation">[</span>uv<span class="token punctuation">.</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> Upvalue<span class="token punctuation">{</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">byte</span><span class="token punctuation">(</span>uv<span class="token punctuation">.</span>upvalIndex<span class="token punctuation">)</span><span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> upvals
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">getUpvalueNames</span><span class="token punctuation">(</span>fi <span class="token operator">*</span>funcInfo<span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span> <span class="token punctuation">{</span>
	names <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token function">len</span><span class="token punctuation">(</span>fi<span class="token punctuation">.</span>upvalues<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> name<span class="token punctuation">,</span> uv <span class="token operator">:=</span> <span class="token keyword">range</span> fi<span class="token punctuation">.</span>upvalues <span class="token punctuation">{</span>
		names<span class="token punctuation">[</span>uv<span class="token punctuation">.</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> name
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> names
<span class="token punctuation">}</span>

</pre><h2>17.6 &#x4F7F;&#x7528;&#x7F16;&#x8BD1;&#x5668;</h2>
<pre data-role="codeBlock" data-info="go" class="language-go"><span class="token keyword">func</span> <span class="token function">Compile</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> chunkName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">*</span>binchunk<span class="token punctuation">.</span>Prototype <span class="token punctuation">{</span>
	ast <span class="token operator">:=</span> parser<span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> chunkName<span class="token punctuation">)</span>
	proto <span class="token operator">:=</span> codegen<span class="token punctuation">.</span><span class="token function">GenProto</span><span class="token punctuation">(</span>ast<span class="token punctuation">)</span>
	<span class="token function">setSource</span><span class="token punctuation">(</span>proto<span class="token punctuation">,</span> chunkName<span class="token punctuation">)</span>
	<span class="token keyword">return</span> proto
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">setSource</span><span class="token punctuation">(</span>proto <span class="token operator">*</span>binchunk<span class="token punctuation">.</span>Prototype<span class="token punctuation">,</span> chunkName <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	proto<span class="token punctuation">.</span>Source <span class="token operator">=</span> chunkName
	<span class="token keyword">for</span> <span class="token boolean">_</span><span class="token punctuation">,</span> f <span class="token operator">:=</span> <span class="token keyword">range</span> proto<span class="token punctuation">.</span>Protos <span class="token punctuation">{</span>
		<span class="token function">setSource</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> chunkName<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</pre><h2>17.7 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</h2>
<h2>17.8 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</h2>

      </div>
      <div class="md-sidebar-toc"><ul>
<li><a href="#chapter-1-%E5%87%86%E5%A4%87%E5%B7%A5%E4%BD%9C">Chapter 1, &#x51C6;&#x5907;&#x5DE5;&#x4F5C;</a></li>
<li><a href="#chapter-2-%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">Chapter 2, &#x4E8C;&#x8FDB;&#x5236; Chunk</a>
<ul>
<li><a href="#21-%E4%BB%80%E4%B9%88%E6%98%AF%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">2.1 &#x4EC0;&#x4E48;&#x662F;&#x4E8C;&#x8FDB;&#x5236; Chunk</a></li>
<li><a href="#22-luac-%E5%91%BD%E4%BB%A4%E4%BB%8B%E7%BB%8D">2.2 luac &#x547D;&#x4EE4;&#x4ECB;&#x7ECD;</a>
<ul>
<li><a href="#221-%E7%BC%96%E8%AF%91-lua-%E6%BA%90%E6%96%87%E4%BB%B6">2.2.1 &#x7F16;&#x8BD1; Lua &#x6E90;&#x6587;&#x4EF6;</a></li>
<li><a href="#222-%E6%9F%A5%E7%9C%8B%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">2.2.2 &#x67E5;&#x770B;&#x4E8C;&#x8FDB;&#x5236; chunk</a></li>
</ul>
</li>
<li><a href="#23-%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk-%E6%A0%BC%E5%BC%8F">2.3 &#x4E8C;&#x8FDB;&#x5236; chunk &#x683C;&#x5F0F;</a>
<ul>
<li><a href="#231-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">2.3.1 &#x6570;&#x636E;&#x7C7B;&#x578B;</a>
<ul>
<li><a href="#1-%E6%95%B0%E5%AD%97">1. &#x6570;&#x5B57;</a></li>
<li><a href="#2-%E5%AD%97%E7%AC%A6%E4%B8%B2">2. &#x5B57;&#x7B26;&#x4E32;</a></li>
<li><a href="#3-%E5%88%97%E8%A1%A8">3. &#x5217;&#x8868;</a></li>
</ul>
</li>
<li><a href="#232-%E6%80%BB%E4%BD%93%E7%BB%93%E6%9E%84">2.3.2 &#x603B;&#x4F53;&#x7ED3;&#x6784;</a></li>
<li><a href="#233-%E5%A4%B4%E9%83%A8">2.3.3 &#x5934;&#x90E8;</a>
<ul>
<li><a href="#1-%E7%AD%BE%E5%90%8D">1. &#x7B7E;&#x540D;</a></li>
<li><a href="#2-%E7%89%88%E6%9C%AC%E5%8F%B7">2. &#x7248;&#x672C;&#x53F7;</a></li>
<li><a href="#3-%E6%A0%BC%E5%BC%8F%E5%8F%B7">3. &#x683C;&#x5F0F;&#x53F7;</a></li>
<li><a href="#4-luac_data">4. LUAC_DATA</a></li>
<li><a href="#5-%E6%95%B4%E6%95%B0%E5%92%8C-lua-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4%E5%AE%BD%E5%BA%A6">5. &#x6574;&#x6570;&#x548C; Lua &#x865A;&#x62DF;&#x673A;&#x6307;&#x4EE4;&#x5BBD;&#x5EA6;</a></li>
<li><a href="#6-luac_int">6. LUAC_INT</a></li>
<li><a href="#7-luac_num">7. LUAC_NUM</a></li>
</ul>
</li>
<li><a href="#234-%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B">2.3.4 &#x51FD;&#x6570;&#x539F;&#x578B;</a>
<ul>
<li><a href="#1-%E6%BA%90%E6%96%87%E4%BB%B6%E5%90%8D">1. &#x6E90;&#x6587;&#x4EF6;&#x540D;</a></li>
<li><a href="#2-%E8%B5%B7%E6%AD%A2%E8%A1%8C%E5%8F%B7">2. &#x8D77;&#x6B62;&#x884C;&#x53F7;</a></li>
<li><a href="#3-%E5%9B%BA%E5%AE%9A%E5%8F%82%E6%95%B0%E4%B8%AA%E6%95%B0">3. &#x56FA;&#x5B9A;&#x53C2;&#x6570;&#x4E2A;&#x6570;</a></li>
<li><a href="#4-%E6%98%AF%E5%90%A6%E6%98%AF-vararg-%E5%87%BD%E6%95%B0">4. &#x662F;&#x5426;&#x662F; Vararg &#x51FD;&#x6570;</a></li>
<li><a href="#5-%E5%AF%84%E5%AD%98%E5%99%A8%E6%95%B0%E9%87%8F">5. &#x5BC4;&#x5B58;&#x5668;&#x6570;&#x91CF;</a></li>
<li><a href="#6-%E6%8C%87%E4%BB%A4%E8%A1%A8">6. &#x6307;&#x4EE4;&#x8868;</a></li>
<li><a href="#7-%E5%B8%B8%E9%87%8F%E8%A1%A8">7. &#x5E38;&#x91CF;&#x8868;</a></li>
<li><a href="#8-upvalue-%E8%A1%A8">8. Upvalue &#x8868;</a></li>
<li><a href="#9-%E5%AD%90%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B%E8%A1%A8">9. &#x5B50;&#x51FD;&#x6570;&#x539F;&#x578B;&#x8868;</a></li>
<li><a href="#10-%E8%A1%8C%E5%8F%B7%E8%A1%A8">10. &#x884C;&#x53F7;&#x8868;</a></li>
<li><a href="#11-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E8%A1%A8">11. &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x8868;</a></li>
<li><a href="#12-upvalue-%E5%90%8D%E5%88%97%E8%A1%A8">12. Upvalue &#x540D;&#x5217;&#x8868;</a></li>
<li><a href="#13-undump-%E5%87%BD%E6%95%B0">13. Undump() &#x51FD;&#x6570;</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#24-%E8%A7%A3%E6%9E%90%E4%BA%8C%E8%BF%9B%E5%88%B6-chunk">2.4 &#x89E3;&#x6790;&#x4E8C;&#x8FDB;&#x5236; chunk</a>
<ul>
<li><a href="#241-%E8%AF%BB%E5%8F%96%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">2.4.1 &#x8BFB;&#x53D6;&#x57FA;&#x672C;&#x6570;&#x636E;&#x7C7B;&#x578B;</a></li>
<li><a href="#242-%E6%A3%80%E6%9F%A5%E5%A4%B4%E9%83%A8">2.4.2 &#x68C0;&#x67E5;&#x5934;&#x90E8;</a></li>
<li><a href="#243-%E8%AF%BB%E5%8F%96%E5%87%BD%E6%95%B0%E5%8E%9F%E5%9E%8B">2.4.3 &#x8BFB;&#x53D6;&#x51FD;&#x6570;&#x539F;&#x578B;</a></li>
</ul>
</li>
<li><a href="#25-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">2.5 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</a></li>
</ul>
</li>
<li><a href="#chapter-3-%E6%8C%87%E4%BB%A4%E9%9B%86">Chapter 3, &#x6307;&#x4EE4;&#x96C6;</a>
<ul>
<li><a href="#31-%E6%8C%87%E4%BB%A4%E9%9B%86%E4%BB%8B%E7%BB%8D">3.1 &#x6307;&#x4EE4;&#x96C6;&#x4ECB;&#x7ECD;</a></li>
<li><a href="#32-%E6%8C%87%E4%BB%A4%E7%BC%96%E7%A0%81%E6%A0%BC%E5%BC%8F">3.2 &#x6307;&#x4EE4;&#x7F16;&#x7801;&#x683C;&#x5F0F;</a>
<ul>
<li><a href="#321-%E7%BC%96%E7%A0%81%E6%A8%A1%E5%BC%8F">3.2.1 &#x7F16;&#x7801;&#x6A21;&#x5F0F;</a></li>
<li><a href="#322-%E6%93%8D%E4%BD%9C%E7%A0%81">3.2.2 &#x64CD;&#x4F5C;&#x7801;</a></li>
<li><a href="#323-%E6%93%8D%E4%BD%9C%E6%95%B0">3.2.3 &#x64CD;&#x4F5C;&#x6570;</a></li>
<li><a href="#324-%E6%8C%87%E4%BB%A4%E8%A1%A8">3.2.4 &#x6307;&#x4EE4;&#x8868;</a></li>
</ul>
</li>
<li><a href="#33-%E6%8C%87%E4%BB%A4%E8%A7%A3%E7%A0%81">3.3 &#x6307;&#x4EE4;&#x89E3;&#x7801;</a></li>
<li><a href="#34-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">3.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</a></li>
</ul>
</li>
<li><a href="#chapter-4-lua-api">Chapter 4, Lua API</a>
<ul>
<li><a href="#41-lua-api-%E4%BB%8B%E7%BB%8D">4.1 Lua API &#x4ECB;&#x7ECD;</a></li>
<li><a href="#41-lua-%E6%A0%88">4.1 Lua &#x6808;</a>
<ul>
<li><a href="#421-lua-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E5%92%8C%E5%80%BC">4.2.1 Lua &#x6570;&#x636E;&#x7C7B;&#x578B;&#x548C;&#x503C;</a></li>
<li><a href="#422-%E6%A0%88%E7%B4%A2%E5%BC%95">4.2.2 &#x6808;&#x7D22;&#x5F15;</a></li>
<li><a href="#423-%E5%AE%9A%E4%B9%89-luastack-%E7%BB%93%E6%9E%84%E4%BD%93">4.2.3 &#x5B9A;&#x4E49; luaStack &#x7ED3;&#x6784;&#x4F53;</a></li>
</ul>
</li>
<li><a href="#43-lua-state">4.3 Lua State</a>
<ul>
<li><a href="#431-%E5%AE%9A%E4%B9%89-luastate-%E6%8E%A5%E5%8F%A3">4.3.1 &#x5B9A;&#x4E49; LuaState &#x63A5;&#x53E3;</a></li>
<li><a href="#432-%E5%AE%9A%E4%B9%89-luastate-%E7%BB%93%E6%9E%84%E4%BD%93">4.3.2 &#x5B9A;&#x4E49; luaState &#x7ED3;&#x6784;&#x4F53;</a></li>
<li><a href="#433-%E5%9F%BA%E7%A1%80%E6%A0%88%E6%93%8D%E4%BD%9C%E6%96%B9%E6%B3%95">4.3.3 &#x57FA;&#x7840;&#x6808;&#x64CD;&#x4F5C;&#x65B9;&#x6CD5;</a></li>
<li><a href="#434-push-%E6%96%B9%E6%B3%95">4.3.4 Push &#x65B9;&#x6CD5;</a></li>
<li><a href="#435-access-%E6%96%B9%E6%B3%95">4.3.5 Access &#x65B9;&#x6CD5;</a></li>
</ul>
</li>
<li><a href="#44-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">4.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</a></li>
<li><a href="#45-%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93">4.5 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#chapter-5-lua-%E8%BF%90%E7%AE%97%E7%AC%A6">Chapter 5, Lua &#x8FD0;&#x7B97;&#x7B26;</a>
<ul>
<li><a href="#51-lua-%E8%BF%90%E7%AE%97%E7%AC%A6%E4%BB%8B%E7%BB%8D">5.1 Lua &#x8FD0;&#x7B97;&#x7B26;&#x4ECB;&#x7ECD;</a>
<ul>
<li><a href="#1-%E7%AE%97%E6%95%B0%E8%BF%90%E7%AE%97%E7%AC%A6">1. &#x7B97;&#x6570;&#x8FD0;&#x7B97;&#x7B26;</a></li>
<li><a href="#2-%E6%8C%89%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6">2. &#x6309;&#x4F4D;&#x8FD0;&#x7B97;&#x7B26;</a></li>
<li><a href="#3-%E6%AF%94%E8%BE%83%E8%BF%90%E7%AE%97%E7%AC%A6">3. &#x6BD4;&#x8F83;&#x8FD0;&#x7B97;&#x7B26;</a></li>
<li><a href="#4-%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6">4. &#x903B;&#x8F91;&#x8FD0;&#x7B97;&#x7B26;</a></li>
<li><a href="#5-%E9%95%BF%E5%BA%A6%E8%BF%90%E7%AE%97%E7%AC%A6">5. &#x957F;&#x5EA6;&#x8FD0;&#x7B97;&#x7B26;</a></li>
<li><a href="#6-%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%8B%BC%E6%8E%A5%E8%BF%90%E7%AE%97%E7%AC%A6">6. &#x5B57;&#x7B26;&#x4E32;&#x62FC;&#x63A5;&#x8FD0;&#x7B97;&#x7B26;</a></li>
</ul>
</li>
<li><a href="#52-%E7%B1%BB%E5%9E%8B%E8%87%AA%E5%8A%A8%E8%BD%AC%E6%8D%A2">5.2 &#x7C7B;&#x578B;&#x81EA;&#x52A8;&#x8F6C;&#x6362;</a>
<ul>
<li><a href="#1-%E8%BD%AC%E6%8D%A2%E8%A7%84%E5%88%99">1. &#x8F6C;&#x6362;&#x89C4;&#x5219;</a></li>
<li><a href="#2-%E6%B5%AE%E7%82%B9%E6%95%B0%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E6%95%B0">2. &#x6D6E;&#x70B9;&#x6570;&#x8F6C;&#x6362;&#x4E3A;&#x6574;&#x6570;</a></li>
<li><a href="#3-%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%A7%A3%E6%9E%90%E4%B8%BA%E6%95%B0%E5%AD%97">3. &#x5B57;&#x7B26;&#x4E32;&#x89E3;&#x6790;&#x4E3A;&#x6570;&#x5B57;</a></li>
<li><a href="#4-%E4%BB%BB%E6%84%8F%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%B5%AE%E7%82%B9%E6%95%B0">4. &#x4EFB;&#x610F;&#x503C;&#x8F6C;&#x6362;&#x4E3A;&#x6D6E;&#x70B9;&#x6570;</a></li>
<li><a href="#5-%E4%BB%BB%E6%84%8F%E5%80%BC%E8%BD%AC%E6%8D%A2%E4%B8%BA%E6%95%B4%E6%95%B0">5. &#x4EFB;&#x610F;&#x503C;&#x8F6C;&#x6362;&#x4E3A;&#x6574;&#x6570;</a></li>
</ul>
</li>
<li><a href="#53-%E6%89%A9%E5%B1%95-luastate-%E6%8E%A5%E5%8F%A3">5.3 &#x6269;&#x5C55; LuaState &#x63A5;&#x53E3;</a>
<ul>
<li><a href="#531-arith-%E6%96%B9%E6%B3%95">5.3.1 Arith &#x65B9;&#x6CD5;</a></li>
<li><a href="#532-compare-%E6%96%B9%E6%B3%95">5.3.2 Compare() &#x65B9;&#x6CD5;</a></li>
<li><a href="#533-len-%E6%96%B9%E6%B3%95">5.3.3 Len() &#x65B9;&#x6CD5;</a></li>
<li><a href="#534-concat-%E6%96%B9%E6%B3%95">5.3.4 Concat() &#x65B9;&#x6CD5;</a></li>
</ul>
</li>
<li><a href="#54-%E6%B5%8B%E8%AF%95%E6%9C%AC%E7%AB%A0%E4%BB%A3%E7%A0%81">5.4 &#x6D4B;&#x8BD5;&#x672C;&#x7AE0;&#x4EE3;&#x7801;</a></li>
</ul>
</li>
<li><a href="#chapter-6-%E8%99%9A%E6%8B%9F%E6%9C%BA%E9%9B%8F%E5%BD%A2">Chapter 6, &#x865A;&#x62DF;&#x673A;&#x96CF;&#x5F62;</a>
<ul>
<li><a href="#61-%E6%B7%BB%E5%8A%A0-luavm-%E6%8E%A5%E5%8F%A3">6.1 &#x6DFB;&#x52A0; LuaVM &#x63A5;&#x53E3;</a>
<ul>
<li><a href="#611-%E5%AE%9A%E4%B9%89-luavm-%E6%8E%A5%E5%8F%A3">6.1.1 &#x5B9A;&#x4E49; LuaVM &#x63A5;&#x53E3;</a></li>
<li><a href="#612-%E6%94%B9%E9%80%A0-luastate-%E7%BB%93%E6%9E%84%E4%BD%93">6.1.2 &#x6539;&#x9020; luaState &#x7ED3;&#x6784;&#x4F53;</a></li>
<li><a href="#613-%E5%AE%9E%E7%8E%B0-luavm-%E6%8E%A5%E5%8F%A3">6.1.3 &#x5B9E;&#x73B0; LuaVM &#x63A5;&#x53E3;</a></li>
</ul>
</li>
<li><a href="#62-%E5%AE%9E%E7%8E%B0-lua-%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%8C%87%E4%BB%A4">6.2 &#x5B9E;&#x73B0; Lua &#x865A;&#x62DF;&#x673A;&#x6307;&#x4EE4;</a>
<ul>
<li><a href="#621-%E7%A7%BB%E5%8A%A8%E5%92%8C%E8%B7%B3%E8%BD%AC%E6%8C%87%E4%BB%A4">6.2.1 &#x79FB;&#x52A8;&#x548C;&#x8DF3;&#x8F6C;&#x6307;&#x4EE4;</a>
<ul>
<li><a href="#1-move">1. MOVE</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#154-%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4 &#x8868;&#x8FBE;&#x5F0F;</a>
<ul>
<li><a href="#1541-%E7%AE%80%E5%8D%95%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.1 &#x7B80;&#x5355;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1542-%E8%BF%90%E7%AE%97%E7%AC%A6%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.2 &#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1543-%E8%A1%A8%E6%9E%84%E9%80%A0%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.3 &#x8868;&#x6784;&#x9020;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1544-%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.4 &#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1545-%E5%89%8D%E7%BC%80%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.5 &#x524D;&#x7F00;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1546-%E5%9C%86%E6%8B%AC%E5%8F%B7%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.6 &#x5706;&#x62EC;&#x53F7;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1547-%E8%A1%A8%E8%AE%BF%E9%97%AE%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.7 &#x8868;&#x8BBF;&#x95EE;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1548-%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F">15.4.8 &#x51FD;&#x6570;&#x8C03;&#x7528;&#x8868;&#x8FBE;&#x5F0F;</a></li>
</ul>
</li>
<li><a href="#155-%E6%9C%AC%E7%AB%A0%E5%B0%8F%E7%BB%93">15.5 &#x672C;&#x7AE0;&#x5C0F;&#x7ED3;</a></li>
</ul>
</li>
<li><a href="#chapter-16-%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90">Chapter 16, &#x8BED;&#x6CD5;&#x5206;&#x6790;</a>
<ul>
<li><a href="#161-%E8%AF%AD%E6%B3%95%E5%88%86%E6%9E%90%E4%BB%8B%E7%BB%8D">16.1 &#x8BED;&#x6CD5;&#x5206;&#x6790;&#x4ECB;&#x7ECD;</a>
<ul>
<li><a href="#1611-%E6%AD%A7%E4%B9%89">16.1.1 &#x6B67;&#x4E49;</a></li>
<li><a href="#1612-%E5%89%8D%E7%9E%BB%E5%92%8C%E5%9B%9E%E6%BA%AF">16.1.2 &#x524D;&#x77BB;&#x548C;&#x56DE;&#x6EAF;</a></li>
<li><a href="#1613-%E8%A7%A3%E6%9E%90%E6%96%B9%E5%BC%8F">16.1.3 &#x89E3;&#x6790;&#x65B9;&#x5F0F;</a></li>
<li><a href="#162-%E8%A7%A3%E6%9E%90%E5%9D%97">16.2 &#x89E3;&#x6790;&#x5757;</a></li>
</ul>
</li>
<li><a href="#163-%E8%A7%A3%E6%9E%90%E8%AF%AD%E5%8F%A5">16.3 &#x89E3;&#x6790;&#x8BED;&#x53E5;</a>
<ul>
<li><a href="#1631-%E7%AE%80%E5%8D%95%E8%AF%AD%E5%8F%A5">16.3.1 &#x7B80;&#x5355;&#x8BED;&#x53E5;</a></li>
<li><a href="#1632-if-%E8%AF%AD%E5%8F%A5">16.3.2 if &#x8BED;&#x53E5;</a></li>
<li><a href="#1633-for-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5">16.3.3 for &#x5FAA;&#x73AF;&#x8BED;&#x53E5;</a></li>
<li><a href="#1634-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E5%92%8C%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E8%AF%AD%E5%8F%A5">16.3.4 &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x548C;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;</a></li>
<li><a href="#1635-%E8%B5%8B%E5%80%BC%E5%92%8C%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8%E8%AF%AD%E5%8F%A5">16.3.5 &#x8D4B;&#x503C;&#x548C;&#x51FD;&#x6570;&#x8C03;&#x7528;&#x8BED;&#x53E5;</a></li>
<li><a href="#1636-%E9%9D%9E%E5%B1%80%E9%83%A8%E5%87%BD%E6%95%B0%E5%AE%9A%E4%B9%89%E8%AF%AD%E5%8F%A5">16.3.6 &#x975E;&#x5C40;&#x90E8;&#x51FD;&#x6570;&#x5B9A;&#x4E49;&#x8BED;&#x53E5;</a></li>
<li><a href="#164-%E8%A7%A3%E6%9E%90%E8%A1%A8%E8%BE%BE%E5%BC%8F">16.4 &#x89E3;&#x6790;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1641-%E8%BF%90%E7%AE%97%E7%AC%A6%E8%A1%A8%E8%BE%BE%E5%BC%8F">16.4.1 &#x8FD0;&#x7B97;&#x7B26;&#x8868;&#x8FBE;&#x5F0F;</a></li>
<li><a href="#1732-while-%E5%92%8C-repeat-%E8%AF%AD%E5%8F%A5">17.3.2 while &#x548C; repeat &#x8BED;&#x53E5;.</a></li>
<li><a href="#1733-if-%E8%AF%AD%E5%8F%A5">17.3.3 if &#x8BED;&#x53E5;</a></li>
<li><a href="#1734-for-%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5">17.3.4 for &#x5FAA;&#x73AF;&#x8BED;&#x53E5;</a></li>
<li><a href="#1735-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F%E5%A3%B0%E6%98%8E%E8%AF%AD%E5%8F%A5">17.3.5 &#x5C40;&#x90E8;&#x53D8;&#x91CF;&#x58F0;&#x660E;&#x8BED;&#x53E5;</a></li>
<li><a href="#1736-%E8%B5%8B%E5%80%BC%E8%AF%AD%E5%8F%A5">17.3.6 &#x8D4B;&#x503C;&#x8BED;&#x53E5;</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
      <a id="sidebar-toc-btn">&#x2261;</a>
    
    
    
    
    
    
    
    
<script>

var sidebarTOCBtn = document.getElementById('sidebar-toc-btn')
sidebarTOCBtn.addEventListener('click', function(event) {
  event.stopPropagation()
  if (document.body.hasAttribute('html-show-sidebar-toc')) {
    document.body.removeAttribute('html-show-sidebar-toc')
  } else {
    document.body.setAttribute('html-show-sidebar-toc', true)
  }
})
</script>
      
  
    </body></html>